<!DOCTYPE html>

<html lang="en">
<head>
<script>
  // âš ï¸ CRITICAL EARLY DIAGNOSTIC - Runs BEFORE everything else
  (function() {
    console.log('%cğŸ”´ EARLY DIAGNOSTIC START', 'color: red; font-size: 16px; font-weight: bold;');
    console.log('ğŸ”´ URL:', window.location.href);
    console.log('ğŸ”´ Hash:', window.location.hash);
    console.log('ğŸ”´ Document ready state:', document.readyState);
    console.log('ğŸ”´ Timestamp:', new Date().toISOString());
    
    // Track DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ”´ DOM Content Loaded');
      });
    } else {
      console.log('ğŸ”´ DOM already loaded');
    }
    
    // Track page load
    window.addEventListener('load', function() {
      console.log('ğŸ”´ Window Load event fired');
    });
    
    // Track errors
    window.addEventListener('error', function(e) {
      console.error('ğŸ”´ WINDOW ERROR:', e.message, 'at', e.filename + ':' + e.lineno);
    });
    
    // Track promise rejections
    window.addEventListener('unhandledrejection', function(e) {
      console.error('ğŸ”´ UNHANDLED PROMISE:', e.reason);
    });
    
    console.log('ğŸ”´ Early diagnostic complete - scripts should load next');
  })();
</script>
<meta charset="utf-8"/>
<title>Savings Dashboard â€” Bootstrap Edition</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<!-- Bootstrap 5.3 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<!-- QR Code Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<style>
    :root {
      --bg-light: #ffffff;
      --bg-dark: #0f172a;
      --panel-light: #f8f9fa;
      --panel-dark: #111827;
      --text-light: #212529;
      --text-dark: #ffffff;
      --muted-light: #6c757d;
      --muted-dark: #a6b0c0;
      --ok: #10b981; --warn: #f59e0b; --brand: #59a2ff; --brand2:#8a7dff;
    }
    
    [data-bs-theme="light"] {
      --bg: var(--bg-light);
      --panel: var(--panel-light);
      --text: var(--text-light);
      --muted: var(--muted-light);
    }
    
    [data-bs-theme="dark"] {
      --bg: var(--bg-dark);
      --panel: var(--panel-dark);
      --text: var(--text-dark);
      --muted: var(--muted-dark);
    }
    body {
      background:
        radial-gradient(1000px 600px at 120% -10%, rgba(89,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at -10% -10%, rgba(138,125,255,.18), transparent 60%),
        var(--bg);
      color: var(--text);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    [data-bs-theme="light"] .card {
      background: var(--panel);
      border: 1px solid #dee2e6;
      box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
    }
    
    [data-bs-theme="dark"] .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), #0b1220;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
    }
    [data-bs-theme="light"] .chip {
      display:inline-flex; gap:.5rem; align-items:center;
      padding:.35rem .6rem; border-radius:999px; background:#e9ecef; border:1px solid #dee2e6;
      color:#495057;
      font-size:.85rem;
    }
    
    [data-bs-theme="dark"] .chip {
      display:inline-flex; gap:.5rem; align-items:center;
      padding:.35rem .6rem; border-radius:999px; background:#1b2232; border:1px solid rgba(255,255,255,.09);
      color:#bcd;
      font-size:.85rem;
    }
    .bar { height:10px; background:#101827; border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden; }
    .bar > div { height:100%; background: linear-gradient(90deg, var(--ok), var(--brand)); }
    .muted { color: var(--muted); }
    .kpi .value { font-weight:800; font-size:1.2rem; }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,.08); }
    .table thead th { color:#9fb2d7; }
    .nav-pills .nav-link.active { background: linear-gradient(90deg, var(--brand2), var(--brand)); }
    @media print {
      .no-print, header, .nav, .navbar { display:none !important; }
      body { background:#fff; color:#000; }
      .card { background:#fff !important; border:1px solid #ddd !important; box-shadow:none !important; }
    }
    
    /* Sync notification banner */
    .sync-banner {
      background: linear-gradient(90deg, var(--brand2), var(--brand));
      color: white;
      padding: 0.5rem 1rem;
      display: none;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
    }
    .sync-banner .sync-actions { display: flex; gap: 0.5rem; align-items: center; }
    .sync-banner .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
    
    /* Modern Rate Scenarios Design */
    .scenario-card {
      transition: all 0.2s ease;
      border-radius: 12px;
    }
    .scenario-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,.15);
    }
    .scenario-card.border-primary {
      border-width: 2px;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    .metric-box {
      text-align: center;
      padding: 1rem;
      background: var(--panel);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .metric-label {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }
    .metric-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--brand);
    }
    .goals-preview {
      background: rgba(89, 162, 255, 0.05);
      border-radius: 8px;
      padding: 0.75rem;
      border-left: 3px solid var(--brand);
    }
    
    /* Enhanced buttons and interactions */
    .btn {
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    .btn-lg {
      padding: 0.75rem 1.5rem;
      font-weight: 600;
    }
    
    /* Loading states */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Better form controls */
    .form-control, .form-select {
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .form-control:focus, .form-select:focus {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
    }
    
    /* Enhanced cards */
    .card {
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    .card:hover {
      transform: translateY(-1px);
    }
    
    /* Better badges */
    .badge {
      border-radius: 6px;
      font-weight: 500;
    }
    
    /* Consistent spacing and typography */
    h5, h6 {
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .card-header {
      background: rgba(var(--bs-primary-rgb), 0.05);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .form-label {
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    /* Enhanced tables */
    .table {
      border-radius: 8px;
      overflow: hidden;
    }
    .table th {
      background: var(--panel);
      border: none;
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--muted);
      padding: 0.75rem;
    }
    .table td {
      border-color: rgba(255,255,255,.05);
      padding: 0.75rem;
      vertical-align: middle;
    }
    
    /* Progress bars */
    .progress {
      border-radius: 6px;
      background: rgba(255,255,255,.05);
    }
    .progress-bar {
      border-radius: 6px;
      background: linear-gradient(90deg, var(--ok), var(--brand));
    }
    
    /* Navigation improvements */
    .nav-pills .nav-link {
      border-radius: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .nav-pills .nav-link:hover {
      transform: translateY(-1px);
      background: rgba(255,255,255,.08);
    }
    
    /* Drag and Drop Zone */
    .drag-drop-zone {
      border: 2px dashed var(--muted);
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--panel);
      position: relative;
    }
    .drag-drop-zone:hover {
      border-color: var(--brand);
      background: rgba(89, 162, 255, 0.05);
    }
    .drag-drop-zone.drag-over {
      border-color: var(--brand);
      background: rgba(89, 162, 255, 0.1);
      transform: scale(1.02);
    }
    .drag-drop-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    .drag-drop-text {
      color: var(--text);
    }
    .drag-drop-content {
      pointer-events: none;
    }
    
    /* Modular Scenario Builder */
    .drag-source-container {
      min-height: 200px;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 8px;
      padding: 1rem;
      background: var(--panel);
    }
    
    .draggable-item {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      cursor: move;
      transition: all 0.2s ease;
      user-select: none;
    }
    
    .draggable-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      border-color: var(--brand);
    }
    
    .draggable-item.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    
    .drop-zone {
      border: 2px dashed var(--muted);
      border-radius: 8px;
      min-height: 100px;
      background: rgba(255,255,255,.02);
      transition: all 0.3s ease;
    }
    
    .drop-zone.drag-over {
      border-color: var(--brand);
      background: rgba(89, 162, 255, 0.1);
      transform: scale(1.02);
    }
    
    .drop-zone-header {
      background: var(--muted);
      color: var(--bg);
      padding: 0.5rem;
      border-radius: 6px 6px 0 0;
      font-size: 0.875rem;
      font-weight: 600;
      text-align: center;
    }
    
    .drop-zone-content {
      padding: 1rem;
      min-height: 80px;
    }
    
    .drop-placeholder {
      text-align: center;
      color: var(--muted);
      font-style: italic;
      padding: 1rem;
    }
    
    .selected-item {
      background: rgba(89, 162, 255, 0.1);
      border: 1px solid var(--brand);
      border-radius: 6px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: between;
      align-items: center;
    }
    
    .selected-item .remove-btn {
      background: rgba(255,255,255,.1);
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: auto;
    }
    
    /* Enhanced micro-interactions */
    .kpi {
      transition: all 0.2s ease;
      cursor: default;
    }
    .kpi:hover {
      background: rgba(89, 162, 255, 0.05);
    }
    .chip {
      transition: all 0.2s ease;
    }
    .chip:hover {
      transform: scale(1.02);
    }
    
    /* Loading animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .loading-shimmer {
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      .navbar-brand { font-size: 1rem; }
      .card { margin-bottom: 1rem; }
      .btn-group-mobile { display: flex; flex-direction: column; gap: 0.5rem; }
      .btn-group-mobile .btn { width: 100%; }
      canvas { max-width: 100%; height: auto !important; }
      .table-responsive { font-size: 0.875rem; }
      .nav-pills { flex-wrap: wrap; }
      .nav-pills .nav-link { padding: 0.375rem 0.5rem; font-size: 0.875rem; }
      .sync-banner { flex-direction: column; gap: 0.5rem; text-align: center; }
      .sync-banner .sync-actions { justify-content: center; }
      
      /* Mobile scenario cards */
      .scenario-card { margin-bottom: 1rem; }
      .metric-box { padding: 0.75rem; }
      .metric-value { font-size: 0.9rem; }
      .goals-preview { padding: 0.5rem; }
    }
    
    @media (max-width: 576px) {
      .container { padding-left: 0.5rem; padding-right: 0.5rem; }
      .card { padding: 0.75rem !important; }
      .btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
      h5, h6 { font-size: 1rem; }
      .kpi .value { font-size: 1rem; }
    }
  </style>
</head>
<body>
<!-- Loading Screen -->
<div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 1rem;">
  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
    <span class="visually-hidden">Loading...</span>
  </div>
  <div style="color: var(--text);">Initializing Savings Tracker...</div>
  <div id="loadingStatus" style="color: var(--muted); font-size: 0.875rem;"></div>
</div>

<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom" style="display: none;" id="mainNav">
<div class="container-fluid">
<a class="navbar-brand fw-bold" href="#">ğŸ’° Savings Dashboard</a>
<div class="d-flex gap-1 no-print btn-group-mobile">
<button class="btn btn-ghost btn-sm" id="printBtn">ğŸ–¨ï¸</button>
<button class="btn btn-outline-secondary btn-sm" id="themeToggle" title="Toggle theme">ğŸŒ“</button>
<button class="btn btn-outline-danger btn-sm" id="resetBtn">â†º</button>
<button class="btn btn-outline-primary btn-sm" id="logoutBtn" title="Logout">ğŸšª</button>
</div>
</div>
</nav>

<!-- Tracker Switcher -->
<div class="tracker-switcher" style="padding: 0.75rem 1rem; background: var(--panel); border-bottom: 1px solid rgba(255,255,255,.08);">
  <div style="display: flex; gap: 1rem; align-items: center; max-width: 1400px; margin: 0 auto;">
    <label for="tracker-select" style="font-weight: 600; color: var(--muted); font-size: 0.9rem;">
      Active Tracker:
    </label>
    <select id="tracker-select" style="flex: 1; max-width: 300px; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,.15); font-size: 0.9rem; background: var(--bg); color: var(--text);">
      <option>Loading trackers...</option>
    </select>
    <button id="btn-new-tracker" class="btn btn-primary btn-sm" style="white-space: nowrap;">
      + New Tracker
    </button>
  </div>
</div>

<!-- Create Tracker Modal -->
<div id="create-tracker-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
  <div style="background-color: var(--bg); margin: 15% auto; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,.15);">
    <h3 style="margin-top: 0; margin-bottom: 1.5rem; color: var(--text);">Create New Tracker</h3>
    
    <div style="margin-bottom: 1rem;">
      <label for="new-tracker-name" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">
        Tracker Name *
      </label>
      <input 
        type="text" 
        id="new-tracker-name" 
        placeholder="e.g., Personal Savings, Family Fund"
        class="form-control"
        required
      >
    </div>
    
    <div style="margin-bottom: 1.5rem;">
      <label for="new-tracker-desc" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">
        Description (optional)
      </label>
      <textarea 
        id="new-tracker-desc" 
        placeholder="What is this tracker for?"
        rows="3"
        class="form-control"
      ></textarea>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button id="btn-cancel-tracker" class="btn btn-secondary">Cancel</button>
      <button id="btn-create-tracker" class="btn btn-primary">Create Tracker</button>
    </div>
  </div>
</div>

<!-- Sync notification banner -->
<div class="sync-banner" id="syncBanner">
  <div>ğŸ“± <strong>Sync available!</strong> Import data from another device to combine your changes.</div>
  <div class="sync-actions">
    <button class="btn btn-light btn-sm" id="syncBannerImport">ğŸ“¥ Import Now</button>
    <button class="btn btn-outline-light btn-sm" id="syncBannerDismiss">âœ• Dismiss</button>
  </div>
</div>

<main class="container my-3" style="display: none;" id="mainContent">
<!-- Tabs -->
<ul class="nav nav-pills no-print" id="mainTabs" role="tablist">
<li class="nav-item" role="presentation"><button class="nav-link active" data-bs-target="#tabDashboard" data-bs-toggle="pill" role="tab" type="button">ğŸ“Š Dashboard</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#tabPeople" data-bs-toggle="pill" role="tab" type="button">ğŸ‘¥ People</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#tabGoals" data-bs-toggle="pill" role="tab" type="button">ğŸ¯ Goals</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#tabRates" data-bs-toggle="pill" role="tab" type="button">ğŸ“ˆ Rates</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#tabTx" data-bs-toggle="pill" role="tab" type="button">ğŸ’³ Transactions</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#tabExport" data-bs-toggle="pill" role="tab" type="button">ğŸ“ Export</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#tabSettings" data-bs-toggle="pill" role="tab" type="button">âš™ï¸ Settings</button></li>
</ul>
<div class="tab-content mt-3">
<!-- Dashboard -->
<section class="tab-pane fade show active" id="tabDashboard" role="tabpanel">
<div class="row g-3">
<!-- KPIs -->
<div class="col-12">
<div class="row g-3">
<div class="col-6 col-lg-3">
<div class="card p-3 kpi">
<div class="muted">Total Monthly Income</div>
<div class="value" id="kpiMonthlyIncome">â€”</div>
</div>
</div>
<div class="col-6 col-lg-3">
<div class="card p-3 kpi">
<div class="muted">Current Savings</div>
<div class="value" id="kpiCurrentSavings">â€”</div>
</div>
</div>
<div class="col-6 col-lg-3">
<div class="card p-3 kpi">
<div class="muted">Savings Rate</div>
<div class="value" id="kpiSavingsRate">â€”</div>
</div>
</div>
<div class="col-6 col-lg-3">
<div class="card p-3 kpi">
<div class="muted">APY / Inflation</div>
<div class="value"><span id="kpiApy">â€”</span> / <span id="kpiInflation">â€”</span></div>
</div>
</div>
<div class="col-6 col-lg-3">
<div class="card p-3 kpi">
<div class="muted">Emergency Fund</div>
<div class="value" id="kpiEmergencyRatio">â€”</div>
</div>
</div>
<div class="col-6 col-lg-3">
<div class="card p-3 kpi">
<div class="muted">Goals On Track</div>
<div class="value" id="kpiGoalsOnTrack">â€”</div>
</div>
</div>
</div>
</div>
<!-- Charts -->
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ‘¥ Contribution Breakdown</h5>
<div class="row g-2 mb-2">
<div class="col-12" id="contributionSummary"></div>
</div>
<canvas height="130" id="contributionChart"></canvas>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ¯ Goal Timeline (ETA at plan)</h5>
<canvas height="130" id="timelineChart"></canvas>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ“ˆ Savings Consistency</h5>
<div class="small mb-2 text-muted">Monthly savings pattern over time</div>
<canvas height="130" id="consistencyChart"></canvas>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ§¾ Recent Transactions (6 mo)</h5>
<canvas height="130" id="txChart"></canvas>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ¯ Goals at a Glance</h5>
<div id="goalsGlance"></div>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ’¡ Smart Insights</h5>
<div id="smartInsights"></div>
</div>
</div>
<div class="col-12">
<div class="card p-3">
<h5 class="mb-2">ğŸ“… Monthly Contribution Tracker</h5>
<div class="row g-3">
<div class="col-lg-8">
<canvas height="120" id="monthlyContributionChart"></canvas>
</div>
<div class="col-lg-4">
<div id="contributionStreak"></div>
<div class="mt-3" id="contributionTable"></div>
</div>
</div>
</div>
</div>
</div>
</section>
<!-- People & Incomes -->
<section class="tab-pane fade" id="tabPeople" role="tabpanel">
<div class="card p-3 mb-3">
<div class="row g-3">
<div class="col-md-3">
<label class="form-label">Name</label>
<input class="form-control" id="personName" placeholder="e.g., Michael"/>
</div>
<div class="col-md-3">
<label class="form-label">Current Savings</label>
<input class="form-control" id="personSavings" placeholder="120000" step="0.01" type="number"/>
</div>
<div class="col-md-3">
<label class="form-label">Fixed Monthly (Optional)</label>
<input class="form-control" id="personFixedContribution" placeholder="5000" step="0.01" type="number"/>
<small class="text-muted">Fixed amount regardless of rate</small>
</div>
<div class="col-md-3 d-flex align-items-end">
<button class="btn btn-primary w-100" id="addPersonBtn">+ Add Person</button>
</div>
</div>
</div>
<div class="row g-3" id="peopleList"></div>
</section>
<!-- Goals -->
<section class="tab-pane fade" id="tabGoals" role="tabpanel">
<div class="card p-3 mb-3">
<div class="row g-3">
<div class="col-md-3">
<label class="form-label">Goal</label>
<input class="form-control" id="goalName" placeholder="Emergency Fund"/>
</div>
<div class="col-md-2">
<label class="form-label">Target</label>
<input class="form-control" id="goalTarget" placeholder="200000" step="0.01" type="number"/>
</div>
<div class="col-md-2">
<label class="form-label">Deadline</label>
<input class="form-control" id="goalDeadline" type="date"/>
</div>
<div class="col-md-3">
<label class="form-label">Owner</label>
<select class="form-select" id="goalOwner"></select>
</div>
<div class="col-md-1">
<label class="form-label">Priority</label>
<input class="form-control" id="goalPriority" min="1" type="number" value="1"/>
</div>
<div class="col-md-1 d-flex align-items-end">
<button class="btn btn-primary w-100" id="addGoalBtn">+ Add</button>
</div>
</div>
</div>
<div class="row g-3" id="goalsList"></div>
<div class="card p-3 mt-3">
<h6 class="mb-2">Monthly Requirement vs Plan</h6>
<div class="row g-3" id="goalsRequiredList"></div>
</div>
</section>
<!-- Rate Scenarios -->
<section class="tab-pane fade" id="tabRates" role="tabpanel">

<!-- Scenario Filters -->
<div class="card p-4 mb-4">
<h5 class="mb-3">ğŸ›ï¸ Scenario Configuration</h5>
<div class="row g-4">

<div class="col-md-4">
<h6 class="text-primary mb-3">ğŸ‘¥ Select Contributors</h6>
<div id="contributorsFilter">
<!-- Contributor checkboxes will be populated here -->
</div>
</div>

<div class="col-md-4">
<h6 class="text-success mb-3">ğŸ¯ Select Goals</h6>
<div id="goalsFilter">
<!-- Goal checkboxes will be populated here -->
</div>
</div>

<div class="col-md-4">
<h6 class="text-warning mb-3">ğŸ“ˆ Configuration</h6>
<div class="mb-3">
<label class="form-label">Savings Rates (%)</label>
<input class="form-control" id="scenarioRates" value="5,10,15,20" placeholder="e.g., 5,10,15,20"/>
</div>
<div class="d-grid gap-2">
<button class="btn btn-primary" id="refreshRatesBtn">ğŸ”„ Calculate Scenarios</button>
<button class="btn btn-success" id="exportRatesExcelBtn">ğŸ“Š Export to Excel</button>
</div>
</div>

</div>
</div>

<!-- Rate Scenarios Table -->
<div class="card p-3">
<div class="table-responsive">
<table class="table table-hover align-middle" id="ratesTable">
<thead class="table-dark">
<tr>
<th style="width:8%;">Rate</th>
<th style="width:15%;">Monthly</th>
<th style="width:15%;">2-Year Value</th>
<th style="width:15%;">5-Year Value</th>
<th style="width:12%;">Goals Status</th>
<th style="width:20%;">Key Impact</th>
<th style="width:15%;">Recommendation</th>
</tr>
</thead>
<tbody><!-- filled by JS --></tbody>
</table>
</div>
</div>

</section>
<!-- Transactions -->
<section class="tab-pane fade" id="tabTx" role="tabpanel">
<div class="row g-3">
<div class="col-lg-6">
<div class="card p-3">
<h6>Add Savings Transaction</h6>
<div class="row g-3">
<div class="col-md-4">
<label class="form-label">Date</label>
<input class="form-control" id="txDate" type="date"/>
</div>
<div class="col-md-4">
<label class="form-label">Amount</label>
<input class="form-control" id="txAmount" placeholder="5000" step="0.01" type="number"/>
</div>
<div class="col-md-4">
<label class="form-label">Person</label>
<select class="form-select" id="txPerson"></select>
</div>
<div class="col-12">
<label class="form-label">ğŸ¯ Allocate to Goal (Optional)</label>
<select class="form-select" id="txGoal">
<option value="">ğŸ’° General Savings (No specific goal)</option>
</select>
<div class="mt-1" id="goalSuggestion" style="display:none;">
<small class="text-info">ğŸ’¡ <span id="suggestionText"></span></small>
</div>
</div>
<div class="col-12">
<label class="form-label">Note</label>
<input class="form-control" id="txNote" placeholder="Payday auto-save"/>
</div>
<div class="col-12 d-grid">
<button class="btn btn-primary" id="addTxBtn">+ Add Transaction</button>
</div>
</div>
</div>
</div>
<div class="col-lg-6">
<div class="row g-3">
<div class="col-6">
<div class="card p-3">
<div class="muted">Total Transactions</div>
<div class="fs-4 fw-bold" id="txTotal">â€”</div>
</div>
</div>
<div class="col-6">
<div class="card p-3">
<div class="muted">Last 30 Days</div>
<div class="fs-4 fw-bold" id="txLast30">â€”</div>
</div>
</div>
<div class="col-6">
<div class="card p-3">
<div class="muted">Top Contributor</div>
<div class="fs-6 fw-semibold" id="txTopPerson">â€”</div>
</div>
</div>
<div class="col-6"></div>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h6>Recent Totals (6 months)</h6>
<canvas height="130" id="txChart2"></canvas>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h6>By Month (stacked by person)</h6>
<canvas height="130" id="txStackedChart"></canvas>
</div>
</div>
<div class="col-12">
<div class="card p-3">
<h6>Transactions</h6>
<div class="table-responsive">
<table class="table table-sm align-middle" id="txTable">
<thead><tr><th>Date</th><th>Person</th><th class="text-end">Amount</th><th>Goal</th><th>Note</th><th></th></tr></thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
</div>
</section>
<!-- Export / Import -->
<section class="tab-pane fade" id="tabExport" role="tabpanel">
<div class="card p-3">
<div class="d-flex flex-wrap gap-2">
<button class="btn btn-primary" id="exportJsonBtn">â¬‡ï¸ Export JSON</button>
<button class="btn btn-ghost" id="exportCsvPeopleBtn">â¬‡ï¸ People CSV</button>
<button class="btn btn-ghost" id="exportCsvGoalsBtn">â¬‡ï¸ Goals CSV</button>
<button class="btn btn-ghost" id="exportCsvTxBtn">â¬‡ï¸ Transactions CSV</button>
<span class="chip">Autoâ€‘save: <b>localStorage</b></span>
</div>
<hr/>
<div class="row g-3">
<div class="col-md-6">
<label class="form-label">Import JSON</label>
<input accept=".json,application/json" class="form-control" id="importFile" type="file"/>
</div>
<div class="col-md-2 d-flex align-items-end">
<button class="btn btn-warning w-100" id="importBtn">â¬†ï¸ Import</button>
</div>
</div>
</div>
</section>
<!-- Settings -->
<section class="tab-pane fade" id="tabSettings" role="tabpanel">
<div class="card p-3 mb-3">
<h6>ğŸ’¾ General Settings</h6>
<div class="row g-3">
<div class="col-md-3">
<label class="form-label">Currency</label>
<select class="form-select" id="currencyCode">
<option value="PHP">PHP â€“ Philippine Peso</option>
<option value="USD">USD â€“ US Dollar</option>
<option value="EUR">EUR â€“ Euro</option>
<option value="JPY">JPY â€“ Yen</option>
<option value="AUD">AUD â€“ Australian Dollar</option>
<option value="GBP">GBP â€“ British Pound</option>
<option value="SGD">SGD â€“ Singapore Dollar</option>
</select>
</div>
<div class="col-md-3">
<label class="form-label">Locale</label>
<select class="form-select" id="localeSelect">
<option value="en-PH">English (Philippines)</option>
<option value="en-US">English (US)</option>
<option value="en-GB">English (UK)</option>
<option value="fil-PH">Filipino (Philippines)</option>
<option value="de-DE">Deutsch (DE)</option>
<option value="fr-FR">FranÃ§ais (FR)</option>
</select>
</div>
<div class="col-md-2">
<label class="form-label">Savings Rate (%)</label>
<input class="form-control" id="currentRate" step="0.1" type="number" value="12"/>
</div>
<div class="col-md-2">
<label class="form-label">APY (%)</label>
<input class="form-control" id="apy" step="0.1" type="number" value="3"/>
</div>
<div class="col-md-2">
<label class="form-label">Inflation (%)</label>
<input class="form-control" id="inflation" step="0.1" type="number" value="4"/>
</div>
<div class="col-md-12 d-flex justify-content-end">
<button class="btn btn-primary" id="saveSettingsBtn">ğŸ’¾ Save Settings</button>
</div>
</div>
</div>

<div class="row g-4">
<!-- EXPORT Section -->
<div class="col-lg-6">
<div class="card p-3 border-success">
<div class="card-header bg-success bg-opacity-10 border-0 rounded">
<h6 class="mb-0 text-success">ğŸ“¤ Export Data (Share to Other Devices)</h6>
</div>
<div class="card-body">
<p class="small text-muted mb-3">Share your savings data with other devices</p>
<button class="btn btn-success w-100 mb-3" id="generateQRBtn">ğŸ“· Generate QR Code</button>
<div class="col-12 text-center" id="qrCodeContainer" style="display:none;">
<div id="qrCodeDisplay"></div>
<small class="text-success d-block mt-2">ğŸ“± Scan this with another device to import your data</small>
</div>
</div>
</div>
</div>

<!-- IMPORT Section -->
<div class="col-lg-6">
<div class="card p-3 border-primary">
<div class="card-header bg-primary bg-opacity-10 border-0 rounded">
<h6 class="mb-0 text-primary">ğŸ“¥ Import Data (Get from Other Devices)</h6>
</div>
<div class="card-body">
<p class="small text-muted mb-3">Import data from another device using any method below</p>

<div class="d-grid gap-2 mb-3">
<button class="btn btn-primary" id="scanCameraBtn">ğŸ“· Scan QR with Camera</button>
<button class="btn btn-outline-primary" id="uploadImageBtn">ğŸ–¼ï¸ Upload QR Image</button>
<button class="btn btn-outline-secondary" id="pasteTextBtn">ğŸ“ Paste Text Data</button>
</div>

<!-- Camera Scanner -->
<div id="cameraContainer" style="display:none;">
<div class="text-center mb-3">
<video id="qrVideo" style="max-width:100%; max-height:250px; border-radius:8px; background:#000;"></video>
<div class="mt-2">
<button class="btn btn-danger btn-sm" id="stopScanBtn">â¹ï¸ Stop Scanning</button>
<div class="small text-muted mt-1">Point camera at QR code</div>
</div>
</div>
</div>

<!-- Image Upload -->
<div id="uploadContainer" style="display:none;">
<div class="mb-3">
<div class="drag-drop-zone" id="dragDropZone">
<div class="drag-drop-content">
<div class="drag-drop-icon">ğŸ–¼ï¸</div>
<div class="drag-drop-text">
<strong>Drag & drop QR image here</strong><br>
<small class="text-muted">or click to browse</small>
</div>
</div>
<input type="file" class="form-control d-none" id="qrImageFile" accept="image/*" />
</div>
<small class="text-muted">Supports JPG, PNG, WebP - screenshots or photos of QR codes</small>
</div>
</div>

<!-- Text Input -->
<div id="textContainer" style="display:none;">
<div class="mb-3">
<textarea class="form-control" id="importData" placeholder="Paste the QR code text data here" rows="4"></textarea>
<button class="btn btn-success w-100 mt-2" id="importDataBtn">ğŸ“¥ Import Data</button>
</div>
</div>

</div>
</div>
</div>
</div>
</section>
</div>
</main>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Auth & API Scripts -->
<script>
    // âš ï¸ CRITICAL: Run immediately when page loads
    console.log('%cğŸ“„ savings_app_v16.html SCRIPT BLOCK STARTED', 'color: blue; font-size: 14px; font-weight: bold;');
    console.log('ğŸ”— URL:', window.location.href);
    console.log('ğŸ”— Hash:', window.location.hash);
    console.log('ğŸ”— Document ready:', document.readyState);
    console.log('ğŸ“š Scripts will load next...');
    
    // Verify Supabase is loaded (from head)
    if (typeof window.supabase === 'undefined') {
        console.error('âŒ Supabase library not loaded from CDN!');
        console.error('âŒ Check Network tab for: @supabase/supabase-js');
    } else {
        console.log('âœ… Supabase library loaded:', typeof window.supabase);
    }
    
    // Check if we can access window
    console.log('âœ… window object accessible:', typeof window !== 'undefined');
    console.log('âœ… document accessible:', typeof document !== 'undefined');
    console.log('âœ… console accessible:', typeof console !== 'undefined');
</script>
<script src="js/auth.js" onerror="console.error('âŒ CRITICAL: Failed to load js/auth.js - check file exists!')"></script>
<script src="js/api.js" onerror="console.error('âŒ CRITICAL: Failed to load js/api.js - check file exists!')"></script>
<script src="js/tracker-manager.js" onerror="console.error('âŒ CRITICAL: Failed to load js/tracker-manager.js - check file exists!')"></script>
<script>
    // Verify scripts loaded
    console.log('ğŸ“š After script tags:');
    console.log('auth.js:', typeof window.auth !== 'undefined' ? 'âœ… Loaded' : 'âŒ Not loaded');
    console.log('SavingsAPI:', typeof window.SavingsAPI !== 'undefined' ? 'âœ… Loaded' : 'âŒ Not loaded');
    console.log('TrackerManager:', typeof window.TrackerManager !== 'undefined' ? 'âœ… Loaded' : 'âŒ Not loaded');
    
    // Use window references for safety
    const auth = window.auth;
    const SavingsAPI = window.SavingsAPI;
    const TrackerManager = window.TrackerManager;
    
    // Verify critical dependencies
    if (typeof auth === 'undefined') {
        console.error('âŒ CRITICAL ERROR: auth is not defined!');
        console.error('Check if js/auth.js loaded correctly');
    }
    if (typeof SavingsAPI === 'undefined') {
        console.error('âŒ CRITICAL ERROR: SavingsAPI is not defined!');
        console.error('Check if js/api.js loaded correctly');
    }
    if (typeof TrackerManager === 'undefined') {
        console.error('âŒ CRITICAL ERROR: TrackerManager is not defined!');
        console.error('Check if js/tracker-manager.js loaded correctly');
    }
</script>
<script>
    /********** AUTHENTICATION & INITIALIZATION **********/
    // Set Supabase credentials
    window.SUPABASE_URL = window.SUPABASE_URL || 'https://uqbcokdpldhrxccyddfz.supabase.co';
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxYmNva2RwbGRocnhjY3lkZGZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwOTM5MzcsImV4cCI6MjA3NzY2OTkzN30.4yknX1zqpfloABqexwzl0ElLYVp4C_atUbNAR8P_1eU';

    // Update loading status
    function updateLoadingStatus(message) {
      const statusEl = document.getElementById('loadingStatus');
      if (statusEl) statusEl.textContent = message;
      console.log(message);
    }

    console.log('ğŸš€ Starting app initialization...');
    updateLoadingStatus('Checking authentication...');

    // Handle OAuth callback (Supabase adds hash fragments after OAuth redirect)
    // Check if we're returning from OAuth
    if (window.location.hash) {
      console.log('ğŸ”— OAuth callback detected, processing...');
      updateLoadingStatus('Completing Google sign-in...');
    }

    // Wait for auth to initialize (with timeout)
    let authWaitAttempts = 0;
    const MAX_AUTH_WAIT = 50; // 5 seconds max
    
    function waitForAuth(callback) {
      authWaitAttempts++;
      
      // Use window.auth for safety
      const authInstance = typeof window !== 'undefined' && window.auth ? window.auth : (typeof auth !== 'undefined' ? auth : null);
      
      if (authInstance && authInstance.supabase) {
        console.log('âœ… Auth initialized');
        
        // Handle OAuth callback if hash is present
        if (window.location.hash && window.location.hash.includes('access_token')) {
          console.log('ğŸ”— Processing OAuth callback...');
          updateLoadingStatus('Completing sign-in...');
          
          // Supabase will automatically handle the hash, but we can help it along
          authInstance.supabase.auth.getSession().then(() => {
            // Clear hash from URL
            if (window.history && window.history.replaceState) {
              window.history.replaceState(null, '', window.location.pathname);
            }
            updateLoadingStatus('Sign-in complete!');
            callback();
          });
        } else {
          updateLoadingStatus('Auth ready');
          callback();
        }
      } else if (authWaitAttempts >= MAX_AUTH_WAIT) {
        console.error('âŒ Auth initialization timeout - trying direct Supabase check');
        updateLoadingStatus('Auth timeout - trying direct check...');
        // Fallback: try to check session directly
        try {
          if (typeof window.supabase === 'undefined') {
            throw new Error('Supabase library not loaded');
          }
          const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
          supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
              console.log('âœ… Session found via direct check');
              updateLoadingStatus('Session found');
              // Create auth object manually if needed
              if (!window.auth || typeof window.auth === 'undefined') {
                window.auth = {
                  supabase: supabase,
                  checkSession: async () => {
                    const { data } = await supabase.auth.getSession();
                    return data.session;
                  },
                  getToken: () => session?.access_token,
                  getHeaders: () => ({
                    'Authorization': `Bearer ${session.access_token}`,
                    'Content-Type': 'application/json'
                  }),
                  signOut: () => supabase.auth.signOut()
                };
                console.log('âœ… Created window.auth manually');
              }
              callback();
            } else {
              console.log('âŒ No session found, redirecting to login');
              updateLoadingStatus('No session - redirecting...');
              setTimeout(() => window.location.href = '/login.html', 1000);
            }
          }).catch(err => {
            console.error('âŒ Session check failed:', err);
            updateLoadingStatus('Session check failed - redirecting...');
            setTimeout(() => window.location.href = '/login.html', 1000);
          });
        } catch (error) {
          console.error('âŒ Direct auth check failed:', error);
          updateLoadingStatus('Auth failed: ' + error.message);
          setTimeout(() => window.location.href = '/login.html', 2000);
        }
      } else {
        if (authWaitAttempts % 10 === 0) {
          updateLoadingStatus(`Waiting for auth scripts to load... (${authWaitAttempts}/${MAX_AUTH_WAIT})`);
        }
        setTimeout(() => waitForAuth(callback), 100);
      }
    }
    
    // Hide loading screen
    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('loadingScreen');
      const mainNav = document.getElementById('mainNav');
      const trackerSwitcher = document.getElementById('trackerSwitcher');
      const mainContent = document.getElementById('mainContent');
      
      console.log('ğŸ”„ Hiding loading screen...');
      
      if (loadingScreen) {
        loadingScreen.style.display = 'none';
        console.log('âœ… Loading screen hidden');
      } else {
        console.warn('âš ï¸ Loading screen element not found');
      }
      
      if (mainNav) {
        mainNav.style.display = 'flex';
        console.log('âœ… Navbar shown');
      } else {
        console.warn('âš ï¸ Navbar element not found');
      }
      
      if (trackerSwitcher) {
        if (trackerSwitcher.style.display === 'none') {
          trackerSwitcher.style.display = 'block';
        }
        console.log('âœ… Tracker switcher shown');
      } else {
        console.warn('âš ï¸ Tracker switcher element not found');
      }
      
      if (mainContent) {
        mainContent.style.display = 'block';
        console.log('âœ… Main content shown');
      } else {
        console.warn('âš ï¸ Main content element not found');
      }
      
      console.log('âœ… Loading screen hidden, UI visible');
      
      // Force a repaint
      document.body.offsetHeight;
    }

    // Check authentication and initialize app
    waitForAuth(async () => {
      try {
        updateLoadingStatus('Checking session...');
        console.log('ğŸ” Checking session...');
        
        // Get auth instance
        const authInstance = window.auth || auth;
        if (!authInstance) {
          throw new Error('Auth instance not found!');
        }
        
        const session = await authInstance.checkSession();
        console.log('Session check result:', session ? 'âœ… Authenticated' : 'âŒ Not authenticated');
        
        if (!session) {
          // Not logged in, redirect to login
          console.log('Redirecting to login...');
          updateLoadingStatus('Not authenticated - redirecting to login...');
          setTimeout(() => window.location.href = '/login.html', 1000);
          return;
        }

        updateLoadingStatus('Initializing app...');
        console.log('ğŸ¯ Initializing app...');
        // Initialize tracker manager and API
        await initializeApp();
        console.log('âœ… App initialized successfully!');
        
        // Hide loading screen after successful initialization
        hideLoadingScreen();
      } catch (error) {
        console.error('âŒ Auth/init error:', error);
        console.error('Full error:', JSON.stringify(error, Object.getOwnPropertyNames(error)));
        updateLoadingStatus('Error: ' + error.message);
        
        // Show error but don't hide loading screen
        setTimeout(() => {
          alert('Failed to initialize app: ' + error.message + '\n\nCheck browser console (F12) for details.');
        }, 500);
      }
    });

    /********** STATE **********/
    const STORAGE_KEY = 'savingsBootstrapV1';
    const uid = () => 'id-' + Math.random().toString(36).slice(2,9);
    const todayOffset = (d)=>{ const x=new Date(); x.setDate(x.getDate()+d); return x.toISOString().slice(0,10); };
    
    // Global variables for API and tracker
    let api = null;
    let trackerManager = null;
    let currentTrackerId = null;

    const defaultState = {
      settings: { currency:'PHP', locale:'en-PH', currentRatePct:12, apyPct:3, inflationPct:4 },
      people: [],
      goals: [],
      transactions: [],
      scenarioRates: [5,10,15,20]
    };

    let appState = JSON.parse(JSON.stringify(defaultState));

    // Initialize app with authentication
    async function initializeApp() {
      try {
        updateLoadingStatus('Initializing tracker manager...');
        console.log('ğŸ“¦ Initializing tracker manager...');
        // Get auth instance
        const authInstance = window.auth || auth;
        if (!authInstance) {
          throw new Error('Auth instance not available for tracker initialization');
        }
        
        // Initialize tracker manager
        updateLoadingStatus('Initializing tracker manager...');
        const SavingsAPIClass = window.SavingsAPI || SavingsAPI;
        const TrackerManagerClass = window.TrackerManager || TrackerManager;
        
        if (!SavingsAPIClass || !TrackerManagerClass) {
          throw new Error('Required classes not loaded. Check js/api.js and js/tracker-manager.js');
        }
        
        const tempApi = new SavingsAPIClass(authInstance, 'temp');
        trackerManager = new TrackerManagerClass(tempApi);
        currentTrackerId = await trackerManager.initialize();
        console.log('âœ… Tracker initialized:', currentTrackerId);
        updateLoadingStatus('Tracker ready');
        
        // Initialize API with tracker
        updateLoadingStatus('Setting up API...');
        api = new SavingsAPIClass(authInstance, currentTrackerId);
        trackerManager.api = api;
        console.log('âœ… API initialized');
        
        // Initialize tracker UI
        updateLoadingStatus('Setting up UI...');
        console.log('ğŸ¨ Initializing tracker UI...');
        const initializeTrackerUIFn = window.initializeTrackerUI || initializeTrackerUI;
        if (typeof initializeTrackerUIFn === 'function') {
          initializeTrackerUIFn(trackerManager);
          // Show tracker switcher
          const trackerSwitcher = document.getElementById('trackerSwitcher');
          if (trackerSwitcher) {
            trackerSwitcher.style.display = 'block';
          }
          console.log('âœ… Tracker UI initialized');
        } else {
          console.warn('âš ï¸ initializeTrackerUI function not found');
          console.warn('Available functions:', Object.keys(window).filter(k => k.includes('tracker') || k.includes('Tracker')));
        }
        
        // Load data from backend
        updateLoadingStatus('Loading your data...');
        console.log('ğŸ“¥ Loading data from backend...');
        await loadDataFromBackend();
        console.log('âœ… Data loaded:', {
          people: appState.people.length,
          goals: appState.goals.length,
          transactions: appState.transactions.length
        });
        updateLoadingStatus('Data loaded');
        
        // Initial render
        updateLoadingStatus('Rendering dashboard...');
        console.log('ğŸ¨ Rendering UI...');
        renderAll();
        console.log('âœ… Render complete!');
        
        // Small delay before hiding loading screen for smooth transition
        setTimeout(() => {
          hideLoadingScreen();
        }, 300);
      } catch (error) {
        console.error('âŒ App initialization error:', error);
        console.error('Error stack:', error.stack);
        updateLoadingStatus('Error: ' + error.message);
        throw error; // Re-throw so caller can handle
      }
    }

    // Load data from backend API
    async function loadDataFromBackend() {
      try {
        console.log('ğŸ“¡ Fetching data from API...');
        const data = await api.getAllData();
        console.log('ğŸ“Š Received data:', data);
        
        // Transform backend data to app state format
        appState = {
          settings: {
            currency: data.settings?.currency || 'PHP',
            locale: data.settings?.locale || 'en-PH',
            currentRatePct: data.settings?.currentRatePct || 12,
            apyPct: data.settings?.apyPct || 3,
            inflationPct: data.settings?.inflationPct || 4
          },
          people: (data.people || []).map(p => ({
            id: p.id,
            name: p.name,
            currentSavings: p.currentSavings || 0,
            fixedMonthlyContribution: p.fixedMonthlyContribution || 0,
            incomes: (p.incomes || []).map(i => ({
              id: i.id,
              label: i.label,
              amount: i.amount,
              frequency: i.frequency || 'monthly'
            }))
          })),
          goals: (data.goals || []).map(g => ({
            id: g.id,
            name: g.name,
            target: g.target,
            deadline: g.deadline,
            owner: g.owner || 'Household',
            priority: g.priority || 999
          })),
          transactions: (data.transactions || []).map(t => ({
            id: t.id,
            date: t.date,
            person: t.person,
            amount: t.amount,
            note: t.note || '',
            goalId: t.goalId || null
          })),
          scenarioRates: data.scenarioRates || [5,10,15,20]
        };

        // If no data, show default sample (for new users)
        if (appState.people.length === 0 && appState.goals.length === 0) {
          console.log('â„¹ï¸ No data found, showing empty state');
        }
      } catch (error) {
        console.error('âŒ Error loading data:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          response: error.response
        });
        // Continue with default state on error - don't block rendering
        console.log('âš ï¸ Continuing with empty state due to error');
      }
    }

    // Save state to backend
    async function saveState(changedSections = ['all']) {
      try {
        // Update settings
        await api.updateSettings(appState.settings);
        
        // Note: People, goals, transactions are saved individually when modified
        // This function is called after render, so we don't need to save everything here
        
        // Selective rendering based on what changed
        if(changedSections.includes('all')) {
          renderAll();
        } else {
          updateSections(changedSections);
        }
      } catch (error) {
        console.error('Error saving state:', error);
        // Still render even if save fails
        if(changedSections.includes('all')) {
          renderAll();
        } else {
          updateSections(changedSections);
        }
      }
    }
    
    function updateSections(sections) {
      const updateMap = {
        'settings': () => renderSettings(),
        'people': () => renderPeople(), 
        'goals': () => renderGoals(),
        'rates': () => renderRatesTable(),
        'transactions': () => renderTransactions(),
        'charts': () => {
          buildGrowthChart();
          buildCompareChart(); 
          buildTimelineChart();
        },
        'kpis': () => {
          // Just update KPI values, don't re-render everything
          $('#kpiMonthlyIncome').textContent = fmtMoney(householdMonthlyIncome());
          $('#kpiCurrentSavings').textContent = fmtMoney(currentSavingsHousehold());
        }
      };
      
      sections.forEach(section => {
        if(updateMap[section]) {
          updateMap[section]();
        }
      });
    }
    
    function smartMerge(localData, importedData) {
      const merged = JSON.parse(JSON.stringify(localData)); // Deep copy
      
      // Compare timestamps and merge intelligently
      if(!localData.lastModified || !importedData.lastModified) {
        // No timestamps - ask user what to do
        return null; // Will trigger manual selection
      }
      
      const localTime = new Date(localData.lastModified);
      const importTime = new Date(importedData.lastModified);
      
      console.log('Local timestamp:', localTime);
      console.log('Import timestamp:', importTime);
      
      // Always merge - don't just rely on overall timestamp
      let hasChanges = false;
      
      // Merge settings (take imported if different)
      if(JSON.stringify(importedData.settings) !== JSON.stringify(localData.settings)) {
        merged.settings = importedData.settings;
        hasChanges = true;
      }
      
      // Merge people (by ID, add new ones, update existing if they have newer timestamps)
      importedData.people?.forEach(importedPerson => {
        const localPersonIndex = merged.people.findIndex(p => p.id === importedPerson.id);
        if(localPersonIndex >= 0) {
          // Person exists - check if imported version is newer
          const localTime = new Date(merged.people[localPersonIndex].lastModified || '1970-01-01');
          const importTime = new Date(importedPerson.lastModified || '1970-01-01');
          if(importTime >= localTime) {
            merged.people[localPersonIndex] = importedPerson;
            hasChanges = true;
          }
        } else {
          // New person, add it
          merged.people.push(importedPerson);
          hasChanges = true;
        }
      });
      
      // Merge transactions (add new ones, don't duplicate by ID)
      importedData.transactions?.forEach(importedTx => {
        if(!merged.transactions.find(t => t.id === importedTx.id)) {
          merged.transactions.push(importedTx);
          hasChanges = true;
        }
      });
      
      // Merge goals (by ID, add new ones, update existing if newer)
      importedData.goals?.forEach(importedGoal => {
        const localGoalIndex = merged.goals.findIndex(g => g.id === importedGoal.id);
        if(localGoalIndex >= 0) {
          // Goal exists - check if imported version is newer
          const localTime = new Date(merged.goals[localGoalIndex].lastModified || '1970-01-01');
          const importTime = new Date(importedGoal.lastModified || '1970-01-01');
          if(importTime >= localTime) {
            merged.goals[localGoalIndex] = importedGoal;
            hasChanges = true;
          }
        } else {
          // New goal, add it
          merged.goals.push(importedGoal);
          hasChanges = true;
        }
      });
      
      // Merge scenario rates if different
      if(JSON.stringify(importedData.scenarioRates) !== JSON.stringify(localData.scenarioRates)) {
        merged.scenarioRates = importedData.scenarioRates;
        hasChanges = true;
      }
      
      merged.lastModified = new Date().toISOString();
      
      console.log('Smart merge hasChanges:', hasChanges);
      console.log('Final merged data:', merged);
      
      return hasChanges ? merged : null; // Return null if no actual changes to trigger manual selection
    }

    /********** FINANCE HELPERS **********/
    function toMonthly(amount, freq){ const f=(freq||'').toLowerCase(); return (f==='yearly'||f==='annual'||f==='annually')? amount/12 : amount; }
    function totalMonthlyIncome(p){ return (p.incomes||[]).reduce((s,i)=> s + toMonthly(Number(i.amount||0), i.frequency||'monthly'), 0); }
    function totalMonthlyContribution(p, rate = null){ 
      const income = totalMonthlyIncome(p);
      const rateContrib = rate !== null ? income * (rate / 100) : income * ((appState.settings.currentRatePct || 0) / 100);
      const fixedContrib = Number(p.fixedMonthlyContribution || 0);
      return rateContrib + fixedContrib;
    }
    function householdMonthlyIncome(){ return appState.people.reduce((s,p)=> s + totalMonthlyIncome(p), 0); }
    function householdMonthlyContribution(rate = null){ return appState.people.reduce((s,p)=> s + totalMonthlyContribution(p, rate), 0); }
    function currentSavingsHousehold(){ return appState.people.reduce((s,p)=> s + Number(p.currentSavings||0),0); }
    function txTotal(){ return appState.transactions.reduce((s,t)=> s + Number(t.amount||0), 0); }
    function fmtMoney(x){ const {currency, locale} = appState.settings; if(!isFinite(x)) return 'â€”'; return new Intl.NumberFormat(locale||'en-PH', {style:'currency', currency:currency||'PHP'}).format(x); }
    function monthsBetween(from, to){ const f=new Date(from), t=new Date(to); if(isNaN(f)||isNaN(t)) return 0; let m=(t.getFullYear()-f.getFullYear())*12 + (t.getMonth()-f.getMonth()); if(t.getDate()>f.getDate()) m+=1; return Math.max(0,m); }
    function projectFV({principal=0, monthlyContribution=0, months=60, apyPct=0}){ const i=(apyPct||0)/100/12; if(i===0) return principal + monthlyContribution*months; return principal*Math.pow(1+i, months) + monthlyContribution*((Math.pow(1+i, months)-1)/i); }
    function adjustForInflation(nominal, months, inflationPct){ const j=(inflationPct||0)/100/12; if(j===0) return nominal; return nominal/Math.pow(1+j, months); }
    function monthsToReach({ current, monthlyContribution, target, apyPct }){ if(target<=current) return 0; const i=(apyPct||0)/100/12; let n=0, bal=current; while(n<1200 && bal<target){ bal=bal*(1+i)+monthlyContribution; n++; } return (bal>=target)? n : Infinity; }
    function formatMonthsToYearsMonths(months){ if(!Number.isFinite(months)) return 'â€”'; if(months === 0) return '0 mo'; const years = Math.floor(months / 12); const remainingMonths = months % 12; if(years === 0) return `${months} mo`; if(remainingMonths === 0) return `${years} yr${years > 1 ? 's' : ''}`; return `${years} yr${years > 1 ? 's' : ''} ${remainingMonths} mo`; }

    /********** DOM SHORTHANDS **********/
    const $ = (s)=> document.querySelector(s);
    const $all = (s)=> Array.from(document.querySelectorAll(s));

    /********** NAV UTILS **********/
    $('#printBtn').addEventListener('click', ()=> window.print());
    $('#resetBtn').addEventListener('click', ()=> { if(confirm('Reset to sample data? This will clear all your data.')){ appState = JSON.parse(JSON.stringify(defaultState)); saveState(); } });
    
    // Logout
    $('#logoutBtn').addEventListener('click', async () => {
      if(confirm('Are you sure you want to logout?')) {
        try {
          const authInstance = window.auth || auth;
          if (authInstance && authInstance.signOut) {
            await authInstance.signOut();
          }
          window.location.href = '/login.html';
        } catch (error) {
          console.error('Logout error:', error);
        }
      }
    });

    // Listen for tracker changes
    window.addEventListener('tracker-changed', async () => {
      if (trackerManager) {
        const authInstance = window.auth || auth;
        const SavingsAPIClass = window.SavingsAPI || SavingsAPI;
        if (authInstance && SavingsAPIClass) {
          api = new SavingsAPIClass(authInstance, trackerManager.currentTrackerId);
          trackerManager.api = api;
          await loadDataFromBackend();
          renderAll();
        }
      }
    });
    
    // Theme toggle
    function initTheme(){
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-bs-theme', savedTheme);
    }
    
    $('#themeToggle').addEventListener('click', ()=>{
      const current = document.documentElement.getAttribute('data-bs-theme') || 'dark';
      const newTheme = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-bs-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    });
    
    initTheme();
    
    // Sync banner functionality
    function checkForSyncOpportunity() {
      // Check if this looks like a fresh install or if user might want to sync
      const hasData = appState.people.length > 2 || appState.transactions.length > 3 || appState.goals.length > 3;
      const isFirstVisit = !localStorage.getItem('hasVisitedBefore');
      const syncDismissed = localStorage.getItem('syncBannerDismissed');
      
      // Show banner if: first visit with default data and hasn't been dismissed
      if(isFirstVisit && !hasData && !syncDismissed) {
        $('#syncBanner').style.display = 'flex';
        localStorage.setItem('hasVisitedBefore', 'true');
      }
    }
    
    $('#syncBannerImport').addEventListener('click', ()=>{
      // Jump to Settings tab and show import section
      const settingsTab = document.querySelector('[data-bs-target="#tabSettings"]');
      
      // Switch to settings tab
      bootstrap.Tab.getOrCreateInstance(settingsTab).show();
      
      // Show text import container (since that's the most reliable)
      $('#pasteTextBtn').click();
      
      // Hide banner
      $('#syncBanner').style.display = 'none';
    });
    
    $('#syncBannerDismiss').addEventListener('click', ()=>{
      $('#syncBanner').style.display = 'none';
      localStorage.setItem('syncBannerDismissed', 'true');
    });
    
    // Check for sync opportunity on load
    setTimeout(checkForSyncOpportunity, 1000); // Delay to let page settle

    /********** SETTINGS & KPIs **********/
    function renderSettings(){
      $('#currencyCode').value = appState.settings.currency;
      $('#localeSelect').value = appState.settings.locale;
      $('#currentRate').value = appState.settings.currentRatePct;
      $('#apy').value = appState.settings.apyPct;
      $('#inflation').value = appState.settings.inflationPct;

      // KPIs
      $('#kpiMonthlyIncome').textContent = fmtMoney(householdMonthlyIncome());
      $('#kpiCurrentSavings').textContent = fmtMoney(currentSavingsHousehold());
      $('#kpiSavingsRate').textContent = (appState.settings.currentRatePct||0).toFixed(1) + '%';
      $('#kpiApy').textContent = (appState.settings.apyPct||0).toFixed(1) + '%';
      $('#kpiInflation').textContent = (appState.settings.inflationPct||0).toFixed(1) + '%';
      
      // Enhanced KPIs
      renderEnhancedKPIs();
      renderGoalsGlance();
      renderSmartInsights();

      // Removed old chart chips since we replaced those charts

      // Owner/Tx selects
      renderOwnerOptions();
    }
    
    function renderEnhancedKPIs() {
      // Emergency Fund Ratio (Emergency fund goal vs 6 months expenses)
      const monthlyIncome = householdMonthlyIncome();
      const emergencyGoal = appState.goals.find(g => g.name.toLowerCase().includes('emergency'));
      if(emergencyGoal) {
        const allocated = goalAllocatedSavings(emergencyGoal.id);
        const unallocated = ownerUnallocatedSavings(emergencyGoal.owner);
        const current = allocated + unallocated;
        const monthsOfExpenses = monthlyIncome > 0 ? current / (monthlyIncome * 0.8) : 0; // Assume 80% of income is expenses
        $('#kpiEmergencyRatio').textContent = `${monthsOfExpenses.toFixed(1)} mo`;
      } else {
        $('#kpiEmergencyRatio').textContent = 'No EF Goal';
      }
      
      // Goals On Track
      const income = householdMonthlyIncome();
      const monthly = income * (appState.settings.currentRatePct||0)/100;
      const apy = appState.settings.apyPct||0;
      
      let onTrackCount = 0;
      appState.goals.forEach(g => {
        const monthsLeft = monthsBetween(new Date(), g.deadline);
        const cur = ownerSavings(g.owner);
        const eta = monthsToReach({ current: cur, monthlyContribution: monthly, target: g.target, apyPct: apy });
        if(isFinite(eta) && eta <= monthsLeft) onTrackCount++;
      });
      
      $('#kpiGoalsOnTrack').textContent = `${onTrackCount}/${appState.goals.length}`;
    }
    
    function renderGoalsGlance() {
      const container = $('#goalsGlance');
      if(appState.goals.length === 0) {
        container.innerHTML = '<div class="muted">No goals set yet</div>';
        return;
      }
      
      const income = householdMonthlyIncome();
      const monthly = income * (appState.settings.currentRatePct||0)/100;
      const apy = appState.settings.apyPct||0;
      
      const goalsHtml = appState.goals.slice()
        .sort((a,b) => (a.priority||999) - (b.priority||999))
        .slice(0, 4) // Show top 4 goals
        .map(g => {
          const allocated = goalAllocatedSavings(g.id);
          const unallocated = ownerUnallocatedSavings(g.owner);
          const current = allocated + unallocated;
          const progress = Math.min(100, (current / g.target) * 100);
          
          const monthsLeft = monthsBetween(new Date(), g.deadline);
          const eta = monthsToReach({ current: current, monthlyContribution: monthly, target: g.target, apyPct: apy });
          const isOnTrack = isFinite(eta) && eta <= monthsLeft;
          
          const statusEmoji = isOnTrack ? 'âœ…' : (isFinite(eta) ? 'âš ï¸' : 'âŒ');
          const statusText = isOnTrack ? 'On Track' : (isFinite(eta) ? 'Delayed' : 'At Risk');
          
          return `
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between">
                  <span class="small fw-semibold">${g.name}</span>
                  <span class="small">${progress.toFixed(0)}% ${statusEmoji}</span>
                </div>
                <div class="progress mt-1" style="height:4px;">
                  <div class="progress-bar" style="width:${progress}%"></div>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
      container.innerHTML = goalsHtml;
    }
    
    function renderSmartInsights() {
      const container = $('#smartInsights');
      const insights = [];
      
      const currentRate = appState.settings.currentRatePct || 0;
      const apy = appState.settings.apyPct || 0;
      const inflation = appState.settings.inflationPct || 0;
      const monthlyIncome = householdMonthlyIncome();
      const monthlySavings = monthlyIncome * (currentRate / 100);
      
      // Rate insight
      if(currentRate >= 15) {
        insights.push(`ğŸ‰ Excellent! You're saving ${currentRate}% - well above the recommended 10-15%.`);
      } else if(currentRate >= 10) {
        insights.push(`âœ… Good savings rate of ${currentRate}%. Consider pushing to 15% if possible.`);
      } else if(currentRate > 0) {
        insights.push(`ğŸ“ˆ Current ${currentRate}% rate is a start. Aim for 10-15% for optimal wealth building.`);
      }
      
      // APY vs Inflation
      if(apy < inflation) {
        insights.push(`âš ï¸ Your ${apy}% APY is below ${inflation}% inflation. Consider higher-yield options.`);
      } else if(apy > inflation + 2) {
        insights.push(`ğŸš€ Great! Your ${apy}% APY beats inflation by ${(apy - inflation).toFixed(1)}%.`);
      }
      
      // Goal progress insight
      if(appState.goals.length > 0) {
        const income = householdMonthlyIncome();
        const monthly = income * (currentRate/100);
        const nextGoal = appState.goals
          .map(g => {
            const cur = ownerSavings(g.owner);
            const eta = monthsToReach({ current: cur, monthlyContribution: monthly, target: g.target, apyPct: apy });
            return { ...g, eta };
          })
          .filter(g => isFinite(g.eta))
          .sort((a,b) => a.eta - b.eta)[0];
          
        if(nextGoal) {
          const timeText = formatMonthsToYearsMonths(nextGoal.eta);
          insights.push(`ğŸ¯ "${nextGoal.name}" will be complete in ${timeText} at current pace.`);
        }
      }
      
      // Recent activity insight
      const recentTx = appState.transactions.slice(0, 5);
      const totalRecent = recentTx.reduce((sum, t) => sum + t.amount, 0);
      if(totalRecent > monthlySavings * 1.2) {
        insights.push(`ğŸ”¥ You're ahead of your savings target this month! Keep it up.`);
      }
      
      if(insights.length === 0) {
        insights.push('ğŸ“Š Keep tracking your progress! Insights will appear as you add more data.');
      }
      
      container.innerHTML = insights.slice(0, 3).map(insight => 
        `<div class="small mb-2 p-2 rounded" style="background: var(--panel); border: 1px solid rgba(255,255,255,.08);">${insight}</div>`
      ).join('');
    }
    $('#saveSettingsBtn').addEventListener('click', async ()=>{
      const currency = $('#currencyCode').value;
      const locale = $('#localeSelect').value;
      const currentRatePct = Number($('#currentRate').value);
      const apyPct = Number($('#apy').value);
      const inflationPct = Number($('#inflation').value);
      if(currentRatePct<0 || apyPct<0 || inflationPct<0) return alert('Invalid negative value');
      
      try {
        appState.settings = { currency, locale, currentRatePct, apyPct, inflationPct };
        await api.updateSettings(appState.settings);
        saveState();
        alert('âœ… Settings saved successfully!');
      } catch (error) {
        alert('Failed to save settings: ' + error.message);
      }
    });
    
    // QR Code sync (no account required)
    $('#generateQRBtn').addEventListener('click', async ()=>{
      try {
        const compressedData = btoa(JSON.stringify(appState)); // Simple base64 encoding
        const qrContainer = $('#qrCodeContainer');
        const qrDisplay = $('#qrCodeDisplay');
        
        // Clear previous QR code
        qrDisplay.innerHTML = '';
        
        // Try multiple QR code generation methods
        let qrGenerated = false;
        
        // Method 1: Try qrcode-generator library
        if(typeof qrcode !== 'undefined') {
          try {
            const qr = qrcode(0, 'M');
            qr.addData(compressedData);
            qr.make();
            
            const size = Math.min(300, window.innerWidth - 100);
            const cellSize = Math.floor(size / qr.getModuleCount());
            const canvas = document.createElement('canvas');
            canvas.width = canvas.height = cellSize * qr.getModuleCount();
            const ctx = canvas.getContext('2d');
            
            // Set colors based on theme
            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
            const darkColor = isDark ? '#ffffff' : '#000000';
            const lightColor = isDark ? '#0f172a' : '#ffffff';
            
            for (let row = 0; row < qr.getModuleCount(); row++) {
              for (let col = 0; col < qr.getModuleCount(); col++) {
                ctx.fillStyle = qr.isDark(row, col) ? darkColor : lightColor;
                ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
              }
            }
            
            qrDisplay.appendChild(canvas);
            qrGenerated = true;
          } catch(e) {
            console.error('QR method 1 failed:', e);
          }
        }
        
        // Method 2: Fallback to Google Charts API
        if(!qrGenerated) {
          const size = Math.min(300, window.innerWidth - 100);
          const img = document.createElement('img');
          img.src = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(compressedData)}`;
          img.style.maxWidth = '100%';
          img.style.height = 'auto';
          img.onload = () => qrGenerated = true;
          img.onerror = () => {
            // Method 3: Ultimate fallback - show text only
            qrDisplay.innerHTML = '<div class="alert alert-warning">QR code generation failed. Use text method below.</div>';
          };
          qrDisplay.appendChild(img);
        }
        
        qrContainer.style.display = 'block';
        
        // Always show the text data for manual copy with copy button
        const textData = document.createElement('div');
        textData.className = 'mt-2';
        textData.innerHTML = `
          <small class="muted">Or copy this text:</small>
          <div class="d-flex gap-2 mt-1">
            <textarea class="form-control form-control-sm" readonly style="height:80px;font-size:12px;" id="qrDataText">${compressedData}</textarea>
            <button class="btn btn-outline-primary btn-sm" style="height:fit-content;" id="copyQRDataBtn">ğŸ“‹ Copy</button>
          </div>
        `;
        qrDisplay.appendChild(textData);
        
        // Add copy functionality
        document.getElementById('copyQRDataBtn').addEventListener('click', async () => {
          const textarea = document.getElementById('qrDataText');
          const btn = document.getElementById('copyQRDataBtn');
          
          try {
            await navigator.clipboard.writeText(textarea.value);
            
            // Success feedback
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ… Copied!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-primary');
            
            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.classList.remove('btn-success');
              btn.classList.add('btn-outline-primary');
            }, 2000);
            
          } catch (err) {
            // Fallback for older browsers
            textarea.select();
            document.execCommand('copy');
            
            btn.innerHTML = 'âœ… Copied!';
            setTimeout(() => {
              btn.innerHTML = 'ğŸ“‹ Copy';
            }, 2000);
          }
        });
        
      } catch(error) {
        alert('âŒ Failed to generate QR code: ' + error.message);
        console.error('QR Code Error:', error);
      }
    });
    
    // QR Scanner functionality
    let qrScanner = null;
    
    $('#scanCameraBtn').addEventListener('click', async ()=>{
      try {
        const video = $('#qrVideo');
        const container = $('#cameraContainer');
        
        // Hide other containers
        $('#uploadContainer').style.display = 'none';
        $('#textContainer').style.display = 'none';
        
        container.style.display = 'block';
        
        // Initialize camera for QR scanning
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          video.srcObject = stream;
          video.play();
          
          // Start scanning frames
          startQRDetection(video);
          
        } catch(cameraError) {
          throw new Error('Camera access denied or not available');
        }
      } catch(error) {
        alert('âŒ Camera access failed. Please use upload or paste options.');
        console.error('QR Scanner error:', error);
      }
    });
    
    $('#uploadImageBtn').addEventListener('click', ()=>{
      // Hide other containers
      $('#cameraContainer').style.display = 'none'; 
      $('#textContainer').style.display = 'none';
      
      const container = $('#uploadContainer');
      container.style.display = container.style.display === 'none' ? 'block' : 'none';
    });
    
    $('#pasteTextBtn').addEventListener('click', ()=>{
      // Hide other containers
      $('#cameraContainer').style.display = 'none';
      $('#uploadContainer').style.display = 'none';
      
      const container = $('#textContainer');
      container.style.display = container.style.display === 'none' ? 'block' : 'none';
      if(container.style.display === 'block') {
        $('#importData').focus();
      }
    });
    
    $('#stopScanBtn').addEventListener('click', stopQRScanning);
    
    function stopQRScanning() {
      const video = $('#qrVideo');
      if(video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      if(qrScanner) {
        clearInterval(qrScanner);
        qrScanner = null;
      }
      $('#cameraContainer').style.display = 'none';
    }
    
    function startQRDetection(video) {
      if(typeof jsQR === 'undefined') {
        alert('QR scanning library not available. Please use "ğŸ“ Paste Text" option.');
        return;
      }
      
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      
      qrScanner = setInterval(() => {
        if(video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.height = video.videoHeight;
          canvas.width = video.videoWidth;
          context.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          
          if(code) {
            handleQRScanResult(code.data);
            stopQRScanning();
          }
        }
      }, 300); // Check every 300ms
    }
    
    // Drag and Drop functionality
    const dragDropZone = $('#dragDropZone');
    const fileInput = $('#qrImageFile');
    
    // Click to browse
    dragDropZone.addEventListener('click', () => {
      fileInput.click();
    });
    
    // Drag and drop events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dragDropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dragDropZone.addEventListener(eventName, () => {
        dragDropZone.classList.add('drag-over');
      });
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dragDropZone.addEventListener(eventName, () => {
        dragDropZone.classList.remove('drag-over');
      });
    });
    
    dragDropZone.addEventListener('drop', handleDrop);
    
    function handleDrop(e) {
      const files = e.dataTransfer.files;
      if(files.length > 0) {
        handleImageFile(files[0]);
      }
    }
    
    // File input change (browse button)
    $('#qrImageFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if(file) {
        handleImageFile(file);
      }
    });
    
    async function handleImageFile(file) {
      // Validate file type
      if(!file.type.startsWith('image/')) {
        alert('âŒ Please upload an image file (JPG, PNG, WebP)');
        return;
      }
      
      // Show loading state
      const originalContent = dragDropZone.innerHTML;
      dragDropZone.innerHTML = `
        <div class="drag-drop-content">
          <div class="spinner-border text-primary" role="status"></div>
          <div class="mt-2">Reading QR code...</div>
        </div>
      `;
      
      try {
        if(typeof jsQR !== 'undefined') {
          // Use canvas to process the image
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = img.width;
            canvas.height = img.height;
            context.drawImage(img, 0, 0);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if(code) {
              // Success feedback
              dragDropZone.innerHTML = `
                <div class="drag-drop-content">
                  <div class="drag-drop-icon">âœ…</div>
                  <div class="text-success">QR code detected! Importing data...</div>
                </div>
              `;
              
              setTimeout(() => {
                handleQRScanResult(code.data);
                dragDropZone.innerHTML = originalContent;
              }, 1000);
            } else {
              throw new Error('No QR code found in image');
            }
          };
          
          img.onerror = () => {
            throw new Error('Could not load image');
          };
          
          img.src = URL.createObjectURL(file);
          
        } else {
          throw new Error('QR scanning library not available');
        }
      } catch(error) {
        console.error('QR Image scan error:', error);
        
        // Enhanced error feedback with manual decode option
        dragDropZone.innerHTML = `
          <div class="drag-drop-content">
            <div class="drag-drop-icon">âŒ</div>
            <div class="text-warning">Could not auto-read QR code</div>
            <small class="text-muted">The image might be blurry or the QR library failed</small>
            <div class="mt-2">
              <button class="btn btn-info btn-sm" id="showImageDecodeBtn">ğŸ” Try Manual Decode</button>
              <button class="btn btn-secondary btn-sm" id="switchToTextBtn">ğŸ“ Use Text Instead</button>
            </div>
          </div>
        `;
        
        // Add manual decode helper
        document.getElementById('showImageDecodeBtn').addEventListener('click', () => {
          dragDropZone.innerHTML = `
            <div class="drag-drop-content">
              <div class="text-info mb-2">ğŸ“– Manual QR Decode Instructions:</div>
              <div class="small text-start">
                <ol>
                  <li>Use your phone's camera app to scan the QR code</li>
                  <li>Most phones auto-detect QR codes and show the text</li>
                  <li>Copy the revealed text</li>
                  <li>Click "ğŸ“ Paste Text" and paste it there</li>
                </ol>
                <div class="mt-2 text-center">
                  <button class="btn btn-primary btn-sm" id="goToTextBtn">ğŸ“ Go to Text Import</button>
                </div>
              </div>
            </div>
          `;
          
          document.getElementById('goToTextBtn').addEventListener('click', () => {
            dragDropZone.innerHTML = originalContent;
            $('#uploadContainer').style.display = 'none';
            $('#pasteTextBtn').click();
          });
        });
        
        document.getElementById('switchToTextBtn').addEventListener('click', () => {
          dragDropZone.innerHTML = originalContent;
          $('#uploadContainer').style.display = 'none';
          $('#pasteTextBtn').click();
        });
        
        setTimeout(() => {
          if(dragDropZone.innerHTML.includes('Could not auto-read')) {
            dragDropZone.innerHTML = originalContent;
          }
        }, 8000);
      }
    }
    
    function handleQRScanResult(data) {
      // Process the scanned QR data
      $('#importData').value = data;
      $('#importDataBtn').click(); // Trigger import
    }
    
    $('#importDataBtn').addEventListener('click', ()=>{
      try {
        const data = $('#importData').value.trim();
        if(!data) return alert('Please paste the QR code data');
        
        // Try to decode the data
        let importedState;
        try {
          // Try base64 decode first
          importedState = JSON.parse(atob(data));
        } catch {
          // If that fails, try direct JSON parse
          importedState = JSON.parse(data);
        }
        
        // Validate the data structure
        if(!importedState.settings || !Array.isArray(importedState.people) || !Array.isArray(importedState.goals)) {
          throw new Error('Invalid data format');
        }
        
        // Show import options - let user decide
        const importChoice = confirm(`ğŸ“Š Import Options:
        
OK = REPLACE all your data with imported data
Cancel = MERGE (add new items, keep existing ones)

Imported data contains:
â€¢ ${importedState.people?.length || 0} people
â€¢ ${importedState.goals?.length || 0} goals  
â€¢ ${importedState.transactions?.length || 0} transactions

Choose OK to replace, Cancel to merge.`);
        
        if(importChoice) {
          // REPLACE - Use imported data completely
          console.log('Replacing with imported data:', JSON.stringify(importedState, null, 2));
          
          appState = importedState;
          appState.lastModified = new Date().toISOString();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
          
          setTimeout(() => {
            renderAll();
            alert('âœ… Data replaced successfully! Check the Dashboard tab.');
          }, 100);
          
        } else {
          // MERGE - Add imported items to existing data
          console.log('Merging imported data with existing...');
          
          // Add new people (different IDs)
          importedState.people?.forEach(importedPerson => {
            if(!appState.people.find(p => p.id === importedPerson.id)) {
              appState.people.push(importedPerson);
            }
          });
          
          // Add new goals (different IDs)
          importedState.goals?.forEach(importedGoal => {
            if(!appState.goals.find(g => g.id === importedGoal.id)) {
              appState.goals.push(importedGoal);
            }
          });
          
          // Add new transactions (different IDs)
          importedState.transactions?.forEach(importedTx => {
            if(!appState.transactions.find(t => t.id === importedTx.id)) {
              appState.transactions.push(importedTx);
            }
          });
          
          // Update scenario rates
          if(importedState.scenarioRates) {
            appState.scenarioRates = [...new Set([...appState.scenarioRates, ...importedState.scenarioRates])].sort((a,b) => a-b);
          }
          
          appState.lastModified = new Date().toISOString();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
          
          setTimeout(() => {
            renderAll();
            alert('âœ… Data merged successfully! New items added. Check the Dashboard tab.');
          }, 100);
        }
        
        $('#importData').value = '';
        $('#textContainer').style.display = 'none';
        
      } catch(error) {
        alert('âŒ Failed to import data: ' + error.message);
      }
    });

    /********** PEOPLE **********/
    function renderOwnerOptions(){
      const s = '<option>Household</option>' + appState.people.map(p=> `<option>${p.name}</option>`).join('');
      $('#goalOwner').innerHTML = s;
      $('#txPerson').innerHTML = appState.people.map(p=> `<option>${p.name}</option>`).join('');
    }
    function findPersonById(id){ return appState.people.find(x=> x.id===id); }

    function renderPeople(){
      const host = $('#peopleList'); host.innerHTML='';
      appState.people.forEach(p=>{
        const col = document.createElement('div'); col.className='col-12';
        const monthly = totalMonthlyIncome(p);
        const fixedContrib = Number(p.fixedMonthlyContribution || 0);
        const incomes = (p.incomes||[]).map(i => `
          <tr>
            <td><input class="form-control form-control-sm" value="${i.label}" data-ptype="incomeLabel" data-pid="${p.id}" data-iid="${i.id}" /></td>
            <td class="text-end" style="width:160px"><input class="form-control form-control-sm" type="number" step="0.01" value="${i.amount}" data-ptype="incomeAmount" data-pid="${p.id}" data-iid="${i.id}" /></td>
            <td style="width:140px">
              <select class="form-select form-select-sm" data-ptype="incomeFreq" data-pid="${p.id}" data-iid="${i.id}">
                <option ${i.frequency==='monthly'?'selected':''}>monthly</option>
                <option ${['yearly','annual','annually'].includes(i.frequency)?'selected':''}>yearly</option>
              </select>
            </td>
            <td class="text-end"><button class="btn btn-sm btn-ghost" data-act="delIncome" data-pid="${p.id}" data-iid="${i.id}">Delete</button></td>
          </tr>
        `).join('');

        col.innerHTML = `
          <div class="card p-3">
            <div class="row g-3 align-items-end">
              <div class="col-md-4">
                <label class="form-label">Name</label>
                <input class="form-control" value="${p.name}" data-ptype="name" data-pid="${p.id}" />
              </div>
              <div class="col-md-2">
                <label class="form-label">Current Savings</label>
                <input class="form-control" type="number" step="0.01" value="${p.currentSavings}" data-ptype="savings" data-pid="${p.id}" />
              </div>
              <div class="col-md-2">
                <label class="form-label">Fixed Monthly</label>
                <input class="form-control" type="number" step="0.01" value="${fixedContrib}" data-ptype="fixedContrib" data-pid="${p.id}" />
                <small class="text-muted">Fixed amount</small>
              </div>
              <div class="col-md-3">
                <div class="muted">Monthly Contribution</div>
                <div class="fs-6 fw-bold">
                  ${monthly > 0 ? `${fmtMoney(monthly)} (rate-based)` : ''}
                  ${fixedContrib > 0 ? `${fmtMoney(fixedContrib)} (fixed)` : ''}
                  ${monthly === 0 && fixedContrib === 0 ? 'No income/contribution set' : ''}
                </div>
              </div>
              <div class="col-md-2 d-flex gap-2">
                <button class="btn btn-ghost w-50" data-act="addIncome" data-pid="${p.id}">+ Income</button>
                <button class="btn btn-outline-danger w-50" data-act="delPerson" data-pid="${p.id}">Delete</button>
              </div>
            </div>
            <div class="table-responsive mt-3">
              <table class="table table-sm align-middle">
                <thead><tr><th>Label</th><th class="text-end">Amount</th><th>Frequency</th><th></th></tr></thead>
                <tbody>${incomes || '<tr><td colspan="4" class="muted">No incomes yet.</td></tr>'}</tbody>
              </table>
            </div>
          </div>
        `;
        host.appendChild(col);
      });

      // Bind changes
      $all('#peopleList [data-ptype]').forEach(el=>{
        el.addEventListener('change', async e=>{
          const pid = e.target.dataset.pid;
          const type = e.target.dataset.ptype;
          const p = findPersonById(pid); if(!p) return;
          if(type==='name') { p.name = e.target.value.trim()||'Person'; }
          if(type==='savings'){ const v=Number(e.target.value); if(!isFinite(v)||v<0) return alert('Invalid'); p.currentSavings=v; }
          if(type==='fixedContrib'){ const v=Number(e.target.value); if(!isFinite(v)||v<0) return alert('Invalid'); p.fixedMonthlyContribution=v; }
          if(type==='incomeLabel' || type==='incomeAmount' || type==='incomeFreq'){
            const inc = p.incomes.find(i=> i.id===e.target.dataset.iid); if(!inc) return;
            if(type==='incomeLabel') inc.label = e.target.value.trim()||'Income';
            if(type==='incomeAmount'){ const v=Number(e.target.value); if(!isFinite(v)||v<0) return alert('Invalid'); inc.amount=v; }
            if(type==='incomeFreq'){ const v=(e.target.value||'monthly').toLowerCase(); inc.frequency = ['monthly','yearly','annual','annually'].includes(v)? v : 'monthly'; }
          }
          // Save to backend
          try {
            await api.updatePerson(p);
            saveState();
          } catch (error) {
            console.error('Error updating person:', error);
            saveState(); // Still update UI
          }
        });
      });
      $all('#peopleList [data-act="addIncome"]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const p = findPersonById(btn.dataset.pid); if(!p) return;
        p.incomes.push({ id:uid(), label:'Income', amount:0, frequency:'monthly' });
        try {
          await api.updatePerson(p);
          saveState();
        } catch (error) {
          console.error('Error adding income:', error);
          saveState();
        }
      }));
      $all('#peopleList [data-act="delIncome"]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const p = findPersonById(btn.dataset.pid); if(!p) return;
        p.incomes = (p.incomes||[]).filter(i=> i.id!==btn.dataset.iid);
        try {
          await api.updatePerson(p);
          saveState();
        } catch (error) {
          console.error('Error deleting income:', error);
          saveState();
        }
      }));
      $all('#peopleList [data-act="delPerson"]').forEach(btn=> btn.addEventListener('click', async ()=>{
        if(!confirm('Delete person and their incomes?')) return;
        const pid = btn.dataset.pid;
        const name = (appState.people.find(x=>x.id===pid)||{}).name;
        try {
          await api.deletePerson(pid);
          appState.people = appState.people.filter(x=> x.id!==pid);
          // reassign goals/transactions
          appState.goals = appState.goals.map(g => g.owner===name ? {...g, owner:'Household'} : g);
          appState.transactions = appState.transactions.map(t => t.person===name ? {...t, person:'(Removed)'} : t);
          saveState();
        } catch (error) {
          alert('Failed to delete person: ' + error.message);
        }
      }));
    }
    $('#addPersonBtn').addEventListener('click', async ()=>{
      const name = ($('#personName').value||'').trim()||'Person';
      const sav = Number($('#personSavings').value||0); if(!isFinite(sav)||sav<0) return alert('Invalid savings');
      const fixedContrib = Number($('#personFixedContribution').value||0); if(!isFinite(fixedContrib)||fixedContrib<0) return alert('Invalid fixed contribution');
      
      try {
        const newPerson = {
          id: uid(),
          name,
          currentSavings: sav,
          fixedMonthlyContribution: fixedContrib,
          incomes: []
        };
        
        await api.createPerson(newPerson);
        appState.people.push(newPerson);
        
        $('#personName').value=''; $('#personSavings').value=''; $('#personFixedContribution').value='';
        saveState();
      } catch (error) {
        alert('Failed to add person: ' + error.message);
      }
    });

    /********** GOALS **********/
    function ownerSavings(owner){
      if(owner==='Household') return currentSavingsHousehold();
      const p = appState.people.find(x=> x.name===owner);
      return p ? Number(p.currentSavings||0) : 0;
    }
    
    function goalAllocatedSavings(goalId) {
      // Calculate savings allocated specifically to this goal
      return appState.transactions
        .filter(t => t.goalId === goalId)
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);
    }
    
    function ownerUnallocatedSavings(owner) {
      // Calculate savings not allocated to any specific goal
      const totalSavings = ownerSavings(owner);
      const allocatedSavings = appState.transactions
        .filter(t => t.goalId && (owner === 'Household' || t.person === owner))
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);
      return Math.max(0, totalSavings - allocatedSavings);
    }
    function renderGoals(){
      renderOwnerOptions();
      // list
      const host = $('#goalsList'); host.innerHTML='';
      appState.goals.slice().sort((a,b)=>(a.priority||999)-(b.priority||999)).forEach(g=>{
        const monthsLeft = monthsBetween(new Date(), g.deadline);
        const allocatedSavings = goalAllocatedSavings(g.id);
        const totalOwnerSavings = ownerSavings(g.owner);
        const unallocatedSavings = ownerUnallocatedSavings(g.owner);
        
        // Use allocated savings + available unallocated for progress
        const cur = allocatedSavings + (g.owner === 'Household' ? unallocatedSavings : unallocatedSavings);
        const pct = Math.min(100, cur/Math.max(1,g.target)*100);
        const need = Math.max(0, g.target - cur);
        const req = monthsLeft? need/monthsLeft : Infinity;
        const col = document.createElement('div'); col.className='col-12';
        col.innerHTML = `
          <div class="card p-3">
            <div class="row g-3 align-items-end">
              <div class="col-md-3"><label class="form-label">Goal</label><input class="form-control" value="${g.name}" data-gbind="name" data-gid="${g.id}"/></div>
              <div class="col-md-2"><label class="form-label">Target</label><input class="form-control" type="number" step="0.01" value="${g.target}" data-gbind="target" data-gid="${g.id}"/></div>
              <div class="col-md-2"><label class="form-label">Deadline</label><input class="form-control" type="date" value="${g.deadline}" data-gbind="deadline" data-gid="${g.id}"/></div>
              <div class="col-md-3"><label class="form-label">Owner</label>
                <select class="form-select" data-gbind="owner" data-gid="${g.id}">
                  <option ${g.owner==='Household'?'selected':''}>Household</option>
                  ${appState.people.map(p=> `<option ${g.owner===p.name?'selected':''}>${p.name}</option>`).join('')}
                </select>
              </div>
              <div class="col-md-1"><label class="form-label">Priority</label><input class="form-control" type="number" value="${g.priority||1}" min="1" data-gbind="priority" data-gid="${g.id}"/></div>
              <div class="col-md-1 d-grid"><button class="btn btn-outline-danger" data-act="delGoal" data-gid="${g.id}">Delete</button></div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-6">
                <div class="bar"><div style="width:${pct}%"></div></div>
                <div class="muted mt-1">
                  <div><strong>${fmtMoney(cur)} / ${fmtMoney(g.target)}</strong> (${pct.toFixed(0)}%)</div>
                  <div class="small mt-1">
                    ${allocatedSavings > 0 ? 
                      `ğŸ¯ Allocated: ${fmtMoney(allocatedSavings)} | ğŸ’° Available: ${fmtMoney(unallocatedSavings)}` : 
                      `ğŸ’° Available from general savings: ${fmtMoney(unallocatedSavings)}`
                    }
                  </div>
                </div>
              </div>
              <div class="col-md-3"><span class="chip">Time left: <b>${formatMonthsToYearsMonths(monthsLeft)}</b></span></div>
              <div class="col-md-3"><span class="chip">Required / mo: <b>${isFinite(req)?fmtMoney(req):'â€”'}</b></span></div>
            </div>
          </div>`;
        host.appendChild(col);
      });

      // binds
      $all('#goalsList [data-gbind]').forEach(el=>{
        el.addEventListener('change', async e=>{
          const gid=e.target.dataset.gid; const k=e.target.dataset.gbind;
          const g=appState.goals.find(x=>x.id===gid); if(!g) return;
          if(k==='name') g.name=e.target.value.trim()||'Goal';
          if(k==='target'){ const v=Number(e.target.value); if(!isFinite(v)||v<=0) return alert('Invalid'); g.target=v; }
          if(k==='deadline'){ if(!e.target.value) return alert('Invalid'); g.deadline=e.target.value; }
          if(k==='owner') g.owner=e.target.value;
          if(k==='priority'){ const v=Math.max(1, Math.floor(Number(e.target.value||1))); g.priority=v; }
          // Save to backend
          try {
            await api.updateGoal(g);
            saveState();
          } catch (error) {
            console.error('Error updating goal:', error);
            saveState(); // Still update UI
          }
        });
      });
      $all('#goalsList [data-act="delGoal"]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const gid = btn.dataset.gid;
        try {
          await api.deleteGoal(gid);
          appState.goals = appState.goals.filter(x=> x.id!==gid);
          saveState();
        } catch (error) {
          alert('Failed to delete goal: ' + error.message);
        }
      }));

      renderGoalsRequired();
    }
    $('#addGoalBtn').addEventListener('click', async ()=>{
      const name=($('#goalName').value||'').trim()||'Goal';
      const target=Number($('#goalTarget').value); if(!isFinite(target)||target<=0) return alert('Invalid target');
      const deadline=$('#goalDeadline').value; if(!deadline) return alert('Set a deadline');
      const owner=$('#goalOwner').value||'Household';
      const priority=Math.max(1, Math.floor(Number($('#goalPriority').value||1)));
      
      try {
        const newGoal = { id:uid(), name, target, deadline, owner, priority };
        await api.createGoal(newGoal);
        appState.goals.push(newGoal);
        
        $('#goalName').value=''; $('#goalTarget').value=''; $('#goalDeadline').value=''; $('#goalPriority').value='1';
        saveState();
      } catch (error) {
        alert('Failed to add goal: ' + error.message);
      }
    });

    function renderGoalsRequired(){
      const host = $('#goalsRequiredList'); host.innerHTML='';
      const rate = (appState.settings.currentRatePct||0)/100;
      const monthly = householdMonthlyIncome() * rate;
      const apy = appState.settings.apyPct||0;
      appState.goals.slice().sort((a,b)=>(a.priority||999)-(b.priority||999)).forEach(g=>{
        const monthsLeft = monthsBetween(new Date(), g.deadline);
        const cur = ownerSavings(g.owner);
        const need = Math.max(0, g.target - cur);
        const required = monthsLeft? need/monthsLeft : Infinity;
        const eta = monthsToReach({ current: cur, monthlyContribution: monthly, target: g.target, apyPct: apy });
        const col = document.createElement('div'); col.className='col-12';
        col.innerHTML = `
          <div class="card p-3">
            <div class="row g-3 align-items-center">
              <div class="col-md-6"><b>${g.name}</b> <span class="chip">Owner: ${g.owner}</span> <span class="chip">Priority: ${g.priority||1}</span>
                <div class="muted">Target ${fmtMoney(g.target)} â€¢ Current ${fmtMoney(cur)} â€¢ Time left ${formatMonthsToYearsMonths(monthsLeft)}</div>
              </div>
              <div class="col-md-3">
                <div class="muted">Required / mo</div>
                <div class="fs-6 fw-semibold">${isFinite(required)?fmtMoney(required):'â€”'}</div>
              </div>
              <div class="col-md-3">
                <div class="muted">ETA at plan</div>
                <div class="fs-6 fw-semibold">${isFinite(eta)? formatMonthsToYearsMonths(eta) : 'Not reachable'}</div>
              </div>
            </div>
          </div>`;
        host.appendChild(col);
      });
    }

    /********** RATES (per-person process) - OPTIMIZED TABLE FOR DECISION MAKING **********/
    function renderRatesTable(){
      const tbody = $('#ratesTable tbody');
      tbody.innerHTML = '';

      const principal = currentSavingsHousehold();
      const apy = appState.settings.apyPct || 0;
      const householdIncome = householdMonthlyIncome();
      
      // Header info elements were removed in UI redesign - skip this

      appState.scenarioRates.forEach(r => {
        const rate = Number(r) || 0;
        const isCurrentRate = rate === (appState.settings.currentRatePct || 0);

        // Filter to only selected contributors
        const selectedPeople = appState.people.filter(p => 
          scenarioFilters.selectedContributors.includes(p.id)
        );

        // Perâ€‘person contributions (rate-based + fixed) - only selected people
        const rows = selectedPeople.map(p => {
          const inc = totalMonthlyIncome(p);
          const rateBasedContrib = inc * (rate / 100);
          const fixedContrib = Number(p.fixedMonthlyContribution || 0);
          const totalContrib = rateBasedContrib + fixedContrib;
          
          return { 
            name: p.name, 
            contribution: totalContrib,
            rateBased: rateBasedContrib,
            fixed: fixedContrib,
            type: fixedContrib > 0 ? 'mixed' : 'rate-only'
          };
        });
        const monthlyTotal = rows.reduce((s, x) => s + x.contribution, 0);

        // Projections
        const fv2 = projectFV({ principal, monthlyContribution: monthlyTotal, months: 24, apyPct: apy });
        const fv5 = projectFV({ principal, monthlyContribution: monthlyTotal, months: 60, apyPct: apy });

        // Goal analysis - only for selected goals
        const selectedGoals = appState.goals.filter(g => 
          scenarioFilters.selectedGoals.includes(g.id)
        );
        const perGoal = selectedGoals.map(g => {
          const cur = ownerSavings(g.owner);
          const monthsLeft = monthsBetween(new Date(), g.deadline);
          const eta = monthsToReach({
            current: cur,
            monthlyContribution: monthlyTotal,
            target: g.target,
            apyPct: apy
          });
          const onTime = Number.isFinite(eta) && eta <= monthsLeft;
          return { name: g.name, deadline: g.deadline, monthsLeft, eta, onTime };
        });

        const onTimeCount = perGoal.filter(g => g.onTime).length;
        const totalGoals = perGoal.length;
        
        // Determine status and recommendation
        let statusBadge, keyImpact, recommendation;
        
        if(onTimeCount === totalGoals && totalGoals > 0) {
          statusBadge = '<span class="badge bg-success">âœ… All Goals</span>';
          keyImpact = `All ${totalGoals} goals achievable on time`;
          recommendation = isCurrentRate ? '<span class="badge bg-primary">Current Plan</span>' : '<span class="badge bg-success">ğŸ‘ Recommended</span>';
        } else if(onTimeCount > 0) {
          statusBadge = `<span class="badge bg-warning">âš ï¸ ${onTimeCount}/${totalGoals}</span>`;
          const atRiskGoals = totalGoals - onTimeCount;
          keyImpact = `${atRiskGoals} goal${atRiskGoals > 1 ? 's' : ''} at risk`;
          recommendation = '<span class="badge bg-warning">âš ï¸ Partial Risk</span>';
        } else {
          statusBadge = '<span class="badge bg-danger">âŒ High Risk</span>';
          keyImpact = totalGoals > 0 ? 'No goals achievable on time' : 'No goals set';
          recommendation = '<span class="badge bg-danger">âŒ Insufficient</span>';
        }

        // Enhanced breakdown for details
        const collapseId = 'breakdown-' + rate;
        const contributionDetails = `
          <div class="row">
            <div class="col-md-6">
              <h6 class="mb-2">ğŸ‘¥ Monthly Contributions</h6>
              <div class="list-group list-group-flush">
                ${rows.map(pr => `
                  <div class="list-group-item d-flex justify-content-between align-items-center py-2 border-0">
                    <div>
                      <span>${pr.name}</span>
                      ${pr.type === 'mixed' ? `<br><small class="text-muted">${fmtMoney(pr.rateBased)} (${rate}%) + ${fmtMoney(pr.fixed)} (fixed)</small>` : ''}
                    </div>
                    <span class="badge bg-primary">${fmtMoney(pr.contribution)}</span>
                  </div>
                `).join('')}
                <div class="list-group-item d-flex justify-content-between align-items-center py-2 border-0 fw-bold">
                  <span>Total Household</span>
                  <span class="badge bg-success">${fmtMoney(monthlyTotal)}</span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <h6 class="mb-2">ğŸ¯ Goal Timeline</h6>
              ${totalGoals > 0 ? `
                <div class="list-group list-group-flush">
                  ${perGoal.map(g => {
                    const statusIcon = g.onTime ? 'âœ…' : (Number.isFinite(g.eta) ? 'âš ï¸' : 'âŒ');
                    const etaText = Number.isFinite(g.eta) ? formatMonthsToYearsMonths(g.eta) : 'Not reachable';
                    return `
                      <div class="list-group-item d-flex justify-content-between align-items-center py-2 border-0">
                        <span>${statusIcon} ${g.name}</span>
                        <small class="text-muted">${etaText}</small>
                      </div>
                    `;
                  }).join('')}
                </div>
              ` : '<div class="text-muted">No goals set</div>'}
            </div>
          </div>
        `;

        const tr = document.createElement('tr');
        tr.className = isCurrentRate ? 'table-primary' : '';
        tr.innerHTML = `
          <td>
            <div class="d-flex align-items-center gap-2">
              <span class="fw-bold fs-5">${rate}%</span>
              ${isCurrentRate ? '<span class="badge bg-primary">Current</span>' : ''}
            </div>
          </td>
          <td>
            <div class="fw-semibold">${fmtMoney(monthlyTotal)}</div>
            <small class="text-muted">${fmtMoney(monthlyTotal * 12)}/year</small>
          </td>
          <td class="fw-semibold text-primary">${fmtMoney(fv2)}</td>
          <td class="fw-semibold text-success">${fmtMoney(fv5)}</td>
          <td>${statusBadge}</td>
          <td class="small">${keyImpact}</td>
          <td>
            <div class="d-flex flex-column gap-1">
              ${recommendation}
              <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                ğŸ“‹ Details
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);

        // Add collapsible details row
        const detailsRow = document.createElement('tr');
        detailsRow.innerHTML = `
          <td colspan="7" class="p-0">
            <div class="collapse" id="${collapseId}">
              <div class="card card-body m-3">
                ${contributionDetails}
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(detailsRow);
      });
    }
    $('#refreshRatesBtn').addEventListener('click', ()=>{
      const nums = ($('#scenarioRates').value||'').split(',').map(s=> Number(s.trim())).filter(x=> isFinite(x)&&x>=0);
      if(!nums.length) return alert('Enter valid rates (e.g., 5,10,15,20)');
      
      // Show loading state
      const btn = $('#refreshRatesBtn');
      const originalText = btn.innerHTML;
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Calculating...';
      
      // Simulate calculation time for better UX
      setTimeout(() => {
        appState.scenarioRates = nums; 
        saveState();
        
        // Reset button state
        btn.disabled = false;
        btn.innerHTML = originalText;
      }, 500);
    });
    
    $('#exportRatesExcelBtn').addEventListener('click', ()=>{
      const principal = currentSavingsHousehold();
      const apy = appState.settings.apyPct || 0;
      const householdIncome = householdMonthlyIncome();
      
      // Create comprehensive Excel-compatible CSV
      const lines = [];
      
      // Header information
      lines.push('Savings Rate Scenarios Analysis');
      lines.push(`Generated: ${new Date().toLocaleString()}`);
      lines.push(`Household Monthly Income: ${fmtMoney(householdIncome)}`);
      lines.push(`Current Savings: ${fmtMoney(principal)}`);
      lines.push(`APY: ${apy}%`);
      lines.push('');
      
      // Summary table
      lines.push('Rate,Monthly Total,Annual Total,2-Year Value,5-Year Value,Goals On Track,Status');
      
      appState.scenarioRates.forEach(r => {
        const rate = Number(r) || 0;
        
        // Calculate totals
        const rows = appState.people.map(p => {
          const inc = totalMonthlyIncome(p);
          return { name: p.name, contribution: inc * (rate / 100) };
        });
        const monthlyTotal = rows.reduce((s, x) => s + x.contribution, 0);
        const annual = monthlyTotal * 12;
        const fv2 = projectFV({ principal, monthlyContribution: monthlyTotal, months: 24, apyPct: apy });
        const fv5 = projectFV({ principal, monthlyContribution: monthlyTotal, months: 60, apyPct: apy });
        
        // Goal analysis
        const perGoal = appState.goals.map(g => {
          const cur = ownerSavings(g.owner);
          const monthsLeft = monthsBetween(new Date(), g.deadline);
          const eta = monthsToReach({
            current: cur,
            monthlyContribution: monthlyTotal,
            target: g.target,
            apyPct: apy
          });
          const onTime = Number.isFinite(eta) && eta <= monthsLeft;
          return { name: g.name, onTime, eta };
        });
        
        const onTimeCount = perGoal.filter(g => g.onTime).length;
        const status = onTimeCount === perGoal.length ? 'All Goals Achievable' : 
                      onTimeCount > 0 ? 'Some Goals At Risk' : 'Goals Not Achievable';
        
        lines.push(`${rate}%,${monthlyTotal.toFixed(2)},${annual.toFixed(2)},${fv2.toFixed(2)},${fv5.toFixed(2)},${onTimeCount}/${perGoal.length},${status}`);
      });
      
      lines.push('');
      lines.push('Detailed Breakdown by Person');
      lines.push('');
      
      // Person contribution breakdown for each rate
      appState.scenarioRates.forEach(r => {
        const rate = Number(r) || 0;
        lines.push(`Savings Rate: ${rate}%`);
        lines.push('Person,Monthly Income,Contribution Amount,Contribution %');
        
        appState.people.forEach(p => {
          const income = totalMonthlyIncome(p);
          const contribution = income * (rate / 100);
          const contributionPct = income > 0 ? ((contribution / income) * 100).toFixed(1) : 0;
          lines.push(`${p.name},${income.toFixed(2)},${contribution.toFixed(2)},${contributionPct}%`);
        });
        
        const totalContribution = appState.people.reduce((sum, p) => sum + (totalMonthlyIncome(p) * (rate / 100)), 0);
        lines.push(`Total Household,,${totalContribution.toFixed(2)},${rate}%`);
        lines.push('');
      });
      
      // Goal impact analysis
      lines.push('Goal Impact Analysis');
      lines.push('');
      
      appState.scenarioRates.forEach(r => {
        const rate = Number(r) || 0;
        const monthlyTotal = appState.people.reduce((sum, p) => sum + (totalMonthlyIncome(p) * (rate / 100)), 0);
        
        lines.push(`Rate: ${rate}% (Monthly: ${fmtMoney(monthlyTotal)})`);
        lines.push('Goal,Target,Current,Months Left,ETA (months),Status,Gap to Target');
        
        appState.goals.forEach(g => {
          const cur = ownerSavings(g.owner);
          const monthsLeft = monthsBetween(new Date(), g.deadline);
          const eta = monthsToReach({
            current: cur,
            monthlyContribution: monthlyTotal,
            target: g.target,
            apyPct: apy
          });
          const onTime = Number.isFinite(eta) && eta <= monthsLeft;
          const status = onTime ? 'On Track' : (Number.isFinite(eta) ? `Late by ${eta - monthsLeft} months` : 'Not Reachable');
          const gap = Math.max(0, g.target - cur);
          
          lines.push(`${g.name},${g.target.toFixed(2)},${cur.toFixed(2)},${monthsLeft},${Number.isFinite(eta) ? eta.toFixed(1) : 'N/A'},${status},${gap.toFixed(2)}`);
        });
        lines.push('');
      });
      
      // Download the file
      const csvContent = lines.join('\n');
      download(`savings_rate_scenarios_${ts()}.csv`, csvContent, 'text/csv');
    });

    /********** TRANSACTIONS **********/
    $('#addTxBtn').addEventListener('click', async ()=>{
      const btn = $('#addTxBtn');
      const date = $('#txDate').value || new Date().toISOString().slice(0,10);
      const amt = Number($('#txAmount').value||0); 
      
      if(!isFinite(amt)||amt<=0) {
        // Better error feedback
        $('#txAmount').classList.add('is-invalid');
        setTimeout(() => $('#txAmount').classList.remove('is-invalid'), 2000);
        return;
      }
      
      const person = $('#txPerson').value || (appState.people[0]?.name || 'Household');
      const note = ($('#txNote').value||'').trim();
      const goalId = $('#txGoal').value || null;
      
      // Show loading state
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
      
      try {
        const newTx = { id:uid(), date, person, amount:amt, note, goalId };
        await api.createTransaction(newTx);
        
        appState.transactions.unshift(newTx);
        
        // Update person's current savings
        const p = appState.people.find(x => x.name === person);
        if(p) {
          p.currentSavings = (p.currentSavings || 0) + amt;
          await api.updatePerson(p); // Save updated person
        }
        
        $('#txAmount').value=''; $('#txNote').value=''; $('#txGoal').value = '';
        $('#goalSuggestion').style.display = 'none';
        
        // Success feedback
        btn.classList.add('btn-success');
        btn.innerHTML = 'âœ… Added!';
        
        setTimeout(() => {
          btn.classList.remove('btn-success');
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 1000);
        
        saveState();
      } catch (error) {
        alert('Failed to add transaction: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    });
    
    // Add smart suggestions when amount changes
    $('#txAmount').addEventListener('input', (e) => {
      const amount = Number(e.target.value || 0);
      showGoalSuggestion(amount);
    });

    function renderTransactions(){
      // summary
      $('#txTotal').textContent = fmtMoney(txTotal());
      const last30 = appState.transactions.filter(t => (new Date() - new Date(t.date)) <= 30*86400000).reduce((s,t)=> s+t.amount,0);
      $('#txLast30').textContent = fmtMoney(last30);
      const totalsByPerson = {};
      appState.transactions.forEach(t=> totalsByPerson[t.person]=(totalsByPerson[t.person]||0)+t.amount);
      const top = Object.entries(totalsByPerson).sort((a,b)=> b[1]-a[1])[0];
      $('#txTopPerson').textContent = top ? `${top[0]} (${fmtMoney(top[1])})` : 'â€”';

      // person select
      $('#txPerson').innerHTML = appState.people.map(p=> `<option>${p.name}</option>`).join('');
      
      // goal select
      renderGoalOptions();

      // table
      const tb = $('#txTable tbody'); tb.innerHTML='';
      appState.transactions.slice().sort((a,b)=> b.date.localeCompare(a.date)).forEach(t=>{
        const tr = document.createElement('tr');
        const goal = t.goalId ? appState.goals.find(g => g.id === t.goalId) : null;
        const goalDisplay = goal ? 
          `<span class="badge bg-primary">${goal.name}</span>` : 
          '<span class="badge bg-secondary">General</span>';
          
        tr.innerHTML = `
          <td>${t.date}</td>
          <td>${t.person}</td>
          <td class="text-end">${fmtMoney(t.amount)}</td>
          <td>${goalDisplay}</td>
          <td>${t.note||''}</td>
          <td class="text-end">
            <div class="d-flex gap-1">
              <button class="btn btn-sm btn-outline-primary" data-edit-tx="${t.id}">Edit</button>
              <button class="btn btn-sm btn-ghost" data-del-tx="${t.id}">Delete</button>
            </div>
          </td>
        `;
        tb.appendChild(tr);
      });
      $all('[data-del-tx]').forEach(btn=> btn.addEventListener('click', ()=>{
        // Find the transaction to get person and amount before deleting
        const tx = appState.transactions.find(x=> x.id===btn.dataset.delTx);
        if(tx) {
          // Update person's current savings (subtract the transaction amount)
          const p = appState.people.find(x => x.name === tx.person);
          if(p) {
            p.currentSavings = (p.currentSavings || 0) - tx.amount;
          }
        }
        
        appState.transactions = appState.transactions.filter(x=> x.id!==btn.dataset.delTx); 
        saveState();
      }));
      
      // Add edit transaction functionality
      $all('[data-edit-tx]').forEach(btn=> btn.addEventListener('click', ()=>{
        const txId = btn.dataset.editTx;
        const tx = appState.transactions.find(t => t.id === txId);
        if(!tx) return;
        
        // Create edit modal/form
        const editHtml = `
          <div class="modal fade" id="editTxModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">âœï¸ Edit Transaction</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Date</label>
                      <input class="form-control" id="editTxDate" type="date" value="${tx.date}"/>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Amount</label>
                      <input class="form-control" id="editTxAmount" type="number" step="0.01" value="${tx.amount}"/>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Person</label>
                      <select class="form-select" id="editTxPerson">
                        ${appState.people.map(p => `<option ${p.name === tx.person ? 'selected' : ''}>${p.name}</option>`).join('')}
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Goal</label>
                      <select class="form-select" id="editTxGoal">
                        <option value="" ${!tx.goalId ? 'selected' : ''}>ğŸ’° General Savings</option>
                        ${appState.goals.map(g => `<option value="${g.id}" ${g.id === tx.goalId ? 'selected' : ''}>${g.name}</option>`).join('')}
                      </select>
                    </div>
                    <div class="col-12">
                      <label class="form-label">Note</label>
                      <input class="form-control" id="editTxNote" value="${tx.note || ''}"/>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" id="saveTxEdit">ğŸ’¾ Save Changes</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('editTxModal');
        if(existingModal) existingModal.remove();
        
        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', editHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editTxModal'));
        modal.show();
        
        // Handle save
        document.getElementById('saveTxEdit').addEventListener('click', () => {
          const newDate = $('#editTxDate').value;
          const newAmount = Number($('#editTxAmount').value);
          const newPerson = $('#editTxPerson').value;
          const newGoalId = $('#editTxGoal').value || null;
          const newNote = $('#editTxNote').value.trim();
          
          if(!newDate || !isFinite(newAmount) || newAmount <= 0) {
            alert('Please fill in valid date and amount');
            return;
          }
          
          // Update person's savings (remove old amount, add new amount)
          const oldPerson = appState.people.find(p => p.name === tx.person);
          const newPersonObj = appState.people.find(p => p.name === newPerson);
          
          if(oldPerson) {
            oldPerson.currentSavings = (oldPerson.currentSavings || 0) - tx.amount;
          }
          if(newPersonObj) {
            newPersonObj.currentSavings = (newPersonObj.currentSavings || 0) + newAmount;
          }
          
          // Update transaction
          tx.date = newDate;
          tx.amount = newAmount;
          tx.person = newPerson;
          tx.goalId = newGoalId;
          tx.note = newNote;
          tx.lastModified = new Date().toISOString();
          
          saveState();
          modal.hide();
          
          // Success feedback
          const btn = document.querySelector(`[data-edit-tx="${txId}"]`);
          if(btn) {
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = 'âœ… Saved!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-primary');
            
            setTimeout(() => {
              btn.innerHTML = originalBtnText;
              btn.classList.remove('btn-success');
              btn.classList.add('btn-outline-primary');
            }, 2000);
          }
        });
      }));

      buildTxCharts();
    }
    
    function renderGoalOptions() {
      const goalSelect = $('#txGoal');
      // Keep the default "General Savings" option
      let options = '<option value="">ğŸ’° General Savings (No specific goal)</option>';
      
      // Add goals sorted by priority  
      appState.goals.slice()
        .sort((a,b) => (a.priority||999) - (b.priority||999))
        .forEach(g => {
          const allocated = goalAllocatedSavings(g.id);
          const needed = Math.max(0, g.target - allocated - ownerUnallocatedSavings(g.owner));
          const emoji = g.name.toLowerCase().includes('emergency') ? 'ğŸ ' :
                       g.name.toLowerCase().includes('vacation') ? 'ğŸ–ï¸' :
                       g.name.toLowerCase().includes('house') ? 'ğŸ˜ï¸' : 'ğŸ¯';
          
          options += `<option value="${g.id}">${emoji} ${g.name} (needs ${fmtMoney(needed)})</option>`;
        });
        
      goalSelect.innerHTML = options;
    }
    
    function showGoalSuggestion(amount) {
      if (!amount || amount < 1000) {
        $('#goalSuggestion').style.display = 'none';
        return;
      }
      
      // Find best goal suggestion based on priority and amount
      const sortedGoals = appState.goals.slice()
        .sort((a,b) => (a.priority||999) - (b.priority||999))
        .map(g => {
          const allocated = goalAllocatedSavings(g.id);
          const unallocated = ownerUnallocatedSavings(g.owner);
          const needed = Math.max(0, g.target - allocated - unallocated);
          return { ...g, needed, allocated };
        });
      
      const suggestion = sortedGoals.find(g => g.needed > 0 && amount >= g.needed * 0.1);
      
      if (suggestion) {
        const percentage = ((amount / suggestion.needed) * 100).toFixed(0);
        $('#suggestionText').textContent = `Consider "${suggestion.name}" (${percentage}% of remaining need, high priority)`;
        $('#goalSuggestion').style.display = 'block';
      } else {
        $('#goalSuggestion').style.display = 'none';
      }
    }

    /********** EXPORT / IMPORT **********/
    function download(filename, content, mime='text/plain'){
      const blob=new Blob([content],{type:mime}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
    }
    function ts(){ const d=new Date(); return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}_${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}${String(d.getSeconds()).padStart(2,'0')}`; }

    $('#exportJsonBtn').addEventListener('click', ()=> download(`savings_${ts()}.json`, JSON.stringify(appState,null,2), 'application/json'));
    $('#exportCsvPeopleBtn').addEventListener('click', ()=>{
      const lines = ['Person,Income Label,Amount,Frequency,Current Savings,Total Monthly Income'];
      appState.people.forEach(p=>{
        const totalM = totalMonthlyIncome(p);
        if(!(p.incomes||[]).length){ lines.push(`"${p.name}",,0,monthly,${p.currentSavings},${totalM}`); }
        else p.incomes.forEach(i => lines.push(`"${p.name}","${String(i.label).replaceAll('"','""')}",${i.amount},${i.frequency},${p.currentSavings},${totalM}`));
      });
      download(`people_${ts()}.csv`, lines.join('\n'), 'text/csv');
    });
    $('#exportCsvGoalsBtn').addEventListener('click', ()=>{
      const lines = ['Goal,Target,Deadline,Owner,Priority,Months Left,Required Monthly'];
      appState.goals.forEach(g=>{
        const ml = monthsBetween(new Date(), g.deadline);
        const cur = ownerSavings(g.owner);
        const need = Math.max(0, g.target - cur);
        const req = ml? (need/ml) : '';
        lines.push([`"${String(g.name).replaceAll('"','""')}"`, g.target, g.deadline, `"${g.owner}"`, g.priority, ml, (isFinite(req)? req.toFixed(2):'')].join(','));
      });
      download(`goals_${ts()}.csv`, lines.join('\n'), 'text/csv');
    });
    $('#exportCsvTxBtn').addEventListener('click', ()=>{
      const lines = ['Date,Person,Amount,Note'];
      appState.transactions.forEach(t=> lines.push([t.date, `"${t.person}"`, t.amount, `"${(t.note||'').replaceAll('"','""')}"`].join(',')));
      download(`transactions_${ts()}.csv`, lines.join('\n'), 'text/csv');
    });
    $('#importBtn').addEventListener('click', ()=>{
      const f = $('#importFile').files[0]; if(!f) return alert('Choose a JSON file.');
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const obj = JSON.parse(reader.result);
          if(!obj.settings || !Array.isArray(obj.people) || !Array.isArray(obj.goals) || !Array.isArray(obj.transactions)) throw new Error('Invalid schema');
          appState = obj; saveState(); alert('Import successful.');
        } catch(e){ alert('Import failed: '+e.message); }
      };
      reader.readAsText(f);
    });

    /********** CHARTS **********/
    let contributionChart, consistencyChart, timelineChart, txChart, txChart2, txStackedChart, monthlyContributionChart;
    
    function buildContributionChart(){
      const ctx = $('#contributionChart'); if(contributionChart) contributionChart.destroy();
      
      // Calculate contribution breakdown for each person
      const personStats = appState.people.map(person => {
        const personTx = appState.transactions.filter(t => t.person === person.name);
        const goalTx = personTx.filter(t => t.goalId);
        const generalTx = personTx.filter(t => !t.goalId);
        
        const goalAmount = goalTx.reduce((sum, t) => sum + t.amount, 0);
        const generalAmount = generalTx.reduce((sum, t) => sum + t.amount, 0);
        const total = goalAmount + generalAmount;
        
        return {
          name: person.name,
          goalAmount,
          generalAmount,
          total,
          goalPercent: total > 0 ? (goalAmount / total * 100).toFixed(1) : 0,
          generalPercent: total > 0 ? (generalAmount / total * 100).toFixed(1) : 0
        };
      }).filter(p => p.total > 0);
      
      if(personStats.length === 0) {
        $('#contributionSummary').innerHTML = '<div class="text-muted small">No transactions yet</div>';
        return;
      }
      
      // Update contribution summary
      const summaryHtml = personStats.map(p => 
        `<div class="small">
          <strong>${p.name}</strong>: ${p.goalPercent}% goals â€¢ ${p.generalPercent}% general 
          <span class="text-muted">(${fmtMoney(p.total)} total)</span>
        </div>`
      ).join('');
      $('#contributionSummary').innerHTML = summaryHtml;
      
      // Create stacked bar chart
      const labels = personStats.map(p => p.name);
      const goalData = personStats.map(p => p.goalAmount);
      const generalData = personStats.map(p => p.generalAmount);
      
      contributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Goal-Specific',
              data: goalData,
              backgroundColor: '#10b981',
              stack: 'contributions'
            },
            {
              label: 'General Savings', 
              data: generalData,
              backgroundColor: '#6b7280',
              stack: 'contributions'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { 
              stacked: true,
              ticks: {
                callback: function(value) {
                  return fmtMoney(value);
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const person = personStats[context.dataIndex];
                  const isGoal = context.datasetIndex === 0;
                  const percent = isGoal ? person.goalPercent : person.generalPercent;
                  return `${context.dataset.label}: ${fmtMoney(context.parsed.y)} (${percent}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    function buildConsistencyChart(){
      const ctx = $('#consistencyChart'); if(consistencyChart) consistencyChart.destroy();
      
      // Get last 12 months of savings data
      const now = new Date();
      const months = [];
      for(let i = 11; i >= 0; i--) {
        months.push(new Date(now.getFullYear(), now.getMonth() - i, 1));
      }
      
      const monthLabels = months.map(d => d.toLocaleString(appState.settings.locale, {month:'short', year:'2-digit'}));
      const monthlySavings = months.map(month => {
        const monthKey = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`;
        return appState.transactions
          .filter(t => t.date.slice(0,7) === monthKey)
          .reduce((sum, t) => sum + t.amount, 0);
      });
      
      // Calculate target monthly savings
      const targetMonthly = householdMonthlyIncome() * ((appState.settings.currentRatePct || 0) / 100);
      const targetLine = Array(12).fill(targetMonthly);
      
      consistencyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [
            {
              label: 'Actual Savings',
              data: monthlySavings,
              borderColor: '#59a2ff',
              backgroundColor: 'rgba(89, 162, 255, 0.1)',
              fill: true,
              tension: 0.3
            },
            {
              label: 'Target',
              data: targetLine,
              borderColor: '#10b981',
              borderDash: [5, 5],
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  const target = targetMonthly;
                  const diff = value - target;
                  const diffText = diff > 0 ? `(+${fmtMoney(diff)} over target)` : diff < 0 ? `(${fmtMoney(Math.abs(diff))} under target)` : '(on target)';
                  return `${context.dataset.label}: ${fmtMoney(value)} ${context.dataset.label === 'Actual Savings' ? diffText : ''}`;
                }
              }
            }
          },
          scales: {
            y: {
              ticks: {
                callback: function(value) {
                  return fmtMoney(value);
                }
              }
            }
          }
        }
      });
    }
    function buildTimelineChart(){
      const ctx = $('#timelineChart'); if(timelineChart) timelineChart.destroy();
      const income = householdMonthlyIncome();
      const monthly = income * (appState.settings.currentRatePct||0)/100;
      const apy = appState.settings.apyPct||0;
      const labels = appState.goals.map(g=> g.name);
      const dataInMonths = appState.goals.map(g=> {
        const cur = ownerSavings(g.owner);
        const m = monthsToReach({ current: cur, monthlyContribution: monthly, target: g.target, apyPct: apy });
        return isFinite(m)? m : 120;
      });
      
      // Convert months to years for display
      const dataInYears = dataInMonths.map(m => m / 12);
      const maxYears = Math.max(1, Math.ceil(Math.max(...dataInYears)));
      
      timelineChart = new Chart(ctx, { 
        type:'bar', 
        data:{ labels, datasets:[{label:'Years to Complete', data: dataInYears, backgroundColor:'#59a2ff'}] },
        options:{ 
          indexAxis:'y', 
          plugins:{
            legend:{display:false},
            tooltip: {
              callbacks: {
                label: (context) => {
                  const years = context.parsed.x;
                  const months = Math.round((years % 1) * 12);
                  const fullYears = Math.floor(years);
                  
                  if(fullYears === 0) return `${Math.round(years * 12)} months`;
                  if(months === 0) return `${fullYears} year${fullYears > 1 ? 's' : ''}`;
                  return `${fullYears} year${fullYears > 1 ? 's' : ''} ${months} month${months > 1 ? 's' : ''}`;
                }
              }
            }
          }, 
          scales:{
            x:{
              suggestedMax: maxYears + 0.5,
              ticks: {
                callback: function(value) {
                  if(value < 1) return `${Math.round(value * 12)}mo`;
                  if(value % 1 === 0) return `${value}yr`;
                  return `${Math.floor(value)}.${Math.round((value % 1) * 10)}yr`;
                }
              }
            }
          } 
        }
      });
    }
    
    function buildMonthlyContributionChart(){
      const ctx = $('#monthlyContributionChart'); if(monthlyContributionChart) monthlyContributionChart.destroy();
      
      // Get last 6 months of data
      const now = new Date();
      const months = [];
      for(let i = 5; i >= 0; i--) {
        months.push(new Date(now.getFullYear(), now.getMonth() - i, 1));
      }
      
      const monthLabels = months.map(d => d.toLocaleString(appState.settings.locale, {month:'short', year:'2-digit'}));
      const personNames = appState.people.map(p => p.name);
      const colors = ['#10b981', '#59a2ff', '#8a7dff', '#f59e0b', '#ef4444', '#06b6d4'];
      
      // Build datasets for each person
      const datasets = personNames.map((person, idx) => {
        const data = months.map(month => {
          const monthKey = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`;
          return appState.transactions
            .filter(t => t.person === person && t.date.slice(0,7) === monthKey)
            .reduce((sum, t) => sum + t.amount, 0);
        });
        
        return {
          label: person,
          data: data,
          backgroundColor: colors[idx % colors.length],
          stack: 'contributions'
        };
      });
      
      monthlyContributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: monthLabels,
          datasets: datasets
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { 
              stacked: true,
              ticks: {
                callback: function(value) {
                  return fmtMoney(value);
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${fmtMoney(context.parsed.y)}`;
                },
                footer: function(tooltipItems) {
                  const monthIndex = tooltipItems[0].dataIndex;
                  const month = months[monthIndex];
                  const monthKey = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`;
                  
                  // Check who didn't contribute
                  const contributors = new Set();
                  appState.transactions.forEach(t => {
                    if(t.date.slice(0,7) === monthKey) {
                      contributors.add(t.person);
                    }
                  });
                  
                  const nonContributors = personNames.filter(person => !contributors.has(person));
                  if(nonContributors.length > 0) {
                    return `No contributions: ${nonContributors.join(', ')}`;
                  }
                  return 'Everyone contributed! ğŸ‰';
                }
              }
            }
          }
        }
      });
      
      // Update contribution streak and table
      updateContributionStreak();
      updateContributionTable();
    }
    
    function updateContributionStreak() {
      const now = new Date();
      const streakData = appState.people.map(person => {
        let currentStreak = 0;
        let longestStreak = 0;
        let tempStreak = 0;
        
        // Check last 12 months
        for(let i = 11; i >= 0; i--) {
          const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const monthKey = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`;
          
          const hasContribution = appState.transactions.some(t => 
            t.person === person.name && t.date.slice(0,7) === monthKey
          );
          
          if(hasContribution) {
            tempStreak++;
            if(i === 0) currentStreak = tempStreak; // Current month streak
          } else {
            longestStreak = Math.max(longestStreak, tempStreak);
            tempStreak = 0;
            if(i === 0) currentStreak = 0;
          }
        }
        longestStreak = Math.max(longestStreak, tempStreak);
        
        return { person: person.name, currentStreak, longestStreak };
      });
      
      const streakHtml = `
        <div class="small mb-2">
          <strong>ğŸ”¥ Contribution Streaks</strong>
        </div>
        ${streakData.map(s => `
          <div class="d-flex justify-content-between small mb-1">
            <span>${s.person}</span>
            <span>${s.currentStreak} mo current ${s.currentStreak >= 3 ? 'ğŸ”¥' : s.currentStreak >= 1 ? 'âœ…' : 'ğŸ˜´'}</span>
          </div>
        `).join('')}
      `;
      
      $('#contributionStreak').innerHTML = streakHtml;
    }
    
    function updateContributionTable() {
      const now = new Date();
      const tableData = [];
      
      // Get last 3 months for detailed view
      for(let i = 2; i >= 0; i--) {
        const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthKey = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`;
        const monthName = month.toLocaleString(appState.settings.locale, {month:'short'});
        
        const monthData = { month: monthName, people: {} };
        
        appState.people.forEach(person => {
          const contribution = appState.transactions
            .filter(t => t.person === person.name && t.date.slice(0,7) === monthKey)
            .reduce((sum, t) => sum + t.amount, 0);
          
          monthData.people[person.name] = contribution;
        });
        
        tableData.push(monthData);
      }
      
      const tableHtml = `
        <div class="small mb-2">
          <strong>ğŸ“Š Recent Months</strong>
        </div>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th style="font-size:0.75rem;">Month</th>
                ${appState.people.map(p => `<th class="text-center" style="font-size:0.75rem;">${p.name.slice(0,3)}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${tableData.map(row => `
                <tr>
                  <td class="small">${row.month}</td>
                  ${appState.people.map(person => {
                    const amount = row.people[person.name];
                    const status = amount > 0 ? 'âœ…' : 'âŒ';
                    const displayAmount = amount > 0 ? fmtMoney(amount).replace(/[â‚±$â‚¬Â¥Â£]/g, '').slice(0,4) : '0';
                    return `<td class="text-center small">${status}<br><span style="font-size:0.7rem;">${displayAmount}</span></td>`;
                  }).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      $('#contributionTable').innerHTML = tableHtml;
    }
    
    function buildTxCharts(){
      // recent totals (on dashboard and on tx tab)
      const now = new Date(); const months=[]; for(let i=5;i>=0;i--){ months.push(new Date(now.getFullYear(), now.getMonth()-i, 1)); }
      function key(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
      const monthLabels = months.map(d=> d.toLocaleString(appState.settings.locale, {month:'short', year:'2-digit'}));
      const mk = months.map(m=> key(m));
      const sums = mk.map(k => appState.transactions.filter(t=> t.date.slice(0,7)===k).reduce((s,t)=> s+t.amount, 0));

      if(txChart) txChart.destroy();
      txChart = new Chart($('#txChart'), { type:'bar', data:{ labels: monthLabels, datasets:[{label:'Total saved', data:sums, backgroundColor:'#10b981'}] }, options:{plugins:{legend:{display:false}}} });

      if(txChart2) txChart2.destroy();
      txChart2 = new Chart($('#txChart2'), { type:'bar', data:{ labels: monthLabels, datasets:[{label:'Total saved', data:sums, backgroundColor:'#10b981'}] }, options:{plugins:{legend:{display:false}}} });

      // stacked by person
      const persons = appState.people.map(p=> p.name);
      const colors = ['#8a7dff','#59a2ff','#10b981','#f59e0b','#ef4444','#06b6d4'];
      const ds = persons.map((name,idx)=>({
        label:name,
        data: mk.map(k=> appState.transactions.filter(t=> t.person===name && t.date.slice(0,7)===k).reduce((a,b)=> a+b.amount,0)),
        backgroundColor: colors[idx%colors.length]
      }));
      if(txStackedChart) txStackedChart.destroy();
      txStackedChart = new Chart($('#txStackedChart'), { type:'bar', data:{ labels: monthLabels, datasets: ds }, options:{ scales:{ x:{stacked:true}, y:{stacked:true} } } });
    }

    /********** CHECKBOX SCENARIO FILTERS **********/
    let scenarioFilters = {
      selectedContributors: [],
      selectedGoals: []
    };
    
    function renderScenarioFilters() {
      renderContributorsFilter();
      renderGoalsFilter();
    }
    
    function renderContributorsFilter() {
      const container = $('#contributorsFilter');
      if(!container) return;
      
      // Default to all contributors selected
      if(scenarioFilters.selectedContributors.length === 0) {
        scenarioFilters.selectedContributors = appState.people.map(p => p.id);
      }
      
      const html = appState.people.map(person => {
        const fixed = Number(person.fixedMonthlyContribution || 0);
        const isSelected = scenarioFilters.selectedContributors.includes(person.id);
        
        return `
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" ${isSelected ? 'checked' : ''} 
                   id="contrib-${person.id}" data-person-id="${person.id}">
            <label class="form-check-label" for="contrib-${person.id}">
              <strong>${person.name}</strong>
              <br><small class="text-muted">${fixed > 0 ? `Fixed: ${fmtMoney(fixed)}/month` : 'Rate-based'}</small>
            </label>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
      
      // Add event listeners
      container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateContributorSelection);
      });
    }
    
    function renderGoalsFilter() {
      const container = $('#goalsFilter');
      if(!container) return;
      
      // Default to all goals selected
      if(scenarioFilters.selectedGoals.length === 0) {
        scenarioFilters.selectedGoals = appState.goals.map(g => g.id);
      }
      
      const html = appState.goals.map(goal => {
        const monthsLeft = monthsBetween(new Date(), goal.deadline);
        const isSelected = scenarioFilters.selectedGoals.includes(goal.id);
        
        return `
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" ${isSelected ? 'checked' : ''}
                   id="goal-${goal.id}" data-goal-id="${goal.id}">
            <label class="form-check-label" for="goal-${goal.id}">
              <strong>${goal.name}</strong>
              <br><small class="text-muted">${fmtMoney(goal.target)} â€¢ ${formatMonthsToYearsMonths(monthsLeft)} left</small>
            </label>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
      
      // Add event listeners
      container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateGoalSelection);
      });
    }
    
    function updateContributorSelection(e) {
      const personId = e.target.dataset.personId;
      if(e.target.checked) {
        if(!scenarioFilters.selectedContributors.includes(personId)) {
          scenarioFilters.selectedContributors.push(personId);
        }
      } else {
        scenarioFilters.selectedContributors = scenarioFilters.selectedContributors.filter(id => id !== personId);
      }
      // Auto-refresh scenarios when selection changes
      setTimeout(renderRatesTable, 100);
    }
    
    function updateGoalSelection(e) {
      const goalId = e.target.dataset.goalId;
      if(e.target.checked) {
        if(!scenarioFilters.selectedGoals.includes(goalId)) {
          scenarioFilters.selectedGoals.push(goalId);
        }
      } else {
        scenarioFilters.selectedGoals = scenarioFilters.selectedGoals.filter(id => id !== goalId);
      }
      // Auto-refresh scenarios when selection changes
      setTimeout(renderRatesTable, 100);
    }
    
    /********** RENDER ALL **********/
    function renderAll(){
      renderSettings();
      renderPeople();
      renderGoals();
      renderRatesTable();
      renderTransactions();
      buildContributionChart();
      buildConsistencyChart();
      buildTimelineChart();
      buildMonthlyContributionChart();
      renderScenarioFilters();
    }

    // Re-render scenario filters when Rate Scenarios tab is opened
    document.addEventListener('shown.bs.tab', function (e) {
      if(e.target.getAttribute('data-bs-target') === '#tabRates') {
        console.log('Rate Scenarios tab opened - rendering filters');
        setTimeout(() => {
          renderScenarioFilters();
          renderRatesTable();
        }, 100);
      }
    });
    
    // Note: renderAll() is called automatically after initializeApp() completes

  </script>

</body>
</html>
