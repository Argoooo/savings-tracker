<!DOCTYPE html>

<html lang="en">
<head>
<script>
  // âš ï¸ CRITICAL EARLY DIAGNOSTIC - Runs BEFORE everything else
  (function() {
    console.log('%cğŸ”´ EARLY DIAGNOSTIC START', 'color: red; font-size: 16px; font-weight: bold;');
    console.log('ğŸ”´ URL:', window.location.href);
    console.log('ğŸ”´ Hash:', window.location.hash);
    console.log('ğŸ”´ Document ready state:', document.readyState);
    console.log('ğŸ”´ Timestamp:', new Date().toISOString());
    
    // Track DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ”´ DOM Content Loaded');
      });
    } else {
      console.log('ğŸ”´ DOM already loaded');
    }
    
    // Track page load
    window.addEventListener('load', function() {
      console.log('ğŸ”´ Window Load event fired');
    });
    
    // Track errors
    window.addEventListener('error', function(e) {
      console.error('ğŸ”´ WINDOW ERROR:', e.message, 'at', e.filename + ':' + e.lineno);
    });
    
    // Track promise rejections
    window.addEventListener('unhandledrejection', function(e) {
      console.error('ğŸ”´ UNHANDLED PROMISE:', e.reason);
    });
    
    console.log('ğŸ”´ Early diagnostic complete - scripts should load next');
  })();
</script>
<meta charset="utf-8"/>
<title>Savings Dashboard â€” Bootstrap Edition</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<!-- Bootstrap 5.3 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
    :root {
      --bg-light: #ffffff;
      --bg-dark: #0f172a;
      --panel-light: #f8f9fa;
      --panel-dark: #111827;
      --text-light: #212529;
      --text-dark: #ffffff;
      --muted-light: #6c757d;
      --muted-dark: #a6b0c0;
      --ok: #10b981; --warn: #f59e0b; --brand: #59a2ff; --brand2:#8a7dff;
    }
    
    [data-bs-theme="light"] {
      --bg: var(--bg-light);
      --panel: var(--panel-light);
      --text: var(--text-light);
      --muted: var(--muted-light);
    }
    
    [data-bs-theme="dark"] {
      --bg: var(--bg-dark);
      --panel: var(--panel-dark);
      --text: var(--text-dark);
      --muted: var(--muted-dark);
    }
    body {
      background:
        radial-gradient(1000px 600px at 120% -10%, rgba(89,162,255,.18), transparent 60%),
        radial-gradient(900px 500px at -10% -10%, rgba(138,125,255,.18), transparent 60%),
        var(--bg);
      color: var(--text);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    [data-bs-theme="light"] .card {
      background: var(--panel);
      border: 1px solid #dee2e6;
      box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
    }
    
    [data-bs-theme="dark"] .card {
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), #0b1220;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
    }
    [data-bs-theme="light"] .chip {
      display:inline-flex; gap:.5rem; align-items:center;
      padding:.35rem .6rem; border-radius:999px; background:#e9ecef; border:1px solid #dee2e6;
      color:#495057;
      font-size:.85rem;
    }
    
    [data-bs-theme="dark"] .chip {
      display:inline-flex; gap:.5rem; align-items:center;
      padding:.35rem .6rem; border-radius:999px; background:#1b2232; border:1px solid rgba(255,255,255,.09);
      color:#bcd;
      font-size:.85rem;
    }
    .bar { height:10px; background:#101827; border:1px solid rgba(255,255,255,.08); border-radius:999px; overflow:hidden; }
    .bar > div { height:100%; background: linear-gradient(90deg, var(--ok), var(--brand)); }
    .muted { color: var(--muted); }
    .kpi .value { font-weight:800; font-size:1.2rem; }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,.08); }
    .table thead th { color:#9fb2d7; }
    .nav-pills .nav-link.active { background: linear-gradient(90deg, var(--brand2), var(--brand)); }
    @media print {
      .no-print, header, .nav, .navbar { display:none !important; }
      body { background:#fff; color:#000; }
      .card { background:#fff !important; border:1px solid #ddd !important; box-shadow:none !important; }
    }
    
    /* Sync notification banner */
    .sync-banner {
      background: linear-gradient(90deg, var(--brand2), var(--brand));
      color: white;
      padding: 0.5rem 1rem;
      display: none;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
    }
    .sync-banner .sync-actions { display: flex; gap: 0.5rem; align-items: center; }
    .sync-banner .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
    
    /* Modern Rate Scenarios Design */
    .scenario-card {
      transition: all 0.2s ease;
      border-radius: 12px;
    }
    .scenario-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,.15);
    }
    .scenario-card.border-primary {
      border-width: 2px;
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    .metric-box {
      text-align: center;
      padding: 1rem;
      background: var(--panel);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .metric-label {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 0.25rem;
    }
    .metric-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--brand);
    }
    .goals-preview {
      background: rgba(89, 162, 255, 0.05);
      border-radius: 8px;
      padding: 0.75rem;
      border-left: 3px solid var(--brand);
    }
    
    /* Enhanced buttons and interactions */
    .btn {
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    .btn-lg {
      padding: 0.75rem 1.5rem;
      font-weight: 600;
    }
    
    /* Loading states */
    .spinner-border-sm {
      width: 1rem;
      height: 1rem;
    }
    
    /* Better form controls */
    .form-control, .form-select {
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    .form-control:focus, .form-select:focus {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
    }
    
    /* Enhanced cards */
    .card {
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    .card:hover {
      transform: translateY(-1px);
    }
    
    /* Better badges */
    .badge {
      border-radius: 6px;
      font-weight: 500;
    }
    
    /* Consistent spacing and typography */
    h5, h6 {
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .card-header {
      background: rgba(var(--bs-primary-rgb), 0.05);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .form-label {
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    /* Enhanced tables */
    .table {
      border-radius: 8px;
      overflow: hidden;
    }
    .table th {
      background: var(--panel);
      border: none;
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--muted);
      padding: 0.75rem;
    }
    .table td {
      border-color: rgba(255,255,255,.05);
      padding: 0.75rem;
      vertical-align: middle;
    }
    
    /* Progress bars */
    .progress {
      border-radius: 6px;
      background: rgba(255,255,255,.05);
    }
    .progress-bar {
      border-radius: 6px;
      background: linear-gradient(90deg, var(--ok), var(--brand));
    }
    
    /* Navigation improvements */
    .nav-pills {
      background: var(--panel);
      padding: 0.5rem;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      gap: 0.5rem;
      display: flex;
      flex-wrap: wrap;
    }
    .nav-pills .nav-link {
      border-radius: 12px;
      padding: 0.75rem 1.25rem;
      font-weight: 500;
      font-size: 0.95rem;
      color: var(--muted);
      transition: all 0.2s ease;
      border: 2px solid transparent;
      background: transparent;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .nav-pills .nav-link:hover {
      color: var(--text);
      background: rgba(255,255,255,.05);
      transform: translateY(-1px);
    }
    .nav-pills .nav-link.active {
      background: linear-gradient(135deg, var(--brand2), var(--brand));
      color: white;
      box-shadow: 0 4px 12px rgba(89, 162, 255, 0.3);
      border-color: rgba(255,255,255,.2);
      font-weight: 600;
    }
    
    /* Enhanced KPI Cards */
    .kpi-card {
      border-radius: 16px;
      padding: 1.5rem;
      background: var(--bg);
      border: 1px solid rgba(255,255,255,.08);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--brand2), var(--brand));
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    .kpi-card:hover::before {
      opacity: 1;
    }
    .kpi-card .kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    .kpi-card .kpi-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .kpi-card .kpi-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text);
      line-height: 1.2;
    }
    
    /* Modular Scenario Builder */
    .drag-source-container {
      min-height: 200px;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 8px;
      padding: 1rem;
      background: var(--panel);
    }
    
    .draggable-item {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      cursor: move;
      transition: all 0.2s ease;
      user-select: none;
    }
    
    .draggable-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      border-color: var(--brand);
    }
    
    .draggable-item.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
    
    .drop-zone {
      border: 2px dashed var(--muted);
      border-radius: 8px;
      min-height: 100px;
      background: rgba(255,255,255,.02);
      transition: all 0.3s ease;
    }
    
    .drop-zone.drag-over {
      border-color: var(--brand);
      background: rgba(89, 162, 255, 0.1);
      transform: scale(1.02);
    }
    
    .drop-zone-header {
      background: var(--muted);
      color: var(--bg);
      padding: 0.5rem;
      border-radius: 6px 6px 0 0;
      font-size: 0.875rem;
      font-weight: 600;
      text-align: center;
    }
    
    .drop-zone-content {
      padding: 1rem;
      min-height: 80px;
    }
    
    .drop-placeholder {
      text-align: center;
      color: var(--muted);
      font-style: italic;
      padding: 1rem;
    }
    
    .selected-item {
      background: rgba(89, 162, 255, 0.1);
      border: 1px solid var(--brand);
      border-radius: 6px;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: between;
      align-items: center;
    }
    
    .selected-item .remove-btn {
      background: rgba(255,255,255,.1);
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: auto;
    }
    
    /* Enhanced micro-interactions */
    .kpi {
      transition: all 0.2s ease;
      cursor: default;
    }
    .kpi:hover {
      background: rgba(89, 162, 255, 0.05);
    }
    .chip {
      transition: all 0.2s ease;
    }
    .chip:hover {
      transform: scale(1.02);
    }
    
    /* Loading animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .loading-shimmer {
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    /* Mobile optimizations */
    @media (max-width: 768px) {
      /* Navbar */
      .navbar-brand { font-size: 1rem; }
      .navbar-brand span:last-child { display: none; } /* Hide "Savings Dashboard" text on mobile */
      
      /* Tracker switcher */
      .tracker-switcher > div {
        flex-direction: column;
        gap: 0.75rem !important;
        align-items: stretch !important;
      }
      .tracker-switcher label {
        margin-bottom: 0;
      }
      .tracker-switcher select,
      .tracker-switcher button {
        width: 100%;
        max-width: 100% !important;
      }
      
      /* Cards */
      .card { margin-bottom: 1rem; }
      .card-body { padding: 1rem !important; }
      .card-header { padding: 0.75rem !important; }
      
      /* Buttons */
      .btn-group-mobile { 
        display: flex; 
        flex-direction: column; 
        gap: 0.5rem; 
        width: 100%;
      }
      .btn-group-mobile .btn { width: 100%; }
      
      /* Forms */
      .form-control, .form-select {
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      /* Tables */
      canvas { max-width: 100%; height: auto !important; }
      .table-responsive { 
        font-size: 0.875rem; 
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .table { min-width: 600px; } /* Ensure table doesn't get too cramped */
      
      /* Navigation */
      .nav-pills { 
        flex-wrap: wrap; 
        padding: 0.5rem;
        gap: 0.25rem;
      }
      .nav-pills .nav-link { 
        padding: 0.5rem 0.75rem; 
        font-size: 0.875rem; 
        flex: 1 1 auto;
        min-width: calc(50% - 0.125rem);
      }
      
      /* KPI Cards */
      .kpi-card {
        padding: 1rem !important;
      }
      .kpi-card .kpi-icon {
        font-size: 1.5rem !important;
      }
      
      /* Modals */
      .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
      }
      .modal-content {
        border-radius: 12px;
      }
      .modal-header, .modal-body, .modal-footer {
        padding: 1rem;
      }
      
      /* People/Goals Cards Grid */
      .people-grid, .goals-grid {
        grid-template-columns: 1fr !important;
        gap: 1rem;
      }
      
      /* People cards - ensure single column on mobile */
      #peopleList .col-12.col-lg-6 {
        width: 100% !important;
        max-width: 100% !important;
        flex: 0 0 100% !important;
      }
      
      /* Goals cards - ensure single column on mobile */
      #goalsList .col-12.col-md-6.col-lg-4 {
        width: 100% !important;
        max-width: 100% !important;
        flex: 0 0 100% !important;
      }
      
      /* Scenario cards */
      .scenario-card { margin-bottom: 1rem; }
      .metric-box { padding: 0.75rem; }
      .metric-value { font-size: 0.9rem; }
      .goals-preview { padding: 0.5rem; }
      
      /* User email display - hide on mobile */
      #userEmail, #userInitial {
        display: none !important;
      }
    }
    
    @media (max-width: 576px) {
      .container { padding-left: 0.75rem; padding-right: 0.75rem; }
      .card { padding: 0.75rem !important; }
      .btn { 
        padding: 0.5rem 0.75rem; 
        font-size: 0.875rem; 
      }
      h5, h6 { font-size: 1rem; }
      .kpi .value { font-size: 1rem; }
      
      /* Smaller text on very small screens */
      .navbar-brand { font-size: 0.9rem; }
      .nav-pills .nav-link { 
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
      }
      
      /* Compact modals */
      .modal-dialog {
        margin: 0.25rem;
        max-width: calc(100% - 0.5rem);
      }
      .modal-header h3, .modal-header h4, .modal-header h5 {
        font-size: 1.1rem;
      }
    }
    
    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      .btn, .nav-link, .card {
        min-height: 44px; /* iOS recommended touch target */
      }
      .btn-sm {
        min-height: 36px;
      }
    }
  </style>
</head>
<body>
<!-- Loading Screen -->
<div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 1rem;">
  <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
    <span class="visually-hidden">Loading...</span>
  </div>
  <div style="color: var(--text);">Initializing Savings Tracker...</div>
  <div id="loadingStatus" style="color: var(--muted); font-size: 0.875rem;"></div>
</div>

<!-- CRUD Operation Loading Popup -->
<div id="crudLoadingPopup" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 10000; min-width: 280px; max-width: 400px;">
  <div style="background: var(--panel); border-radius: 12px; padding: 1rem; box-shadow: 0 8px 24px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,.1);">
    <div class="d-flex align-items-center gap-3">
      <div class="spinner-border spinner-border-sm text-primary" role="status" style="width: 1.5rem; height: 1.5rem; flex-shrink: 0;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="flex-grow-1">
        <div id="crudLoadingMessage" style="color: var(--text); font-weight: 500; font-size: 0.9rem;">Processing...</div>
        <div id="crudLoadingDetails" style="color: var(--muted); font-size: 0.8rem; margin-top: 0.25rem;"></div>
      </div>
    </div>
  </div>
</div>

<nav class="navbar navbar-expand-lg border-bottom" style="display: none; background: var(--panel); border-color: rgba(255,255,255,.08) !important;" id="mainNav">
<div class="container-fluid">
<a class="navbar-brand fw-bold d-flex align-items-center gap-2" href="#" style="color: var(--text); font-size: 1.25rem;">
  <span style="font-size: 1.5rem;">ğŸ’°</span>
  <span class="d-none d-sm-inline">Savings Dashboard</span>
</a>
<button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" style="border: 1px solid rgba(255,255,255,.15); border-radius: 6px; padding: 0.5rem;">
  <span class="navbar-toggler-icon" style="background-image: url(&quot;data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 0.85%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e&quot;);"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
<div class="d-flex align-items-center gap-3 ms-auto flex-wrap">
  <!-- User Email Display -->
  <div class="d-none d-md-flex align-items-center gap-2 px-3 py-2 rounded" style="background: rgba(89, 162, 255, 0.1); border: 1px solid rgba(89, 162, 255, 0.2);">
    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--brand2), var(--brand)); display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600; color: white;">
      <span id="userInitial">U</span>
    </div>
    <div>
      <div style="font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;">Logged in as</div>
      <div id="userEmail" style="font-size: 0.875rem; font-weight: 500; color: var(--text);">Loading...</div>
    </div>
  </div>
  
  <!-- Action Buttons -->
  <div class="d-flex gap-1 no-print btn-group-mobile">
    <button class="btn btn-outline-secondary btn-sm" id="printBtn" title="Print" style="border-radius: 8px; padding: 0.5rem 0.75rem;">
      <span class="d-none d-sm-inline">ğŸ–¨ï¸</span>
      <span class="d-sm-none">ğŸ–¨ï¸</span>
    </button>
    <button class="btn btn-outline-secondary btn-sm" id="themeToggle" title="Toggle theme" style="border-radius: 8px; padding: 0.5rem 0.75rem;">
      ğŸŒ“
    </button>
    <button class="btn btn-outline-danger btn-sm" id="resetBtn" title="Reset" style="border-radius: 8px; padding: 0.5rem 0.75rem;">
      â†º
    </button>
    <button class="btn btn-outline-primary btn-sm" id="logoutBtn" title="Logout" style="border-radius: 8px; padding: 0.5rem 0.75rem;">
      <span class="d-none d-sm-inline">ğŸšª Logout</span>
      <span class="d-sm-none">ğŸšª</span>
    </button>
  </div>
</div>
</div>
</div>
</nav>

<!-- Tracker Switcher -->
<div class="tracker-switcher" id="trackerSwitcher" style="padding: 0.75rem 1rem; background: var(--panel); border-bottom: 1px solid rgba(255,255,255,.08);">
  <div style="display: flex; gap: 1rem; align-items: center; max-width: 1400px; margin: 0 auto;">
    <label for="tracker-select" style="font-weight: 600; color: var(--muted); font-size: 0.9rem;">
      Active Tracker:
    </label>
    <select id="tracker-select" style="flex: 1; max-width: 300px; padding: 0.5rem; border-radius: 6px; border: 1px solid rgba(255,255,255,.15); font-size: 0.9rem; background: var(--bg); color: var(--text);">
      <option>Loading trackers...</option>
    </select>
    <button id="btn-share-tracker" class="btn btn-outline-primary btn-sm" style="white-space: nowrap;" title="Share this tracker">
      ğŸ”— Share
    </button>
    <button id="btn-rename-tracker" class="btn btn-outline-secondary btn-sm" style="white-space: nowrap;" title="Rename this tracker">
      âœï¸ Rename
    </button>
    <button id="btn-delete-tracker" class="btn btn-outline-danger btn-sm" style="white-space: nowrap;" title="Delete this tracker">
      ğŸ—‘ï¸ Delete
    </button>
    <button id="btn-new-tracker" class="btn btn-primary btn-sm" style="white-space: nowrap;">
      + New Tracker
    </button>
  </div>
</div>

<!-- Create Tracker Modal -->
<div id="create-tracker-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto;">
  <div style="background-color: var(--bg); margin: 5% auto; padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,.15); position: relative;">
    <h3 style="margin-top: 0; margin-bottom: 1.5rem; color: var(--text);">Create New Tracker</h3>
    
    <div style="margin-bottom: 1rem;">
      <label for="new-tracker-name" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">
        Tracker Name *
      </label>
      <input 
        type="text" 
        id="new-tracker-name" 
        placeholder="e.g., Personal Savings, Family Fund"
        class="form-control"
        required
      >
    </div>
    
    <div style="margin-bottom: 1.5rem;">
      <label for="new-tracker-desc" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">
        Description (optional)
      </label>
      <textarea 
        id="new-tracker-desc" 
        placeholder="What is this tracker for?"
        rows="3"
        class="form-control"
      ></textarea>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button id="btn-cancel-tracker" class="btn btn-secondary">Cancel</button>
      <button id="btn-create-tracker" class="btn btn-primary">Create Tracker</button>
    </div>
  </div>
</div>

<!-- Rename Tracker Modal -->
<div id="rename-tracker-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto;">
  <div style="background-color: var(--bg); margin: 5% auto; padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,.15); position: relative;">
    <h3 style="margin-top: 0; margin-bottom: 1.5rem; color: var(--text);">Rename Tracker</h3>
    
    <div style="margin-bottom: 1rem;">
      <label for="rename-tracker-name" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">
        Tracker Name *
      </label>
      <input 
        type="text" 
        id="rename-tracker-name" 
        placeholder="e.g., Personal Savings, Family Fund"
        class="form-control"
        required
      >
    </div>
    
    <div style="margin-bottom: 1.5rem;">
      <label for="rename-tracker-desc" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text);">
        Description (optional)
      </label>
      <textarea 
        id="rename-tracker-desc" 
        placeholder="What is this tracker for?"
        rows="3"
        class="form-control"
      ></textarea>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button id="btn-cancel-rename" class="btn btn-secondary">Cancel</button>
      <button id="btn-save-rename" class="btn btn-primary">Save Changes</button>
    </div>
  </div>
</div>

<!-- Share Tracker Modal -->
<div id="share-tracker-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto;">
  <div style="background-color: var(--bg); margin: 5% auto; padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,.15); position: relative;">
    <h3 style="margin-top: 0; margin-bottom: 1.5rem; color: var(--text);">
      ğŸ”— Share Tracker: <span id="share-tracker-name" style="color: var(--primary);"></span>
    </h3>
    
    <!-- Share with new user -->
    <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--panel); border-radius: 8px; border: 1px solid rgba(255,255,255,.1);">
      <h4 style="margin-top: 0; margin-bottom: 1rem; color: var(--text); font-size: 1.1rem;">Share with User</h4>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <input 
          type="email" 
          id="share-user-email" 
          style="flex: 1; min-width: 200px; padding: 0.75rem; border-radius: 6px; border: 1px solid rgba(255,255,255,.15); background: var(--bg); color: var(--text); font-size: 1rem;"
          placeholder="Enter user email address"
        />
        <select id="share-permission" style="padding: 0.75rem; border-radius: 6px; border: 1px solid rgba(255,255,255,.15); background: var(--bg); color: var(--text); font-size: 1rem;">
          <option value="read">Read Only</option>
          <option value="write">Read & Write</option>
        </select>
        <button id="btn-add-share" class="btn btn-primary">Share</button>
      </div>
      <p style="margin: 0; color: var(--muted); font-size: 0.9rem;">
        ğŸ’¡ <strong>Read Only:</strong> User can view the tracker. <strong>Read & Write:</strong> User can also edit data.
      </p>
      <p style="margin: 0.5rem 0 0 0; color: var(--muted); font-size: 0.85rem;">
        ğŸ’¬ Enter the email address of the user you want to share with. They must have an account first.
      </p>
    </div>

    <!-- Shared users list -->
    <div>
      <h4 style="margin-top: 0; margin-bottom: 1rem; color: var(--text); font-size: 1.1rem;">Shared With</h4>
      <div id="shared-users-list" style="min-height: 100px;">
        <p style="color: var(--muted); text-align: center; padding: 2rem;">Loading shares...</p>
      </div>
    </div>

    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,.1);">
      <button id="btn-close-share-modal" class="btn btn-secondary">Close</button>
    </div>
  </div>
</div>

<main class="container my-3" style="display: none;" id="mainContent">
<!-- Tabs -->
<div class="mb-4">
  <ul class="nav nav-pills no-print" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-target="#tabDashboard" data-bs-toggle="pill" role="tab" type="button">
        <span style="font-size: 1.1rem;">ğŸ“Š</span> Dashboard
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-target="#tabPeople" data-bs-toggle="pill" role="tab" type="button">
        <span style="font-size: 1.1rem;">ğŸ‘¥</span> People
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-target="#tabGoals" data-bs-toggle="pill" role="tab" type="button">
        <span style="font-size: 1.1rem;">ğŸ¯</span> Goals
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-target="#tabRates" data-bs-toggle="pill" role="tab" type="button">
        <span style="font-size: 1.1rem;">ğŸ“ˆ</span> Rates
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-target="#tabTx" data-bs-toggle="pill" role="tab" type="button">
        <span style="font-size: 1.1rem;">ğŸ’³</span> Transactions
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-target="#tabSettings" data-bs-toggle="pill" role="tab" type="button">
        <span style="font-size: 1.1rem;">âš™ï¸</span> Settings
      </button>
    </li>
  </ul>
</div>
<div class="tab-content mt-3">
<!-- Dashboard -->
<section class="tab-pane fade show active" id="tabDashboard" role="tabpanel">
<div class="row g-3">
<!-- KPIs -->
<div class="col-12 mb-4">
<div class="row g-4">
<div class="col-6 col-lg-3">
<div class="kpi-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.05));">
  <div class="kpi-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2));">ğŸ’µ</div>
  <div class="kpi-label">Current Savings</div>
  <div class="kpi-value" id="kpiCurrentSavings">â€”</div>
</div>
</div>
<div class="col-6 col-lg-3">
<div class="kpi-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.05));">
  <div class="kpi-icon" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(239, 68, 68, 0.2));">ğŸ“Š</div>
  <div class="kpi-label">Savings Rate</div>
  <div class="kpi-value" id="kpiSavingsRate">â€”</div>
</div>
</div>
<div class="col-6 col-lg-3">
<div class="kpi-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.05));">
  <div class="kpi-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(6, 182, 212, 0.2));">ğŸ›¡ï¸</div>
  <div class="kpi-label">Emergency Fund</div>
  <div class="kpi-value" id="kpiEmergencyRatio">â€”</div>
</div>
</div>
<div class="col-6 col-lg-3">
<div class="kpi-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.05));">
  <div class="kpi-icon" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));">ğŸ¯</div>
  <div class="kpi-label">Goals On Track</div>
  <div class="kpi-value" id="kpiGoalsOnTrack">â€”</div>
</div>
</div>
</div>
</div>
<!-- Monthly Contribution Tracker -->
<div class="col-12 mb-4">
<div class="card p-3">
<h5 class="mb-2">ğŸ“… Monthly Contribution Tracker</h5>
<div class="row g-3">
<div class="col-lg-8">
<canvas height="120" id="monthlyContributionChart"></canvas>
</div>
<div class="col-lg-4">
<div id="contributionStreak"></div>
<div class="mt-3" id="contributionTable"></div>
</div>
</div>
</div>
</div>
<!-- Charts -->
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ‘¥ Contribution Breakdown</h5>
<div class="row g-2 mb-2">
<div class="col-12" id="contributionSummary"></div>
</div>
<canvas height="130" id="contributionChart"></canvas>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ¯ Goal Timeline (ETA at plan)</h5>
<canvas height="130" id="timelineChart"></canvas>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ“ˆ Savings Consistency</h5>
<div class="small mb-2 text-muted">Monthly savings pattern over time</div>
<canvas height="130" id="consistencyChart"></canvas>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ§¾ Recent Transactions (6 mo)</h5>
<canvas height="130" id="txChart"></canvas>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ¯ Goals at a Glance</h5>
<div id="goalsGlance"></div>
</div>
</div>
<div class="col-lg-6">
<div class="card p-3">
<h5 class="mb-2">ğŸ’¡ Smart Insights</h5>
<div id="smartInsights"></div>
</div>
</div>
</div>
</section>
<!-- People & Incomes -->
<section class="tab-pane fade" id="tabPeople" role="tabpanel">
<!-- Add Person Card -->
<div class="card mb-4 border-0 shadow-sm" style="background: linear-gradient(135deg, rgba(89, 162, 255, 0.1) 0%, rgba(138, 125, 255, 0.1) 100%); border-radius: 16px;">
  <div class="card-body p-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center">
        <div class="me-3" style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--brand2), var(--brand)); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
          ğŸ‘¤
        </div>
        <div>
          <h5 class="mb-0" style="font-weight: 600;">Add New Contributor</h5>
          <small class="text-muted">Track savings and income for household members</small>
        </div>
      </div>
      <button class="btn btn-sm btn-outline-secondary" id="toggleAddPerson" style="border-radius: 8px; padding: 0.25rem 0.5rem;" title="Toggle form">
        <span id="toggleAddPersonIcon">â–¼</span>
      </button>
    </div>
    <div class="row g-3 mt-2" id="addPersonForm" style="display: none;">
      <div class="col-md-4">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Name</label>
        <input class="form-control form-control-lg" id="personName" placeholder="e.g., Michael" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Current Savings</label>
        <input class="form-control form-control-lg" id="personSavings" placeholder="0" step="0.01" type="number" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Fixed Monthly <span class="text-muted">(Optional)</span></label>
        <input class="form-control form-control-lg" id="personFixedContribution" placeholder="0" step="0.01" type="number" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
        <small class="text-muted" style="font-size: 0.7rem;">Fixed amount regardless of rate</small>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100" id="addPersonBtn" style="border-radius: 10px; padding: 0.75rem; font-weight: 600; box-shadow: 0 4px 12px rgba(89, 162, 255, 0.3);">
          <span style="font-size: 1.2rem; margin-right: 0.25rem;">+</span> Add
        </button>
      </div>
    </div>
  </div>
</div>

<!-- People List -->
<div id="peopleList" class="row g-4"></div>

<!-- Empty State -->
<div id="peopleEmptyState" class="text-center py-5" style="display: none;">
  <div style="width: 120px; height: 120px; margin: 0 auto 2rem; border-radius: 50%; background: linear-gradient(135deg, rgba(89, 162, 255, 0.1), rgba(138, 125, 255, 0.1)); display: flex; align-items: center; justify-content: center; font-size: 3rem;">
    ğŸ‘¥
  </div>
  <h4 class="mb-2" style="font-weight: 600;">No contributors yet</h4>
  <p class="text-muted mb-4">Add household members to start tracking their savings and contributions</p>
</div>
</section>
<!-- Goals -->
<section class="tab-pane fade" id="tabGoals" role="tabpanel">
<!-- Add Goal Card -->
<div class="card mb-4 border-0 shadow-sm" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border-radius: 16px;">
  <div class="card-body p-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center">
        <div class="me-3" style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #10b981, #3b82f6); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
          ğŸ¯
        </div>
        <div>
          <h5 class="mb-0" style="font-weight: 600;">Add New Goal</h5>
          <small class="text-muted">Set financial targets and track your progress</small>
        </div>
      </div>
      <button class="btn btn-sm btn-outline-secondary" id="toggleAddGoal" style="border-radius: 8px; padding: 0.25rem 0.5rem;" title="Toggle form">
        <span id="toggleAddGoalIcon">â–¼</span>
      </button>
    </div>
    <div class="row g-3 mt-2" id="addGoalForm" style="display: none;">
      <div class="col-md-3">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Goal Name</label>
        <input class="form-control form-control-lg" id="goalName" placeholder="Emergency Fund" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
      </div>
      <div class="col-md-2">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Target Amount</label>
        <input class="form-control form-control-lg" id="goalTarget" placeholder="200000" step="0.01" type="number" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
      </div>
      <div class="col-md-2">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Deadline</label>
        <input class="form-control form-control-lg" id="goalDeadline" type="date" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
      </div>
      <div class="col-md-2">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Owner</label>
        <select class="form-select form-select-lg" id="goalOwner" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"></select>
      </div>
      <div class="col-md-2">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Priority</label>
        <input class="form-control form-control-lg" id="goalPriority" min="1" type="number" value="1" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
        <small class="text-muted" style="font-size: 0.7rem;">Lower = Higher priority</small>
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-primary w-100" id="addGoalBtn" style="border-radius: 10px; padding: 0.75rem; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
          <span style="font-size: 1.2rem; margin-right: 0.25rem;">+</span> Add
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Goals Filter/Search (shown when there are goals) -->
<div id="goalsFilterBar" class="card mb-4 border-0 shadow-sm" style="display: none;">
  <div class="card-body p-3">
    <div class="row g-3 align-items-center">
      <div class="col-md-4">
        <input type="text" class="form-control" id="goalsSearch" placeholder="ğŸ” Search goals..." style="border-radius: 8px;"/>
      </div>
      <div class="col-md-3">
        <select class="form-select" id="goalsFilterOwner" style="border-radius: 8px;">
          <option value="">All Owners</option>
          <option value="Household">Household</option>
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" id="goalsFilterStatus" style="border-radius: 8px;">
          <option value="">All Status</option>
          <option value="on-track">âœ… On Track</option>
          <option value="at-risk">âš ï¸ At Risk</option>
          <option value="completed">ğŸ‰ Completed</option>
        </select>
      </div>
      <div class="col-md-2 text-end">
        <small class="text-muted" id="goalsCount">0 goals</small>
      </div>
    </div>
  </div>
</div>

<!-- Goals List - Responsive Grid -->
<div id="goalsList" class="row g-4"></div>

<!-- Empty State -->
<div id="goalsEmptyState" class="text-center py-5" style="display: none;">
  <div style="width: 120px; height: 120px; margin: 0 auto 2rem; border-radius: 50%; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1)); display: flex; align-items: center; justify-content: center; font-size: 3rem;">
    ğŸ¯
  </div>
  <h4 class="mb-2" style="font-weight: 600;">No goals set yet</h4>
  <p class="text-muted mb-4">Create your first financial goal to start tracking your progress</p>
</div>

<!-- Monthly Requirement Summary -->
<div class="card p-3 mt-4 border-0 shadow-sm" id="goalsRequiredCard" style="display: none;">
  <h6 class="mb-3 fw-semibold">ğŸ“Š Monthly Requirement vs Plan</h6>
  <div class="row g-3" id="goalsRequiredList"></div>
</div>
</section>
<!-- Rate Scenarios -->
<section class="tab-pane fade" id="tabRates" role="tabpanel">

<!-- Scenario Filters -->
<div class="card mb-4 border-0 shadow-sm" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%); border-radius: 16px;">
  <div class="card-body p-4">
    <div class="d-flex align-items-center mb-4">
      <div class="me-3" style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #f59e0b, #ef4444); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
        ğŸ›ï¸
      </div>
      <div>
        <h5 class="mb-0" style="font-weight: 600;">Scenario Configuration</h5>
        <small class="text-muted">Compare different savings rate scenarios</small>
      </div>
    </div>
    <div class="row g-4 mt-2">
      <div class="col-md-4">
        <h6 class="text-primary mb-3 fw-semibold">ğŸ‘¥ Select Contributors</h6>
        <div id="contributorsFilter" class="p-3 rounded" style="background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.1); min-height: 150px;">
          <!-- Contributor checkboxes will be populated here -->
        </div>
      </div>
      <div class="col-md-4">
        <h6 class="text-success mb-3 fw-semibold">ğŸ¯ Select Goals</h6>
        <div id="goalsFilter" class="p-3 rounded" style="background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.1); min-height: 150px;">
          <!-- Goal checkboxes will be populated here -->
        </div>
      </div>
      <div class="col-md-4">
        <h6 class="text-warning mb-3 fw-semibold">ğŸ“ˆ Configuration</h6>
        <div class="mb-3">
          <label class="form-label fw-semibold small text-uppercase text-muted mb-2" style="letter-spacing: 0.5px; font-size: 0.75rem;">Savings Rates (%)</label>
          <input class="form-control form-control-lg" id="scenarioRates" value="5,10,15,20" placeholder="e.g., 5,10,15,20" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
          <small class="text-muted" style="font-size: 0.7rem;">Comma-separated list of rates to compare</small>
        </div>
        <div class="d-grid">
          <button class="btn btn-primary btn-lg" id="refreshRatesBtn" style="border-radius: 10px; padding: 0.75rem; font-weight: 600; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
            ğŸ”„ Calculate Scenarios
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Rate Scenarios Table -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-transparent border-0 p-4 pb-2">
    <h5 class="mb-0 fw-semibold">ğŸ“Š Scenario Comparison</h5>
    <small class="text-muted">Compare different savings rate scenarios</small>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="ratesTable">
        <thead style="background: var(--panel);">
          <tr>
            <th style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Rate</th>
            <th style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Monthly</th>
            <th style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">2-Year Value</th>
            <th style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">5-Year Value</th>
            <th style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Goals Status</th>
            <th style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Key Impact</th>
            <th style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Recommendation</th>
          </tr>
        </thead>
        <tbody id="ratesTableBody">
          <!-- Scenarios will be populated here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Empty State -->
<div id="ratesEmptyState" class="text-center py-5" style="display: none;">
  <div style="width: 120px; height: 120px; margin: 0 auto 2rem; border-radius: 50%; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.1)); display: flex; align-items: center; justify-content: center; font-size: 3rem;">
    ğŸ“ˆ
  </div>
  <h4 class="mb-2" style="font-weight: 600;">No scenarios calculated yet</h4>
  <p class="text-muted mb-4">Select contributors and goals, then click "Calculate Scenarios" to compare different savings rates</p>
</div>

</section>
<!-- Transactions -->
<section class="tab-pane fade" id="tabTx" role="tabpanel">
<!-- Add Transaction Card -->
<div class="card mb-4 border-0 shadow-sm" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border-radius: 16px;">
  <div class="card-body p-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center">
        <div class="me-3" style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #10b981, #3b82f6); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
          ğŸ’³
        </div>
        <div>
          <h5 class="mb-0" style="font-weight: 600;">Add Savings Transaction</h5>
          <small class="text-muted">Record your savings contributions</small>
        </div>
      </div>
      <button class="btn btn-sm btn-outline-secondary" id="toggleAddTx" style="border-radius: 8px; padding: 0.25rem 0.5rem;" title="Toggle form">
        <span id="toggleAddTxIcon">â–¼</span>
      </button>
    </div>
    <div class="row g-3 mt-2" id="addTxForm" style="display: none;">
      <div class="col-md-3">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Date</label>
        <input class="form-control form-control-lg" id="txDate" type="date" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Amount</label>
        <input class="form-control form-control-lg" id="txAmount" placeholder="5000" step="0.01" type="number" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Person</label>
        <select class="form-select form-select-lg" id="txPerson" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"></select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Allocate to Goal</label>
        <select class="form-select form-select-lg" id="txGoal" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);">
          <option value="">ğŸ’° General Savings</option>
        </select>
        <div class="mt-1" id="goalSuggestion" style="display:none;">
          <small class="text-info">ğŸ’¡ <span id="suggestionText"></span></small>
        </div>
      </div>
      <div class="col-12">
        <label class="form-label fw-semibold small text-uppercase text-muted" style="letter-spacing: 0.5px; font-size: 0.75rem;">Note (Optional)</label>
        <input class="form-control form-control-lg" id="txNote" placeholder="e.g., Payday auto-save, Bonus, etc." style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
      </div>
      <div class="col-12 d-grid">
        <button class="btn btn-primary btn-lg" id="addTxBtn" style="border-radius: 10px; padding: 0.75rem; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
          <span style="font-size: 1.2rem; margin-right: 0.5rem;">+</span> Add Transaction
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Transaction Stats -->
<div class="row g-4 mb-4">
  <div class="col-md-4">
    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.05));">
      <div class="kpi-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2));">ğŸ’°</div>
      <div class="kpi-label">Total Transactions</div>
      <div class="kpi-value" id="txTotal">â€”</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.05));">
      <div class="kpi-icon" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(239, 68, 68, 0.2));">ğŸ“…</div>
      <div class="kpi-label">Last 30 Days</div>
      <div class="kpi-value" id="txLast30">â€”</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="kpi-card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.05));">
      <div class="kpi-icon" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2));">ğŸ‘¤</div>
      <div class="kpi-label">Top Contributor</div>
      <div class="kpi-value small" id="txTopPerson" style="font-size: 1.1rem;">â€”</div>
    </div>
  </div>
</div>

<!-- Transactions Table -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-header bg-transparent border-0 p-4 pb-2">
    <h5 class="mb-0 fw-semibold">ğŸ“‹ Transaction History</h5>
    <small class="text-muted">All your savings transactions</small>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="txTable">
        <thead style="background: var(--panel);">
          <tr>
            <th style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Date</th>
            <th style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Person</th>
            <th class="text-end" style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Amount</th>
            <th class="text-end" style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Balance</th>
            <th style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Goal</th>
            <th style="padding: 1rem; font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Note</th>
            <th style="padding: 1rem; width: 100px;"></th>
          </tr>
        </thead>
        <tbody id="txTableBody">
          <!-- Transactions will be populated here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Empty State -->
<div id="txEmptyState" class="text-center py-5" style="display: none;">
  <div style="width: 120px; height: 120px; margin: 0 auto 2rem; border-radius: 50%; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1)); display: flex; align-items: center; justify-content: center; font-size: 3rem;">
    ğŸ’³
  </div>
  <h4 class="mb-2" style="font-weight: 600;">No transactions yet</h4>
  <p class="text-muted mb-4">Start tracking your savings by adding your first transaction</p>
</div>

<!-- Transaction Charts -->
<div class="row g-4">
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm p-4">
      <h6 class="mb-3 fw-semibold">ğŸ“Š Recent Transactions (6 mo)</h6>
      <canvas height="130" id="txStackedChartTab"></canvas>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card border-0 shadow-sm p-4">
      <h6 class="mb-3 fw-semibold">ğŸ“Š Recent Totals (6 mo)</h6>
      <canvas height="130" id="txChart2"></canvas>
    </div>
  </div>
  <div class="col-12">
    <div class="card border-0 shadow-sm p-4">
      <h6 class="mb-3 fw-semibold">ğŸ‘¥ Transactions by Person</h6>
      <canvas height="130" id="txStackedChart"></canvas>
    </div>
  </div>
</div>
</section>
<!-- Settings -->
<section class="tab-pane fade" id="tabSettings" role="tabpanel">
<div class="card mb-4 border-0 shadow-sm" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%); border-radius: 16px;">
  <div class="card-body p-4">
    <div class="d-flex align-items-center mb-4">
      <div class="me-3" style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #8b5cf6, #ec4899); display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
        âš™ï¸
      </div>
      <div>
        <h5 class="mb-0" style="font-weight: 600;">General Settings</h5>
        <small class="text-muted">Configure your savings preferences</small>
      </div>
    </div>
    <div class="row g-4 mt-2">
      <div class="col-md-4">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-2" style="letter-spacing: 0.5px; font-size: 0.75rem;">Currency</label>
        <select class="form-select form-select-lg" id="currencyCode" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);">
          <option value="PHP">PHP â€“ Philippine Peso</option>
          <option value="USD">USD â€“ US Dollar</option>
          <option value="EUR">EUR â€“ Euro</option>
          <option value="JPY">JPY â€“ Yen</option>
          <option value="AUD">AUD â€“ Australian Dollar</option>
          <option value="GBP">GBP â€“ British Pound</option>
          <option value="SGD">SGD â€“ Singapore Dollar</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-2" style="letter-spacing: 0.5px; font-size: 0.75rem;">Locale</label>
        <select class="form-select form-select-lg" id="localeSelect" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);">
          <option value="en-PH">English (Philippines)</option>
          <option value="en-US">English (US)</option>
          <option value="en-GB">English (UK)</option>
          <option value="fil-PH">Filipino (Philippines)</option>
          <option value="de-DE">Deutsch (DE)</option>
          <option value="fr-FR">FranÃ§ais (FR)</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-2" style="letter-spacing: 0.5px; font-size: 0.75rem;">Savings Rate (%)</label>
        <input class="form-control form-control-lg" id="currentRate" step="0.1" type="number" value="12" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
        <small class="text-muted" style="font-size: 0.7rem;">Percentage of income to save</small>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-2" style="letter-spacing: 0.5px; font-size: 0.75rem;">APY (%)</label>
        <input class="form-control form-control-lg" id="apy" step="0.1" type="number" value="3" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
        <small class="text-muted" style="font-size: 0.7rem;">Annual Percentage Yield</small>
      </div>
      <div class="col-md-4">
        <label class="form-label fw-semibold small text-uppercase text-muted mb-2" style="letter-spacing: 0.5px; font-size: 0.75rem;">Inflation (%)</label>
        <input class="form-control form-control-lg" id="inflation" step="0.1" type="number" value="4" style="border-radius: 10px; border: 2px solid rgba(255,255,255,.1);"/>
        <small class="text-muted" style="font-size: 0.7rem;">Expected annual inflation rate</small>
      </div>
      <div class="col-12 d-flex justify-content-end mt-2">
        <button class="btn btn-primary btn-lg" id="saveSettingsBtn" style="border-radius: 10px; padding: 0.75rem 2rem; font-weight: 600; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
          ğŸ’¾ Save Settings
        </button>
      </div>
    </div>
  </div>
</div>
</section>
</div>
</main>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Auth & API Scripts -->
<script>
    // âš ï¸ CRITICAL: Run immediately when page loads
    console.log('%cğŸ“„ savings_app_v16.html SCRIPT BLOCK STARTED', 'color: blue; font-size: 14px; font-weight: bold;');
    console.log('ğŸ”— URL:', window.location.href);
    console.log('ğŸ”— Hash:', window.location.hash);
    console.log('ğŸ”— Document ready:', document.readyState);
    console.log('ğŸ“š Scripts will load next...');
    
    // Verify Supabase is loaded (from head)
    if (typeof window.supabase === 'undefined') {
        console.error('âŒ Supabase library not loaded from CDN!');
        console.error('âŒ Check Network tab for: @supabase/supabase-js');
    } else {
        console.log('âœ… Supabase library loaded:', typeof window.supabase);
    }
    
    // Check if we can access window
    console.log('âœ… window object accessible:', typeof window !== 'undefined');
    console.log('âœ… document accessible:', typeof document !== 'undefined');
    console.log('âœ… console accessible:', typeof console !== 'undefined');
</script>
<!-- Set Supabase credentials BEFORE loading auth.js -->
<script>
  // Set Supabase credentials (must be set before auth.js loads)
  window.SUPABASE_URL = window.SUPABASE_URL || 'https://uqbcokdpldhrxccyddfz.supabase.co';
  window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxYmNva2RwbGRocnhjY3lkZGZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwOTM5MzcsImV4cCI6MjA3NzY2OTkzN30.4yknX1zqpfloABqexwzl0ElLYVp4C_atUbNAR8P_1eU';
  console.log('âœ… Supabase credentials set');
</script>
<script src="/js/auth.js" onerror="console.error('âŒ CRITICAL: Failed to load /js/auth.js - check file exists!')"></script>
<script src="/js/api.js" onerror="console.error('âŒ CRITICAL: Failed to load /js/api.js - check file exists!')"></script>
<script src="/js/tracker-manager.js" onerror="console.error('âŒ CRITICAL: Failed to load /js/tracker-manager.js - check file exists!')"></script>
<script>
    // Verify scripts loaded
    console.log('ğŸ“š After script tags:');
    console.log('auth.js:', typeof window.auth !== 'undefined' ? 'âœ… Loaded' : 'âŒ Not loaded');
    console.log('SavingsAPI:', typeof window.SavingsAPI !== 'undefined' ? 'âœ… Loaded' : 'âŒ Not loaded');
    console.log('TrackerManager:', typeof window.TrackerManager !== 'undefined' ? 'âœ… Loaded' : 'âŒ Not loaded');
    
    // Use window references directly - don't redeclare variables/classes that are already declared in loaded scripts
    // Just verify they exist, don't create new const/let declarations
    if (typeof window.auth === 'undefined') {
        console.error('âŒ CRITICAL ERROR: auth is not defined!');
        console.error('Check if js/auth.js loaded correctly');
    }
    if (typeof window.SavingsAPI === 'undefined') {
        console.error('âŒ CRITICAL ERROR: SavingsAPI is not defined!');
        console.error('Check if js/api.js loaded correctly');
    }
    if (typeof window.TrackerManager === 'undefined') {
        console.error('âŒ CRITICAL ERROR: TrackerManager is not defined!');
        console.error('Check if js/tracker-manager.js loaded correctly');
    }
</script>
<script>
    /********** AUTHENTICATION & INITIALIZATION **********/
    // Supabase credentials already set above, but ensure they're still available
    window.SUPABASE_URL = window.SUPABASE_URL || 'https://uqbcokdpldhrxccyddfz.supabase.co';
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxYmNva2RwbGRocnhjY3lkZGZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwOTM5MzcsImV4cCI6MjA3NzY2OTkzN30.4yknX1zqpfloABqexwzl0ElLYVp4C_atUbNAR8P_1eU';

    // Update loading status
    function updateLoadingStatus(message) {
      const statusEl = document.getElementById('loadingStatus');
      if (statusEl) statusEl.textContent = message;
      console.log(message);
    }

    console.log('ğŸš€ Starting app initialization...');
    updateLoadingStatus('Checking authentication...');

    // Handle OAuth callback (Supabase adds hash fragments after OAuth redirect)
    // Check if we're returning from OAuth
    if (window.location.hash) {
      console.log('ğŸ”— OAuth callback detected, processing...');
      updateLoadingStatus('Completing Google sign-in...');
    }

    // Wait for auth to initialize (with timeout)
    let authWaitAttempts = 0;
    const MAX_AUTH_WAIT = 50; // 5 seconds max
    
    function waitForAuth(callback) {
      authWaitAttempts++;
      
      // Use window.auth for safety
      const authInstance = typeof window !== 'undefined' && window.auth ? window.auth : (typeof auth !== 'undefined' ? auth : null);
      
      if (authInstance && authInstance.supabase) {
        console.log('âœ… Auth initialized');
        
        // Handle OAuth callback if hash is present
        if (window.location.hash && window.location.hash.includes('access_token')) {
          console.log('ğŸ”— Processing OAuth callback...');
          updateLoadingStatus('Completing sign-in...');
          
          // Supabase will automatically handle the hash, but we can help it along
          authInstance.supabase.auth.getSession().then(async ({ data: { session }, error }) => {
            if (error) {
              console.error('âŒ OAuth callback error:', error);
              window.location.href = '/login.html';
              return;
            }
            
            if (session) {
              // Ensure session is set on auth instance
              authInstance.session = session;
              console.log('âœ… Session set on auth instance after OAuth');
              
              // Clear hash from URL
              if (window.history && window.history.replaceState) {
                window.history.replaceState(null, '', window.location.pathname);
              }
              updateLoadingStatus('Sign-in complete!');
              callback();
            } else {
              console.error('âŒ No session after OAuth callback');
              window.location.href = '/login.html';
            }
          });
        } else {
          // For non-OAuth flow, ensure session is checked and set
          authInstance.checkSession().then((session) => {
            if (session) {
              authInstance.session = session;
              console.log('âœ… Session checked and set');
              // Update user email display
              updateUserEmailDisplay();
            }
            updateLoadingStatus('Auth ready');
            callback();
          }).catch((error) => {
            console.error('âŒ Session check failed:', error);
            updateLoadingStatus('Auth ready');
            callback(); // Continue anyway, will fail gracefully
          });
        }
      } else if (authWaitAttempts >= MAX_AUTH_WAIT) {
        console.error('âŒ Auth initialization timeout - trying direct Supabase check');
        updateLoadingStatus('Auth timeout - trying direct check...');
        // Fallback: try to check session directly
        try {
          if (typeof window.supabase === 'undefined') {
            throw new Error('Supabase library not loaded');
          }
          const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
          supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
              console.log('âœ… Session found via direct check');
              updateLoadingStatus('Session found');
              // Update user email display
              updateUserEmailDisplay();
              // Create auth object manually if needed
              if (!window.auth || typeof window.auth === 'undefined') {
                window.auth = {
                  supabase: supabase,
                  session: session,
                  checkSession: async () => {
                    const { data } = await supabase.auth.getSession();
                    return data.session;
                  },
                  getToken: () => session?.access_token,
                  getHeaders: () => ({
                    'Authorization': `Bearer ${session.access_token}`,
                    'Content-Type': 'application/json'
                  }),
                  signOut: () => supabase.auth.signOut()
                };
                console.log('âœ… Created window.auth manually');
              }
              callback();
            } else {
              console.log('âŒ No session found, redirecting to login');
              updateLoadingStatus('No session - redirecting...');
              setTimeout(() => window.location.href = '/login.html', 1000);
            }
          }).catch(err => {
            console.error('âŒ Session check failed:', err);
            updateLoadingStatus('Session check failed - redirecting...');
            setTimeout(() => window.location.href = '/login.html', 1000);
          });
        } catch (error) {
          console.error('âŒ Direct auth check failed:', error);
          updateLoadingStatus('Auth failed: ' + error.message);
          setTimeout(() => window.location.href = '/login.html', 2000);
        }
      } else {
        if (authWaitAttempts % 10 === 0) {
          updateLoadingStatus(`Waiting for auth scripts to load... (${authWaitAttempts}/${MAX_AUTH_WAIT})`);
        }
        setTimeout(() => waitForAuth(callback), 100);
      }
    }
    
    // Hide loading screen
    function hideLoadingScreen() {
      const loadingScreen = document.getElementById('loadingScreen');
      const mainNav = document.getElementById('mainNav');
      const trackerSwitcher = document.getElementById('trackerSwitcher');
      const mainContent = document.getElementById('mainContent');
      
      console.log('ğŸ”„ Hiding loading screen...');
      
      if (loadingScreen) {
        loadingScreen.style.display = 'none';
        console.log('âœ… Loading screen hidden');
      } else {
        console.warn('âš ï¸ Loading screen element not found');
      }
      
      if (mainNav) {
        mainNav.style.display = 'flex';
        console.log('âœ… Navbar shown');
      } else {
        console.warn('âš ï¸ Navbar element not found');
      }
      
      if (trackerSwitcher) {
        if (trackerSwitcher.style.display === 'none') {
          trackerSwitcher.style.display = 'block';
        }
        console.log('âœ… Tracker switcher shown');
      } else {
        console.warn('âš ï¸ Tracker switcher element not found');
      }
      
      if (mainContent) {
        mainContent.style.display = 'block';
        console.log('âœ… Main content shown');
      } else {
        console.warn('âš ï¸ Main content element not found');
      }
      
      console.log('âœ… Loading screen hidden, UI visible');
      
      // Force a repaint
      document.body.offsetHeight;
    }

    // Check authentication and initialize app
    waitForAuth(async () => {
      try {
        updateLoadingStatus('Checking session...');
        console.log('ğŸ” Checking session...');
        
        // Get auth instance
        const authInstance = window.auth || (typeof auth !== 'undefined' ? auth : null);
        if (!authInstance) {
          throw new Error('Auth instance not found!');
        }
        
        const session = await authInstance.checkSession();
        console.log('Session check result:', session ? 'âœ… Authenticated' : 'âŒ Not authenticated');
        
        if (!session) {
          // Not logged in, redirect to login
          console.log('Redirecting to login...');
          updateLoadingStatus('Not authenticated - redirecting to login...');
          setTimeout(() => window.location.href = '/login.html', 1000);
          return;
        }

        updateLoadingStatus('Initializing app...');
        console.log('ğŸ¯ Initializing app...');
        // Initialize tracker manager and API
        await initializeApp();
        console.log('âœ… App initialized successfully!');
        
        // Update user email display
        updateUserEmailDisplay();
        
        // Hide loading screen after successful initialization
        hideLoadingScreen();
      } catch (error) {
        console.error('âŒ Auth/init error:', error);
        console.error('Full error:', JSON.stringify(error, Object.getOwnPropertyNames(error)));
        updateLoadingStatus('Error: ' + error.message);
        
        // Show error but don't hide loading screen
        setTimeout(() => {
          showAlert('Failed to initialize app: ' + error.message + '\n\nCheck browser console (F12) for details.', 'danger');
        }, 500);
      }
    });

    /********** UTILITY FUNCTIONS **********/
    // CRUD Loading Popup Functions
    function showCrudLoading(message, details = '') {
      const popup = $('#crudLoadingPopup');
      const messageEl = $('#crudLoadingMessage');
      const detailsEl = $('#crudLoadingDetails');
      
      if (popup && messageEl) {
        messageEl.textContent = message;
        if (detailsEl) {
          detailsEl.textContent = details;
        }
        popup.style.display = 'block';
        
        // Add fade-in animation
        popup.style.opacity = '0';
        popup.style.transition = 'opacity 0.2s ease-in';
        setTimeout(() => {
          popup.style.opacity = '1';
        }, 10);
      }
    }
    
    function hideCrudLoading() {
      const popup = $('#crudLoadingPopup');
      if (popup) {
        popup.style.opacity = '0';
        popup.style.transition = 'opacity 0.2s ease-out';
        setTimeout(() => {
          popup.style.display = 'none';
        }, 200);
      }
    }
    
    // Simple alert function for user notifications
    function showAlert(message, type = 'info') {
      // For now, use browser alert. Can be enhanced with a toast notification system later
      const icons = {
        success: 'âœ…',
        danger: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
      };
      const icon = icons[type] || icons.info;
      alert(`${icon} ${message}`);
    }
    
    // Update user email display in navbar
    function updateUserEmailDisplay() {
      const userEmailEl = $('#userEmail');
      const userInitialEl = $('#userInitial');
      
      if (!userEmailEl || !userInitialEl) return;
      
      try {
        const authInstance = window.auth;
        if (!authInstance || !authInstance.session) {
          userEmailEl.textContent = 'Not logged in';
          userInitialEl.textContent = '?';
          return;
        }
        
        // Get user email from session
        const user = authInstance.session.user;
        if (user && user.email) {
          userEmailEl.textContent = user.email;
          // Extract first letter for initial
          const initial = user.email.charAt(0).toUpperCase();
          userInitialEl.textContent = initial;
        } else {
          // Try to get from supabase directly
          if (authInstance.supabase) {
            authInstance.supabase.auth.getUser().then(({ data: { user } }) => {
              if (user && user.email) {
                userEmailEl.textContent = user.email;
                const initial = user.email.charAt(0).toUpperCase();
                userInitialEl.textContent = initial;
              }
            }).catch(() => {
              userEmailEl.textContent = 'Unable to load';
              userInitialEl.textContent = '?';
            });
          } else {
            userEmailEl.textContent = 'Loading...';
            userInitialEl.textContent = 'U';
          }
        }
      } catch (error) {
        console.error('Error updating user email display:', error);
        userEmailEl.textContent = 'Error loading';
        userInitialEl.textContent = '?';
      }
    }

    /********** STATE **********/
    const STORAGE_KEY = 'savingsBootstrapV1';
    const uid = () => 'id-' + Math.random().toString(36).slice(2,9);
    const todayOffset = (d)=>{ const x=new Date(); x.setDate(x.getDate()+d); return x.toISOString().slice(0,10); };
    
    // Global variables for API and tracker
    // Note: api.js already declares 'let api = null' and 'let currentTrackerId = null' globally
    // So we use appApi and appCurrentTrackerId instead
    let appApi = null;
    let trackerManager = null;
    let appCurrentTrackerId = null;

    const defaultState = {
      settings: { currency:'PHP', locale:'en-PH', currentRatePct:12, apyPct:3, inflationPct:4 },
      people: [],
      goals: [],
      transactions: [],
      scenarioRates: [5,10,15,20]
    };

    let appState = JSON.parse(JSON.stringify(defaultState));

    // Initialize app with authentication
    // Toggle form functions
    function setupFormToggles() {
      // Toggle Add Person form
      $('#toggleAddPerson')?.addEventListener('click', () => {
        const form = $('#addPersonForm');
        const icon = $('#toggleAddPersonIcon');
        if(form && icon) {
          const isVisible = form.style.display !== 'none';
          form.style.display = isVisible ? 'none' : 'block';
          icon.textContent = isVisible ? 'â–¼' : 'â–²';
        }
      });
      
      // Toggle Add Goal form
      $('#toggleAddGoal')?.addEventListener('click', () => {
        const form = $('#addGoalForm');
        const icon = $('#toggleAddGoalIcon');
        if(form && icon) {
          const isVisible = form.style.display !== 'none';
          form.style.display = isVisible ? 'none' : 'block';
          icon.textContent = isVisible ? 'â–¼' : 'â–²';
        }
      });
      
      // Toggle Add Transaction form
      $('#toggleAddTx')?.addEventListener('click', () => {
        const form = $('#addTxForm');
        const icon = $('#toggleAddTxIcon');
        if(form && icon) {
          const isVisible = form.style.display !== 'none';
          form.style.display = isVisible ? 'none' : 'block';
          icon.textContent = isVisible ? 'â–¼' : 'â–²';
        }
      });
    }
    
    async function initializeApp() {
      try {
        updateLoadingStatus('Initializing tracker manager...');
        console.log('ğŸ“¦ Initializing tracker manager...');
        // Get auth instance
        const authInstance = window.auth || (typeof auth !== 'undefined' ? auth : null);
        if (!authInstance) {
          throw new Error('Auth instance not available for tracker initialization');
        }
        
        // Initialize tracker manager
        updateLoadingStatus('Initializing tracker manager...');
        const SavingsAPIClass = window.SavingsAPI;
        const TrackerManagerClass = window.TrackerManager;
        
        if (!SavingsAPIClass || !TrackerManagerClass) {
          throw new Error('Required classes not loaded. Check js/api.js and js/tracker-manager.js');
        }
        
        const tempApi = new SavingsAPIClass(authInstance, 'temp');
        trackerManager = new TrackerManagerClass(tempApi);
        appCurrentTrackerId = await trackerManager.initialize();
        console.log('âœ… Tracker initialized:', appCurrentTrackerId);
        updateLoadingStatus('Tracker ready');
        
        // Initialize API with tracker
        updateLoadingStatus('Setting up API...');
        appApi = new SavingsAPIClass(authInstance, appCurrentTrackerId);
        trackerManager.api = appApi;
        
        // Workaround: Manually add share tracker methods if they're missing (cache issue)
        if (!appApi.getTrackerShares) {
          console.warn('âš ï¸ getTrackerShares missing, adding manually...');
          appApi.getTrackerShares = async function(trackerId) {
            // Don't add trackerId to URL - request() method already adds it
            return await this.request('/tracker-shares', { method: 'GET' });
          };
        }
        if (!appApi.shareTracker) {
          console.warn('âš ï¸ shareTracker missing, adding manually...');
          appApi.shareTracker = async function(trackerId, sharedWithUserId, sharedWithEmail, permission = 'read') {
            return await this.request('/tracker-shares', {
              method: 'POST',
              body: { trackerId, sharedWithUserId, sharedWithEmail, permission }
            });
          };
        }
        if (!appApi.updateSharePermission) {
          console.warn('âš ï¸ updateSharePermission missing, adding manually...');
          appApi.updateSharePermission = async function(shareId, permission) {
            return await this.request('/tracker-shares', {
              method: 'PUT',
              body: { shareId, permission }
            });
          };
        }
        if (!appApi.removeShare) {
          console.warn('âš ï¸ removeShare missing, adding manually...');
          appApi.removeShare = async function(shareId) {
            // Don't add trackerId to URL - request() method already adds it
            return await this.request(`/tracker-shares?shareId=${shareId}`, { method: 'DELETE' });
          };
        }
        
        // Workaround: Manually add transferOwnership method if missing (cache issue)
        if (!trackerManager.transferOwnership) {
          console.warn('âš ï¸ transferOwnership missing, adding manually...');
          trackerManager.transferOwnership = async function(trackerId, newOwnerId, newOwnerEmail) {
            try {
              await this.api.transferTrackerOwnership(trackerId, newOwnerId, newOwnerEmail);
              
              // Reload trackers list to reflect ownership change
              this.trackers = await this.api.getTrackers();
              
              // If transferred tracker was current, we might lose access
              const currentTracker = this.trackers.find(t => t.id === trackerId);
              if (!currentTracker || !currentTracker.isOwner) {
                // Switch to first owned tracker or create new one
                const ownedTracker = this.trackers.find(t => t.isOwner);
                if (ownedTracker) {
                  await this.switchTracker(ownedTracker.id);
                } else {
                  const newTracker = await this.createTracker('My Savings Tracker', '');
                }
              }
              
              // Dispatch event
              window.dispatchEvent(new CustomEvent('tracker-ownership-transferred', {
                detail: { trackerId }
              }));
              
              return true;
            } catch (error) {
              console.error('Error transferring tracker ownership:', error);
              throw error;
            }
          };
        }
        
        // Also ensure transferTrackerOwnership exists on API
        if (!appApi.transferTrackerOwnership) {
          console.warn('âš ï¸ transferTrackerOwnership missing on API, adding manually...');
          appApi.transferTrackerOwnership = async function(trackerId, newOwnerId, newOwnerEmail) {
            const url = `${window.location.origin}/api/trackers`;
            const response = await fetch(url, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                ...this.auth?.getHeaders()
              },
              body: JSON.stringify({ 
                id: trackerId, 
                newOwnerId, 
                newOwnerEmail 
              })
            });
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({ error: 'Failed to transfer ownership' }));
              throw new Error(errorData.error || 'Failed to transfer ownership');
            }
            return await response.json();
          };
        }
        
        console.log('âœ… API initialized');
        
        // Initialize tracker UI
        updateLoadingStatus('Setting up UI...');
        console.log('ğŸ¨ Initializing tracker UI...');
        const initializeTrackerUIFn = window.initializeTrackerUI || initializeTrackerUI;
        if (typeof initializeTrackerUIFn === 'function') {
          initializeTrackerUIFn(trackerManager);
          // Initialize rename tracker UI
          initializeRenameTrackerUI(trackerManager);
          // Initialize delete tracker UI
          initializeDeleteTrackerUI(trackerManager);
          // Show tracker switcher
          const trackerSwitcher = document.getElementById('trackerSwitcher');
          if (trackerSwitcher) {
            trackerSwitcher.style.display = 'block';
          }
          console.log('âœ… Tracker UI initialized');
          // Note: Share tracker UI will be initialized after data loads when API is confirmed ready
        } else {
          console.warn('âš ï¸ initializeTrackerUI function not found');
          console.warn('Available functions:', Object.keys(window).filter(k => k.includes('tracker') || k.includes('Tracker')));
        }
        
        // Load data from backend
        updateLoadingStatus('Loading your data...');
        console.log('ğŸ“¥ Loading data from backend...');
        await loadDataFromBackend();
        console.log('âœ… Data loaded:', {
          people: appState.people.length,
          goals: appState.goals.length,
          transactions: appState.transactions.length
        });
        updateLoadingStatus('Data loaded');
        
        // Initial render
        updateLoadingStatus('Rendering dashboard...');
        console.log('ğŸ¨ Rendering UI...');
        renderAll();
        console.log('âœ… Render complete!');
        
        // Initialize share tracker UI now that API is confirmed ready (after getAllData call)
        // Just try to initialize - if methods don't exist, the error will be caught in initializeShareTrackerUI
        if (appApi) {
          console.log('ğŸ”— Attempting to initialize share tracker UI...');
          console.log('appApi type:', typeof appApi);
          console.log('appApi constructor:', appApi.constructor?.name);
          console.log('appApi prototype:', Object.getPrototypeOf(appApi));
          console.log('Has getTrackerShares:', 'getTrackerShares' in appApi);
          console.log('Has shareTracker:', 'shareTracker' in appApi);
          
          // Just initialize it - let the actual function calls handle errors
          try {
            initializeShareTrackerUI(trackerManager, appApi);
            console.log('âœ… Share tracker UI initialization attempted');
          } catch (error) {
            console.error('âŒ Error initializing share tracker UI:', error);
          }
        } else {
          console.error('âŒ Cannot initialize share tracker UI - appApi is null');
        }
        
        // Setup form toggles
        setupFormToggles();
        
        // Small delay before hiding loading screen for smooth transition
        setTimeout(() => {
          hideLoadingScreen();
        }, 300);
      } catch (error) {
        console.error('âŒ App initialization error:', error);
        console.error('Error stack:', error.stack);
        updateLoadingStatus('Error: ' + error.message);
        throw error; // Re-throw so caller can handle
      }
    }

    // Load data from backend API
    async function loadDataFromBackend() {
      try {
        console.log('ğŸ“¡ Fetching data from API...');
        const data = await appApi.getAllData();
        console.log('ğŸ“Š Received data:', data);
        
        // Transform backend data to app state format
        appState = {
          settings: {
            currency: data.settings?.currency || 'PHP',
            locale: data.settings?.locale || 'en-PH',
            currentRatePct: data.settings?.currentRatePct || 12,
            apyPct: data.settings?.apyPct || 3,
            inflationPct: data.settings?.inflationPct || 4
          },
          people: (data.people || []).map(p => {
            const personWithIncomes = {
              id: p.id,
              name: p.name,
              currentSavings: p.currentSavings || 0,
              fixedMonthlyContribution: p.fixedMonthlyContribution || 0,
              incomes: (p.incomes || []).map(i => ({
                id: i.id,
                label: i.label,
                amount: i.amount,
                frequency: i.frequency || 'monthly'
              }))
            };
            console.log(`ğŸ”µ Loaded person ${p.id} (${p.name}) with ${personWithIncomes.incomes.length} incomes:`, personWithIncomes.incomes);
            return personWithIncomes;
          }),
          goals: (data.goals || []).map(g => ({
            id: g.id,
            name: g.name,
            target: g.target,
            deadline: g.deadline,
            owner: g.owner || 'Household',
            priority: g.priority || 999
          })),
          transactions: (data.transactions || []).map(t => ({
            id: t.id,
            date: t.date,
            person: t.person,
            amount: t.amount,
            note: t.note || '',
            goalId: t.goalId || null
          })),
          scenarioRates: data.scenarioRates || [5,10,15,20]
        };

        // If no data, show default sample (for new users)
        if (appState.people.length === 0 && appState.goals.length === 0) {
          console.log('â„¹ï¸ No data found, showing empty state');
        }
      } catch (error) {
        console.error('âŒ Error loading data:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          response: error.response
        });
        // Continue with default state on error - don't block rendering
        console.log('âš ï¸ Continuing with empty state due to error');
      }
    }

    // Save state to backend
    async function saveState(changedSections = ['all']) {
      try {
        // Update settings
        await appApi.updateSettings(appState.settings);
        
        // Note: People, goals, transactions are saved individually when modified
        // This function is called after render, so we don't need to save everything here
        
        // Selective rendering based on what changed
        if(changedSections.includes('all')) {
          renderAll();
        } else {
          updateSections(changedSections);
        }
      } catch (error) {
        console.error('Error saving state:', error);
        // Still render even if save fails
        if(changedSections.includes('all')) {
          renderAll();
        } else {
          updateSections(changedSections);
        }
      }
    }
    
    function updateSections(sections) {
      const updateMap = {
        'settings': () => renderSettings(),
        'people': () => renderPeople(), 
        'goals': () => renderGoals(),
        'rates': () => renderRatesTable(),
        'transactions': () => renderTransactions(),
        'charts': () => {
          buildGrowthChart();
          buildCompareChart(); 
          buildTimelineChart();
        },
        'kpis': () => {
          // Just update KPI values, don't re-render everything
          $('#kpiMonthlyIncome').textContent = fmtMoney(householdMonthlyIncome());
          $('#kpiCurrentSavings').textContent = fmtMoney(currentSavingsHousehold());
        }
      };
      
      sections.forEach(section => {
        if(updateMap[section]) {
          updateMap[section]();
        }
      });
    }

    /********** FINANCE HELPERS **********/
    function toMonthly(amount, freq){ const f=(freq||'').toLowerCase(); return (f==='yearly'||f==='annual'||f==='annually')? amount/12 : amount; }
    function totalMonthlyIncome(p){ return (p.incomes||[]).reduce((s,i)=> s + toMonthly(Number(i.amount||0), i.frequency||'monthly'), 0); }
    function totalMonthlyContribution(p, rate = null){ 
      const income = totalMonthlyIncome(p);
      const rateContrib = rate !== null ? income * (rate / 100) : income * ((appState.settings.currentRatePct || 0) / 100);
      const fixedContrib = Number(p.fixedMonthlyContribution || 0);
      return rateContrib + fixedContrib;
    }
    function householdMonthlyIncome(){ return appState.people.reduce((s,p)=> s + totalMonthlyIncome(p), 0); }
    function householdMonthlyContribution(rate = null){ return appState.people.reduce((s,p)=> s + totalMonthlyContribution(p, rate), 0); }
    function currentSavingsHousehold(){ return appState.people.reduce((s,p)=> s + Number(p.currentSavings||0),0); }
    function txTotal(){ return appState.transactions.reduce((s,t)=> s + Number(t.amount||0), 0); }
    function fmtMoney(x){ const {currency, locale} = appState.settings; if(!isFinite(x)) return 'â€”'; return new Intl.NumberFormat(locale||'en-PH', {style:'currency', currency:currency||'PHP'}).format(x); }
    function monthsBetween(from, to){ const f=new Date(from), t=new Date(to); if(isNaN(f)||isNaN(t)) return 0; let m=(t.getFullYear()-f.getFullYear())*12 + (t.getMonth()-f.getMonth()); if(t.getDate()>f.getDate()) m+=1; return Math.max(0,m); }
    function projectFV({principal=0, monthlyContribution=0, months=60, apyPct=0}){ const i=(apyPct||0)/100/12; if(i===0) return principal + monthlyContribution*months; return principal*Math.pow(1+i, months) + monthlyContribution*((Math.pow(1+i, months)-1)/i); }
    function adjustForInflation(nominal, months, inflationPct){ const j=(inflationPct||0)/100/12; if(j===0) return nominal; return nominal/Math.pow(1+j, months); }
    function monthsToReach({ current, monthlyContribution, target, apyPct }){ if(target<=current) return 0; const i=(apyPct||0)/100/12; let n=0, bal=current; while(n<1200 && bal<target){ bal=bal*(1+i)+monthlyContribution; n++; } return (bal>=target)? n : Infinity; }
    function formatMonthsToYearsMonths(months){ if(!Number.isFinite(months)) return 'â€”'; if(months === 0) return '0 mo'; const years = Math.floor(months / 12); const remainingMonths = months % 12; if(years === 0) return `${months} mo`; if(remainingMonths === 0) return `${years} yr${years > 1 ? 's' : ''}`; return `${years} yr${years > 1 ? 's' : ''} ${remainingMonths} mo`; }

    /********** DOM SHORTHANDS **********/
    const $ = (s)=> document.querySelector(s);
    const $all = (s)=> Array.from(document.querySelectorAll(s));

    /********** NAV UTILS **********/
    $('#printBtn').addEventListener('click', ()=> window.print());
    $('#resetBtn').addEventListener('click', ()=> { if(confirm('Reset to sample data? This will clear all your data.')){ appState = JSON.parse(JSON.stringify(defaultState)); saveState(); } });
    
    // Logout
    $('#logoutBtn').addEventListener('click', async () => {
      if(confirm('Are you sure you want to logout?')) {
        try {
          const authInstance = window.auth || (typeof auth !== 'undefined' ? auth : null);
          if (authInstance && authInstance.signOut) {
            await authInstance.signOut();
          }
          window.location.href = '/login.html';
        } catch (error) {
          console.error('Logout error:', error);
        }
      }
    });

    // Listen for tracker changes
    window.addEventListener('tracker-changed', async () => {
      if (trackerManager) {
        const authInstance = window.auth || (typeof auth !== 'undefined' ? auth : null);
        const SavingsAPIClass = window.SavingsAPI;
        if (authInstance && SavingsAPIClass) {
          appApi = new SavingsAPIClass(authInstance, trackerManager.currentTrackerId);
          trackerManager.api = appApi;
          await loadDataFromBackend();
          renderAll();
        }
      }
    });
    
    // Theme toggle
    function initTheme(){
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-bs-theme', savedTheme);
    }
    
    $('#themeToggle').addEventListener('click', ()=>{
      const current = document.documentElement.getAttribute('data-bs-theme') || 'dark';
      const newTheme = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-bs-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    });
    
    initTheme();
    

    /********** SETTINGS & KPIs **********/
    function renderSettings(){
      $('#currencyCode').value = appState.settings.currency;
      $('#localeSelect').value = appState.settings.locale;
      $('#currentRate').value = appState.settings.currentRatePct;
      $('#apy').value = appState.settings.apyPct;
      $('#inflation').value = appState.settings.inflationPct;

      // KPIs
      $('#kpiCurrentSavings').textContent = fmtMoney(currentSavingsHousehold());
      $('#kpiSavingsRate').textContent = (appState.settings.currentRatePct||0).toFixed(1) + '%';
      
      // Enhanced KPIs
      renderEnhancedKPIs();
      renderGoalsGlance();
      renderSmartInsights();

      // Removed old chart chips since we replaced those charts

      // Owner/Tx selects
      renderOwnerOptions();
    }
    
    function renderEnhancedKPIs() {
      // Emergency Fund Ratio (Emergency fund goal vs 6 months expenses)
      const monthlyIncome = householdMonthlyIncome();
      const emergencyGoal = appState.goals.find(g => g.name.toLowerCase().includes('emergency'));
      if(emergencyGoal) {
        const allocated = goalAllocatedSavings(emergencyGoal.id);
        const unallocated = ownerUnallocatedSavings(emergencyGoal.owner);
        const current = allocated + unallocated;
        const monthsOfExpenses = monthlyIncome > 0 ? current / (monthlyIncome * 0.8) : 0; // Assume 80% of income is expenses
        $('#kpiEmergencyRatio').textContent = `${monthsOfExpenses.toFixed(1)} mo`;
      } else {
        $('#kpiEmergencyRatio').textContent = 'No EF Goal';
      }
      
      // Goals On Track
      const income = householdMonthlyIncome();
      const monthly = income * (appState.settings.currentRatePct||0)/100;
      const apy = appState.settings.apyPct||0;
      
      let onTrackCount = 0;
      appState.goals.forEach(g => {
        const monthsLeft = monthsBetween(new Date(), g.deadline);
        const cur = ownerSavings(g.owner);
        const eta = monthsToReach({ current: cur, monthlyContribution: monthly, target: g.target, apyPct: apy });
        if(isFinite(eta) && eta <= monthsLeft) onTrackCount++;
      });
      
      $('#kpiGoalsOnTrack').textContent = `${onTrackCount}/${appState.goals.length}`;
    }
    
    function renderGoalsGlance() {
      const container = $('#goalsGlance');
      if(appState.goals.length === 0) {
        container.innerHTML = '<div class="muted">No goals set yet</div>';
        return;
      }
      
      const income = householdMonthlyIncome();
      const monthly = income * (appState.settings.currentRatePct||0)/100;
      const apy = appState.settings.apyPct||0;
      
      const goalsHtml = appState.goals.slice()
        .sort((a,b) => (a.priority||999) - (b.priority||999))
        .slice(0, 4) // Show top 4 goals
        .map(g => {
          const allocated = goalAllocatedSavings(g.id);
          const unallocated = ownerUnallocatedSavings(g.owner);
          const current = allocated + unallocated;
          const progress = Math.min(100, (current / g.target) * 100);
          
          const monthsLeft = monthsBetween(new Date(), g.deadline);
          const eta = monthsToReach({ current: current, monthlyContribution: monthly, target: g.target, apyPct: apy });
          const isOnTrack = isFinite(eta) && eta <= monthsLeft;
          
          const statusEmoji = isOnTrack ? 'âœ…' : (isFinite(eta) ? 'âš ï¸' : 'âŒ');
          const statusText = isOnTrack ? 'On Track' : (isFinite(eta) ? 'Delayed' : 'At Risk');
          
          return `
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between">
                  <span class="small fw-semibold">${g.name}</span>
                  <span class="small">${progress.toFixed(0)}% ${statusEmoji}</span>
                </div>
                <div class="progress mt-1" style="height:4px;">
                  <div class="progress-bar" style="width:${progress}%"></div>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
      container.innerHTML = goalsHtml;
    }
    
    function renderSmartInsights() {
      const container = $('#smartInsights');
      const insights = [];
      
      const currentRate = appState.settings.currentRatePct || 0;
      const apy = appState.settings.apyPct || 0;
      const inflation = appState.settings.inflationPct || 0;
      const monthlyIncome = householdMonthlyIncome();
      const monthlySavings = monthlyIncome * (currentRate / 100);
      
      // Rate insight
      if(currentRate >= 15) {
        insights.push(`ğŸ‰ Excellent! You're saving ${currentRate}% - well above the recommended 10-15%.`);
      } else if(currentRate >= 10) {
        insights.push(`âœ… Good savings rate of ${currentRate}%. Consider pushing to 15% if possible.`);
      } else if(currentRate > 0) {
        insights.push(`ğŸ“ˆ Current ${currentRate}% rate is a start. Aim for 10-15% for optimal wealth building.`);
      }
      
      // APY vs Inflation
      if(apy < inflation) {
        insights.push(`âš ï¸ Your ${apy}% APY is below ${inflation}% inflation. Consider higher-yield options.`);
      } else if(apy > inflation + 2) {
        insights.push(`ğŸš€ Great! Your ${apy}% APY beats inflation by ${(apy - inflation).toFixed(1)}%.`);
      }
      
      // Goal progress insight
      if(appState.goals.length > 0) {
        const income = householdMonthlyIncome();
        const monthly = income * (currentRate/100);
        const nextGoal = appState.goals
          .map(g => {
            const cur = ownerSavings(g.owner);
            const eta = monthsToReach({ current: cur, monthlyContribution: monthly, target: g.target, apyPct: apy });
            return { ...g, eta };
          })
          .filter(g => isFinite(g.eta))
          .sort((a,b) => a.eta - b.eta)[0];
          
        if(nextGoal) {
          const timeText = formatMonthsToYearsMonths(nextGoal.eta);
          insights.push(`ğŸ¯ "${nextGoal.name}" will be complete in ${timeText} at current pace.`);
        }
      }
      
      // Recent activity insight
      const recentTx = appState.transactions.slice(0, 5);
      const totalRecent = recentTx.reduce((sum, t) => sum + t.amount, 0);
      if(totalRecent > monthlySavings * 1.2) {
        insights.push(`ğŸ”¥ You're ahead of your savings target this month! Keep it up.`);
      }
      
      if(insights.length === 0) {
        insights.push('ğŸ“Š Keep tracking your progress! Insights will appear as you add more data.');
      }
      
      container.innerHTML = insights.slice(0, 3).map(insight => 
        `<div class="small mb-2 p-2 rounded" style="background: var(--panel); border: 1px solid rgba(255,255,255,.08);">${insight}</div>`
      ).join('');
    }
    $('#saveSettingsBtn').addEventListener('click', async ()=>{
      const currency = $('#currencyCode').value;
      const locale = $('#localeSelect').value;
      const currentRatePct = Number($('#currentRate').value);
      const apyPct = Number($('#apy').value);
      const inflationPct = Number($('#inflation').value);
      if(currentRatePct<0 || apyPct<0 || inflationPct<0) return showAlert('Invalid negative value', 'warning');
      
      showCrudLoading('Saving settings...', 'Updating financial parameters');
      
      try {
        appState.settings = { currency, locale, currentRatePct, apyPct, inflationPct };
        await appApi.updateSettings(appState.settings);
        saveState();
        hideCrudLoading();
        showAlert('âœ… Settings saved successfully!', 'success');
      } catch (error) {
        hideCrudLoading();
        showAlert('Failed to save settings: ' + error.message, 'danger');
      }
    });

    /********** PEOPLE **********/
    function renderOwnerOptions(){
      const s = '<option>Household</option>' + appState.people.map(p=> `<option>${p.name}</option>`).join('');
      $('#goalOwner').innerHTML = s;
      $('#txPerson').innerHTML = appState.people.map(p=> `<option>${p.name}</option>`).join('');
    }
    function findPersonById(id){ return appState.people.find(x=> x.id===id); }

    function renderPeople(){
      const host = $('#peopleList'); 
      const emptyState = $('#peopleEmptyState');
      host.innerHTML='';
      
      if (appState.people.length === 0) {
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      appState.people.forEach((p, index) => {
        const col = document.createElement('div'); 
        col.className = 'col-12 col-lg-6';
        
        const monthly = totalMonthlyIncome(p);
        const fixedContrib = Number(p.fixedMonthlyContribution || 0);
        const totalContribution = totalMonthlyContribution(p);
        const hasIncomes = (p.incomes || []).length > 0;
        const incomeId = `income-${p.id}`;
        
        const incomes = (p.incomes||[]).map((i, idx) => `
          <div class="income-row mb-2 p-3 rounded" style="background: var(--panel); border: 1px solid rgba(255,255,255,.08); transition: all 0.2s;">
            <div class="row g-2 align-items-center">
              <div class="col-4">
                <input class="form-control form-control-sm" value="${i.label}" placeholder="Income source" data-ptype="incomeLabel" data-pid="${p.id}" data-iid="${i.id}" style="border-radius: 8px; border: 1px solid rgba(255,255,255,.1);"/>
              </div>
              <div class="col-4">
                <input class="form-control form-control-sm text-end" type="number" step="0.01" value="${i.amount}" placeholder="0" data-ptype="incomeAmount" data-pid="${p.id}" data-iid="${i.id}" style="border-radius: 8px; border: 1px solid rgba(255,255,255,.1);"/>
              </div>
              <div class="col-3">
                <select class="form-select form-select-sm" data-ptype="incomeFreq" data-pid="${p.id}" data-iid="${i.id}" style="border-radius: 8px; border: 1px solid rgba(255,255,255,.1);">
                  <option ${i.frequency==='monthly'?'selected':''}>Monthly</option>
                  <option ${['yearly','annual','annually'].includes(i.frequency)?'selected':''}>Yearly</option>
                </select>
              </div>
              <div class="col-1 text-end">
                <button class="btn btn-sm p-0" data-act="delIncome" data-pid="${p.id}" data-iid="${i.id}" style="color: var(--muted); border: none; background: none; opacity: 0.6; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          </div>
        `).join('');

        col.innerHTML = `
          <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; transition: transform 0.2s, box-shadow 0.2s; background: var(--bg);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
            <div class="card-body p-4">
              <!-- Header -->
              <div class="d-flex align-items-start justify-content-between mb-4">
                <div class="d-flex align-items-center">
                  <div class="me-3" style="width: 56px; height: 56px; border-radius: 14px; background: linear-gradient(135deg, rgba(89, 162, 255, 0.2), rgba(138, 125, 255, 0.2)); display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">
                    ğŸ‘¤
                  </div>
                  <div>
                    <input class="form-control border-0 p-0 fw-bold fs-5" value="${p.name}" data-ptype="name" data-pid="${p.id}" style="background: transparent; max-width: 200px; font-weight: 600;" placeholder="Name"/>
                    <div class="text-muted small mt-1">Contributor</div>
                  </div>
                </div>
                <button class="btn btn-sm btn-outline-danger" data-act="delPerson" data-pid="${p.id}" style="border-radius: 8px; padding: 0.4rem 0.8rem;">
                  ğŸ—‘ï¸
                </button>
              </div>

              <!-- Stats Grid -->
              <div class="row g-3 mb-4">
                <div class="col-6">
                  <div class="p-3 rounded" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                    <div class="text-muted small mb-1" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;">Current Savings</div>
                    <div class="fw-bold fs-5" style="color: #10b981;">${fmtMoney(p.currentSavings || 0)}</div>
                    <input class="form-control form-control-sm mt-2" type="number" step="0.01" value="${p.currentSavings || 0}" data-ptype="savings" data-pid="${p.id}" placeholder="0" style="border-radius: 8px; border: 1px solid rgba(255,255,255,.1);"/>
                  </div>
                </div>
                <div class="col-6">
                  <div class="p-3 rounded" style="background: rgba(89, 162, 255, 0.1); border: 1px solid rgba(89, 162, 255, 0.2);">
                    <div class="text-muted small mb-1" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px;">Monthly Contribution</div>
                    <div class="fw-bold fs-5" style="color: var(--brand);">${fmtMoney(totalContribution)}</div>
                    <div class="small text-muted mt-1">
                      ${monthly > 0 ? `<span class="badge bg-primary bg-opacity-20 text-white me-1">ğŸ“Š Rate-based</span>` : ''}
                      ${fixedContrib > 0 ? `<span class="badge bg-success bg-opacity-20 text-white">Fixed: ${fmtMoney(fixedContrib)}</span>` : ''}
                      ${totalContribution === 0 ? '<span class="text-muted">No contribution set</span>' : ''}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Fixed Monthly Input -->
              <div class="mb-4">
                <label class="form-label small fw-semibold text-muted mb-2" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Fixed Monthly Contribution</label>
                <div class="input-group">
                  <input class="form-control" type="number" step="0.01" value="${fixedContrib}" data-ptype="fixedContrib" data-pid="${p.id}" placeholder="0" style="border-radius: 8px; border: 1px solid rgba(255,255,255,.1);"/>
                  <span class="input-group-text bg-transparent border-0 text-muted small" style="font-size: 0.75rem;">Optional</span>
                </div>
                <small class="text-muted" style="font-size: 0.7rem;">Fixed amount regardless of savings rate</small>
              </div>

              <!-- Income Section -->
              <div class="border-top pt-4" style="border-color: rgba(255,255,255,.1) !important;">
                <div class="d-flex align-items-center justify-content-between mb-3">
                  <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" data-act="toggleIncome" data-pid="${p.id}" style="border-radius: 8px; padding: 0.25rem 0.5rem;" title="Toggle income visibility">
                      <span id="incomeToggleIcon-${p.id}">ğŸ‘ï¸</span>
                    </button>
                    <div>
                      <h6 class="mb-0 fw-semibold">ğŸ’° Income Sources</h6>
                      <small class="text-muted">${hasIncomes ? `${p.incomes.length} source${p.incomes.length !== 1 ? 's' : ''}` : 'No income sources yet'}</small>
                    </div>
                  </div>
                  <button class="btn btn-sm btn-outline-primary" data-act="addIncome" data-pid="${p.id}" style="border-radius: 8px;">
                    <span style="font-size: 1rem;">+</span> Add Income
                  </button>
                </div>
                <div id="${incomeId}" class="income-list" style="display: none;">
                  ${hasIncomes ? incomes : `
                    <div class="text-center py-4 text-muted" style="font-size: 0.9rem;">
                      <div class="mb-2" style="font-size: 2rem;">ğŸ’¼</div>
                      <div>No income sources yet</div>
                      <small>Click "Add Income" to get started</small>
                    </div>
                  `}
                </div>
              </div>
            </div>
          </div>
        `;
        host.appendChild(col);
      });

      // Bind income toggle buttons
      $all('#peopleList [data-act="toggleIncome"]').forEach(btn=> {
        btn.addEventListener('click', ()=>{
          const pid = btn.dataset.pid;
          const incomeList = $(`#income-${pid}`);
          const icon = $(`#incomeToggleIcon-${pid}`);
          
          if(incomeList) {
            const isVisible = incomeList.style.display !== 'none';
            incomeList.style.display = isVisible ? 'none' : 'block';
            if(icon) {
              // When hidden, show eye (click to show). When visible, show eye with slash (click to hide)
              icon.textContent = isVisible ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
            }
          }
        });
      });
      
      // Bind changes
      $all('#peopleList [data-ptype]').forEach(el=>{
        el.addEventListener('change', async e=>{
          const pid = e.target.dataset.pid;
          const type = e.target.dataset.ptype;
          const p = findPersonById(pid); if(!p) return;
          
          let updateMessage = '';
          if(type==='name') { 
            p.name = e.target.value.trim()||'Person';
            updateMessage = `Updating ${p.name}'s name...`;
          }
          if(type==='savings'){ 
            const v=Number(e.target.value); 
            if(!isFinite(v)||v<0) return showAlert('Invalid savings amount', 'warning'); 
            p.currentSavings=v;
            updateMessage = `Updating ${p.name}'s savings...`;
          }
          if(type==='fixedContrib'){ 
            const v=Number(e.target.value); 
            if(!isFinite(v)||v<0) return showAlert('Invalid fixed contribution', 'warning'); 
            p.fixedMonthlyContribution=v;
            updateMessage = `Updating ${p.name}'s contribution...`;
          }
          if(type==='incomeLabel' || type==='incomeAmount' || type==='incomeFreq'){
            const inc = p.incomes.find(i=> i.id===e.target.dataset.iid); if(!inc) return;
            if(type==='incomeLabel') {
              inc.label = e.target.value.trim()||'Income';
              updateMessage = `Updating income source...`;
            }
            if(type==='incomeAmount'){ 
              const v=Number(e.target.value); 
              if(!isFinite(v)||v<0) return showAlert('Invalid income amount', 'warning'); 
              inc.amount=v;
              updateMessage = `Updating income amount...`;
            }
            if(type==='incomeFreq'){ 
              const v=(e.target.value||'monthly').toLowerCase(); 
              inc.frequency = ['monthly','yearly','annual','annually'].includes(v)? v : 'monthly';
              updateMessage = `Updating income frequency...`;
            }
          }
          
          if(updateMessage) {
            showCrudLoading(updateMessage);
          }
          
          // Save to backend
          try {
            // Ensure incomes array exists and is properly formatted
            if (!p.incomes) p.incomes = [];
            const personData = {
              id: p.id,
              name: p.name || 'Person',
              currentSavings: Number(p.currentSavings) || 0,
              fixedMonthlyContribution: Number(p.fixedMonthlyContribution) || 0,
              incomes: p.incomes.map(inc => ({
                id: inc.id || uid(),
                label: inc.label || 'Income',
                amount: Number(inc.amount) || 0,
                frequency: inc.frequency || 'monthly'
              }))
            };
            console.log('Updating person:', personData);
            await appApi.updatePerson(personData);
            saveState();
            hideCrudLoading();
          } catch (error) {
            hideCrudLoading();
            console.error('Error updating person:', error);
            showAlert('Failed to save changes: ' + (error.message || 'Unknown error'), 'danger');
            // Don't update UI state if save failed
          }
        });
      });
      $all('#peopleList [data-act="addIncome"]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const p = findPersonById(btn.dataset.pid); if(!p) return;
        if (!p.incomes) p.incomes = [];
        p.incomes.push({ id:uid(), label:'Income', amount:0, frequency:'monthly' });
        const personData = {
          id: p.id,
          name: p.name || 'Person',
          currentSavings: Number(p.currentSavings) || 0,
          fixedMonthlyContribution: Number(p.fixedMonthlyContribution) || 0,
          incomes: p.incomes.map(inc => ({
            id: inc.id || uid(),
            label: inc.label || 'Income',
            amount: Number(inc.amount) || 0,
            frequency: inc.frequency || 'monthly'
          }))
        };
        console.log('ğŸ”µ Adding income - Person ID:', p.id);
        console.log('ğŸ”µ Adding income - All people IDs:', appState.people.map(p => p.id));
        console.log('ğŸ”µ Adding income - Person data being sent:', JSON.stringify(personData, null, 2));
        try {
          console.log('Adding income, updating person:', personData);
          console.log('Income details:', personData.incomes);
          await appApi.updatePerson(personData);
          // Don't call saveState() here - updatePerson already saves to backend
          // saveState() only saves settings, not people
          console.log('âœ… Income added successfully');
          renderPeople(); // Re-render to show new income
        } catch (error) {
          console.error('Error adding income:', error);
          console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            personId: p.id,
            personName: p.name,
            incomes: p.incomes
          });
          showAlert('Failed to add income: ' + (error.message || 'Unknown error'), 'danger');
          // Remove the income from local state if save failed
          p.incomes = p.incomes.slice(0, -1);
          renderPeople();
        }
      }));
      $all('#peopleList [data-act="delIncome"]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const p = findPersonById(btn.dataset.pid); if(!p) return;
        const incomeId = btn.dataset.iid;
        const originalIncomes = [...(p.incomes || [])];
        p.incomes = (p.incomes||[]).filter(i=> i.id!==incomeId);
        try {
          const personData = {
            id: p.id,
            name: p.name || 'Person',
            currentSavings: Number(p.currentSavings) || 0,
            fixedMonthlyContribution: Number(p.fixedMonthlyContribution) || 0,
            incomes: (p.incomes || []).map(inc => ({
              id: inc.id || uid(),
              label: inc.label || 'Income',
              amount: Number(inc.amount) || 0,
              frequency: inc.frequency || 'monthly'
            }))
          };
          console.log('Deleting income, updating person:', personData);
          await appApi.updatePerson(personData);
          saveState();
          renderPeople(); // Re-render to reflect deletion
        } catch (error) {
          console.error('Error deleting income:', error);
          showAlert('Failed to delete income: ' + (error.message || 'Unknown error'), 'danger');
          // Restore original incomes if save failed
          p.incomes = originalIncomes;
          renderPeople();
        }
      }));
      $all('#peopleList [data-act="delPerson"]').forEach(btn=> btn.addEventListener('click', async ()=>{
        if(!confirm('Delete person and their incomes?')) return;
        const pid = btn.dataset.pid;
        const name = (appState.people.find(x=>x.id===pid)||{}).name;
        showCrudLoading('Deleting person...', `Removing ${name} and their data`);
        try {
          await appApi.deletePerson(pid);
          appState.people = appState.people.filter(x=> x.id!==pid);
          // reassign goals/transactions
          appState.goals = appState.goals.map(g => g.owner===name ? {...g, owner:'Household'} : g);
          appState.transactions = appState.transactions.map(t => t.person===name ? {...t, person:'(Removed)'} : t);
          saveState();
          hideCrudLoading();
          renderPeople();
        } catch (error) {
          hideCrudLoading();
          showAlert('Failed to delete person: ' + error.message, 'danger');
        }
      }));
    }
    $('#addPersonBtn').addEventListener('click', async ()=>{
      const name = ($('#personName').value||'').trim()||'Person';
      const sav = Number($('#personSavings').value||0); 
      if(!isFinite(sav)||sav<0) {
        showAlert('Please enter a valid savings amount', 'warning');
        return;
      }
      const fixedContrib = Number($('#personFixedContribution').value||0); 
      if(!isFinite(fixedContrib)||fixedContrib<0) {
        showAlert('Please enter a valid fixed contribution amount', 'warning');
        return;
      }
      
      showCrudLoading('Adding person...', `Creating ${name} with ${fmtMoney(sav)} savings`);
      
      try {
        const newPerson = {
          id: uid(),
          name,
          currentSavings: sav,
          fixedMonthlyContribution: fixedContrib,
          incomes: []
        };
        
        await appApi.createPerson(newPerson);
        appState.people.push(newPerson);
        
        $('#personName').value=''; 
        $('#personSavings').value=''; 
        $('#personFixedContribution').value='';
        
        hideCrudLoading();
        showAlert(`${name} added successfully!`, 'success');
        saveState();
        renderPeople();
      } catch (error) {
        hideCrudLoading();
        showAlert('Failed to add person: ' + error.message, 'danger');
      }
    });

    /********** GOALS **********/
    function ownerSavings(owner){
      if(owner==='Household') return currentSavingsHousehold();
      const p = appState.people.find(x=> x.name===owner);
      return p ? Number(p.currentSavings||0) : 0;
    }
    
    function goalAllocatedSavings(goalId) {
      // Calculate savings allocated specifically to this goal
      return appState.transactions
        .filter(t => t.goalId === goalId)
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);
    }
    
    function ownerUnallocatedSavings(owner) {
      // Calculate savings not allocated to any specific goal
      const totalSavings = ownerSavings(owner);
      const allocatedSavings = appState.transactions
        .filter(t => t.goalId && (owner === 'Household' || t.person === owner))
        .reduce((sum, t) => sum + Number(t.amount || 0), 0);
      return Math.max(0, totalSavings - allocatedSavings);
    }
    function renderGoals(){
      renderOwnerOptions();
      const host = $('#goalsList'); 
      const emptyState = $('#goalsEmptyState');
      const filterBar = $('#goalsFilterBar');
      const requiredCard = $('#goalsRequiredCard');
      
      host.innerHTML='';
      
      if (appState.goals.length === 0) {
        emptyState.style.display = 'block';
        filterBar.style.display = 'none';
        requiredCard.style.display = 'none';
        return;
      }
      
      emptyState.style.display = 'none';
      filterBar.style.display = 'block';
      
      // Update filter options
      const ownerSelect = $('#goalsFilterOwner');
      if (ownerSelect) {
        const currentValue = ownerSelect.value;
        ownerSelect.innerHTML = '<option value="">All Owners</option><option value="Household">Household</option>' + 
          appState.people.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        if (currentValue) ownerSelect.value = currentValue;
      }
      
      // Get filter values
      const searchTerm = $('#goalsSearch')?.value?.toLowerCase() || '';
      const filterOwner = $('#goalsFilterOwner')?.value || '';
      const filterStatus = $('#goalsFilterStatus')?.value || '';
      
      const income = householdMonthlyIncome();
      const monthly = income * (appState.settings.currentRatePct||0)/100;
      const apy = appState.settings.apyPct||0;
      
      // Filter and sort goals
      let filteredGoals = appState.goals.slice()
        .filter(g => {
          if (searchTerm && !g.name.toLowerCase().includes(searchTerm)) return false;
          if (filterOwner && g.owner !== filterOwner) return false;
          if (filterStatus) {
            const monthsLeft = monthsBetween(new Date(), g.deadline);
            const allocatedSavings = goalAllocatedSavings(g.id);
            const unallocatedSavings = ownerUnallocatedSavings(g.owner);
            const cur = allocatedSavings + unallocatedSavings;
            const eta = monthsToReach({ current: cur, monthlyContribution: monthly, target: g.target, apyPct: apy });
            const isOnTrack = isFinite(eta) && eta <= monthsLeft;
            const isCompleted = cur >= g.target;
            
            if (filterStatus === 'on-track' && !isOnTrack) return false;
            if (filterStatus === 'at-risk' && (isOnTrack || isCompleted)) return false;
            if (filterStatus === 'completed' && !isCompleted) return false;
          }
          return true;
        })
        .sort((a,b)=>(a.priority||999)-(b.priority||999));
      
      // Update count
      const countEl = $('#goalsCount');
      if (countEl) {
        countEl.textContent = `${filteredGoals.length} goal${filteredGoals.length !== 1 ? 's' : ''}`;
      }
      
      filteredGoals.forEach(g=>{
        const monthsLeft = monthsBetween(new Date(), g.deadline);
        const allocatedSavings = goalAllocatedSavings(g.id);
        const totalOwnerSavings = ownerSavings(g.owner);
        const unallocatedSavings = ownerUnallocatedSavings(g.owner);
        
        const cur = allocatedSavings + unallocatedSavings;
        const pct = Math.min(100, cur/Math.max(1,g.target)*100);
        const need = Math.max(0, g.target - cur);
        const req = monthsLeft? need/monthsLeft : Infinity;
        
        // Calculate status
        const eta = monthsToReach({ current: cur, monthlyContribution: monthly, target: g.target, apyPct: apy });
        const isOnTrack = isFinite(eta) && eta <= monthsLeft;
        const isCompleted = pct >= 100;
        const isAtRisk = !isCompleted && (!isFinite(eta) || eta > monthsLeft);
        
        // Status colors and badges
        let statusBadge = '';
        let statusColor = '';
        if (isCompleted) {
          statusBadge = '<span class="badge bg-success bg-opacity-20 text-white">ğŸ‰ Completed</span>';
          statusColor = '#10b981';
        } else if (isOnTrack) {
          statusBadge = '<span class="badge bg-primary bg-opacity-20 text-white">âœ… On Track</span>';
          statusColor = '#3b82f6';
        } else {
          statusBadge = '<span class="badge bg-warning bg-opacity-20 text-white">âš ï¸ At Risk</span>';
          statusColor = '#f59e0b';
        }
        
        // Priority indicator
        const priorityNum = g.priority || 999;
        const priorityBadge = priorityNum <= 3 ? 
          `<span class="badge bg-danger bg-opacity-20 text-white">ğŸ”¥ High</span>` :
          priorityNum <= 5 ?
          `<span class="badge bg-warning bg-opacity-20 text-white">âš¡ Medium</span>` :
          `<span class="badge bg-secondary bg-opacity-20 text-white">ğŸ“Œ Low</span>`;
        
        const col = document.createElement('div'); 
        col.className = 'col-12 col-md-6 col-lg-4'; // Responsive: 1 col mobile, 2 tablet, 3 desktop
        
        col.innerHTML = `
          <div class="card border-0 shadow-sm h-100" style="border-radius: 16px; transition: transform 0.2s, box-shadow 0.2s; background: var(--bg);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
            <div class="card-body p-4">
              <!-- Header -->
              <div class="d-flex align-items-start justify-content-between mb-3">
                <div class="flex-grow-1">
                  <input class="form-control border-0 p-0 fw-bold fs-5 mb-1" value="${g.name}" data-gbind="name" data-gid="${g.id}" style="background: transparent; font-weight: 600;" placeholder="Goal name"/>
                  <div class="d-flex gap-2 flex-wrap">
                    ${statusBadge}
                    ${priorityBadge}
                  </div>
                </div>
                <button class="btn btn-sm btn-outline-danger p-1" data-act="delGoal" data-gid="${g.id}" style="border-radius: 8px; width: 32px; height: 32px; padding: 0;">
                  ğŸ—‘ï¸
                </button>
              </div>

              <!-- Progress Bar -->
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="small text-muted">Progress</span>
                  <span class="small fw-bold" style="color: ${statusColor};">${pct.toFixed(0)}%</span>
                </div>
                <div class="progress" style="height: 8px; border-radius: 10px; background: rgba(255,255,255,.1);">
                  <div class="progress-bar" style="width: ${pct}%; background: ${statusColor}; border-radius: 10px;"></div>
                </div>
                <div class="d-flex justify-content-between mt-1">
                  <span class="small text-muted">${fmtMoney(cur)}</span>
                  <span class="small text-muted">${fmtMoney(g.target)}</span>
                </div>
              </div>

              <!-- Key Metrics -->
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <div class="p-2 rounded" style="background: rgba(89, 162, 255, 0.1); border: 1px solid rgba(89, 162, 255, 0.2);">
                    <div class="text-muted small" style="font-size: 0.65rem; text-transform: uppercase;">Time Left</div>
                    <div class="fw-bold small" style="color: var(--brand);">${formatMonthsToYearsMonths(monthsLeft)}</div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="p-2 rounded" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2);">
                    <div class="text-muted small" style="font-size: 0.65rem; text-transform: uppercase;">Monthly Need</div>
                    <div class="fw-bold small" style="color: #10b981;">${isFinite(req)?fmtMoney(req):'â€”'}</div>
                  </div>
                </div>
              </div>

              <!-- Editable Fields (Compact) -->
              <div class="border-top pt-3" style="border-color: rgba(255,255,255,.1) !important;">
                <div class="row g-2 mb-2">
                  <div class="col-6">
                    <label class="form-label small text-muted mb-1" style="font-size: 0.7rem;">Target</label>
                    <input class="form-control form-control-sm" type="number" step="0.01" value="${g.target}" data-gbind="target" data-gid="${g.id}" style="border-radius: 8px;"/>
                  </div>
                  <div class="col-6">
                    <label class="form-label small text-muted mb-1" style="font-size: 0.7rem;">Deadline</label>
                    <input class="form-control form-control-sm" type="date" value="${g.deadline}" data-gbind="deadline" data-gid="${g.id}" style="border-radius: 8px;"/>
                  </div>
                </div>
                <div class="row g-2">
                  <div class="col-6">
                    <label class="form-label small text-muted mb-1" style="font-size: 0.7rem;">Owner</label>
                    <select class="form-select form-select-sm" data-gbind="owner" data-gid="${g.id}" style="border-radius: 8px;">
                      <option ${g.owner==='Household'?'selected':''}>Household</option>
                      ${appState.people.map(p=> `<option ${g.owner===p.name?'selected':''}>${p.name}</option>`).join('')}
                    </select>
                  </div>
                  <div class="col-6">
                    <label class="form-label small text-muted mb-1" style="font-size: 0.7rem;">Priority</label>
                    <input class="form-control form-control-sm" type="number" value="${priorityNum}" min="1" data-gbind="priority" data-gid="${g.id}" style="border-radius: 8px;"/>
                  </div>
                </div>
              </div>

              <!-- Savings Breakdown (Compact) -->
              <div class="mt-3 pt-3 border-top" style="border-color: rgba(255,255,255,.1) !important;">
                <div class="small text-muted">
                  ${allocatedSavings > 0 ? 
                    `ğŸ¯ Allocated: ${fmtMoney(allocatedSavings)}<br>` : 
                    ''
                  }
                  ğŸ’° Available: ${fmtMoney(unallocatedSavings)}
                </div>
              </div>
            </div>
          </div>
        `;
        host.appendChild(col);
      });

      // Bind changes
      $all('#goalsList [data-gbind]').forEach(el=>{
        el.addEventListener('change', async e=>{
          const gid=e.target.dataset.gid; const k=e.target.dataset.gbind;
          const g=appState.goals.find(x=>x.id===gid); if(!g) return;
          
          let updateMessage = '';
          if(k==='name') {
            g.name=e.target.value.trim()||'Goal';
            updateMessage = `Updating goal name...`;
          }
          if(k==='target'){ 
            const v=Number(e.target.value); 
            if(!isFinite(v)||v<=0) return showAlert('Invalid target amount', 'warning'); 
            g.target=v;
            updateMessage = `Updating goal target...`;
          }
          if(k==='deadline'){ 
            if(!e.target.value) return showAlert('Invalid deadline', 'warning'); 
            g.deadline=e.target.value;
            updateMessage = `Updating goal deadline...`;
          }
          if(k==='owner') {
            g.owner=e.target.value;
            updateMessage = `Updating goal owner...`;
          }
          if(k==='priority'){ 
            const v=Math.max(1, Math.floor(Number(e.target.value||1))); 
            g.priority=v;
            updateMessage = `Updating goal priority...`;
          }
          
          if(updateMessage) {
            showCrudLoading(updateMessage);
          }
          
          // Save to backend
          try {
            await appApi.updateGoal(g);
            saveState();
            hideCrudLoading();
          } catch (error) {
            console.error('Error updating goal:', error);
            hideCrudLoading();
            saveState(); // Still update UI
          }
        });
      });
      $all('#goalsList [data-act="delGoal"]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const gid = btn.dataset.gid;
        const goalName = appState.goals.find(g => g.id === gid)?.name || '';
        if (!confirm(`Delete goal "${goalName}"?`)) return;
        showCrudLoading('Deleting goal...', `Removing ${goalName}`);
        try {
          await appApi.deleteGoal(gid);
          appState.goals = appState.goals.filter(x=> x.id!==gid);
          saveState();
          hideCrudLoading();
          renderGoals();
        } catch (error) {
          hideCrudLoading();
          showAlert('Failed to delete goal: ' + error.message, 'danger');
        }
      }));
      
      // Search and filter handlers (only add once)
      const searchInput = $('#goalsSearch');
      const ownerFilter = $('#goalsFilterOwner');
      const statusFilter = $('#goalsFilterStatus');
      
      if (searchInput && !searchInput.dataset.listenerAdded) {
        searchInput.addEventListener('input', () => renderGoals());
        searchInput.dataset.listenerAdded = 'true';
      }
      if (ownerFilter && !ownerFilter.dataset.listenerAdded) {
        ownerFilter.addEventListener('change', () => renderGoals());
        ownerFilter.dataset.listenerAdded = 'true';
      }
      if (statusFilter && !statusFilter.dataset.listenerAdded) {
        statusFilter.addEventListener('change', () => renderGoals());
        statusFilter.dataset.listenerAdded = 'true';
      }
      
      // Render monthly requirements if there are goals
      if (appState.goals.length > 0) {
        renderGoalsRequired();
        requiredCard.style.display = 'block';
      } else {
        requiredCard.style.display = 'none';
      }
    }
    $('#addGoalBtn').addEventListener('click', async ()=>{
      const name=($('#goalName').value||'').trim()||'Goal';
      const target=Number($('#goalTarget').value); 
      if(!isFinite(target)||target<=0) {
        showAlert('Please enter a valid target amount', 'warning');
        return;
      }
      const deadline=$('#goalDeadline').value; 
      if(!deadline) {
        showAlert('Please set a deadline', 'warning');
        return;
      }
      const owner=$('#goalOwner').value||'Household';
      const priority=Math.max(1, Math.floor(Number($('#goalPriority').value||1)));
      
      showCrudLoading('Creating goal...', `Setting up ${name} with target ${fmtMoney(target)}`);
      
      try {
        const newGoal = { id:uid(), name, target, deadline, owner, priority };
        await appApi.createGoal(newGoal);
        appState.goals.push(newGoal);
        
        $('#goalName').value=''; 
        $('#goalTarget').value=''; 
        $('#goalDeadline').value=''; 
        $('#goalPriority').value='1';
        
        hideCrudLoading();
        showAlert(`${name} goal created successfully!`, 'success');
        saveState();
        renderGoals();
      } catch (error) {
        hideCrudLoading();
        showAlert('Failed to add goal: ' + error.message, 'danger');
      }
    });

    function renderGoalsRequired(){
      const host = $('#goalsRequiredList'); host.innerHTML='';
      const rate = (appState.settings.currentRatePct||0)/100;
      const monthly = householdMonthlyIncome() * rate;
      const apy = appState.settings.apyPct||0;
      appState.goals.slice().sort((a,b)=>(a.priority||999)-(b.priority||999)).forEach(g=>{
        const monthsLeft = monthsBetween(new Date(), g.deadline);
        const cur = ownerSavings(g.owner);
        const need = Math.max(0, g.target - cur);
        const required = monthsLeft? need/monthsLeft : Infinity;
        const eta = monthsToReach({ current: cur, monthlyContribution: monthly, target: g.target, apyPct: apy });
        const col = document.createElement('div'); col.className='col-12';
        col.innerHTML = `
          <div class="card p-3">
            <div class="row g-3 align-items-center">
              <div class="col-md-6"><b>${g.name}</b> <span class="chip">Owner: ${g.owner}</span> <span class="chip">Priority: ${g.priority||1}</span>
                <div class="muted">Target ${fmtMoney(g.target)} â€¢ Current ${fmtMoney(cur)} â€¢ Time left ${formatMonthsToYearsMonths(monthsLeft)}</div>
              </div>
              <div class="col-md-3">
                <div class="muted">Required / mo</div>
                <div class="fs-6 fw-semibold">${isFinite(required)?fmtMoney(required):'â€”'}</div>
              </div>
              <div class="col-md-3">
                <div class="muted">ETA at plan</div>
                <div class="fs-6 fw-semibold">${isFinite(eta)? formatMonthsToYearsMonths(eta) : 'Not reachable'}</div>
              </div>
            </div>
          </div>`;
        host.appendChild(col);
      });
    }

    /********** RATES (per-person process) - OPTIMIZED TABLE FOR DECISION MAKING **********/
    function renderRatesTable(){
      const tbody = $('#ratesTableBody');
      tbody.innerHTML = '';

      const principal = currentSavingsHousehold();
      const apy = appState.settings.apyPct || 0;
      const householdIncome = householdMonthlyIncome();
      
      // Header info elements were removed in UI redesign - skip this

      appState.scenarioRates.forEach(r => {
        const rate = Number(r) || 0;
        const isCurrentRate = rate === (appState.settings.currentRatePct || 0);

        // Filter to only selected contributors
        const selectedPeople = appState.people.filter(p => 
          scenarioFilters.selectedContributors.includes(p.id)
        );

        // Perâ€‘person contributions (rate-based + fixed) - only selected people
        const rows = selectedPeople.map(p => {
          const inc = totalMonthlyIncome(p);
          const rateBasedContrib = inc * (rate / 100);
          const fixedContrib = Number(p.fixedMonthlyContribution || 0);
          const totalContrib = rateBasedContrib + fixedContrib;
          
          return { 
            name: p.name, 
            contribution: totalContrib,
            rateBased: rateBasedContrib,
            fixed: fixedContrib,
            type: fixedContrib > 0 ? 'mixed' : 'rate-only'
          };
        });
        const monthlyTotal = rows.reduce((s, x) => s + x.contribution, 0);

        // Projections
        const fv2 = projectFV({ principal, monthlyContribution: monthlyTotal, months: 24, apyPct: apy });
        const fv5 = projectFV({ principal, monthlyContribution: monthlyTotal, months: 60, apyPct: apy });

        // Goal analysis - only for selected goals
        const selectedGoals = appState.goals.filter(g => 
          scenarioFilters.selectedGoals.includes(g.id)
        );
        const perGoal = selectedGoals.map(g => {
          const cur = ownerSavings(g.owner);
          const monthsLeft = monthsBetween(new Date(), g.deadline);
          const eta = monthsToReach({
            current: cur,
            monthlyContribution: monthlyTotal,
            target: g.target,
            apyPct: apy
          });
          const onTime = Number.isFinite(eta) && eta <= monthsLeft;
          return { name: g.name, deadline: g.deadline, monthsLeft, eta, onTime };
        });

        const onTimeCount = perGoal.filter(g => g.onTime).length;
        const totalGoals = perGoal.length;
        
        // Determine status and recommendation
        let statusBadge, keyImpact, recommendation;
        
        if(onTimeCount === totalGoals && totalGoals > 0) {
          statusBadge = '<span class="badge bg-success">âœ… All Goals</span>';
          keyImpact = `All ${totalGoals} goals achievable on time`;
          recommendation = isCurrentRate ? '<span class="badge bg-primary">Current Plan</span>' : '<span class="badge bg-success">ğŸ‘ Recommended</span>';
        } else if(onTimeCount > 0) {
          statusBadge = `<span class="badge bg-warning">âš ï¸ ${onTimeCount}/${totalGoals}</span>`;
          const atRiskGoals = totalGoals - onTimeCount;
          keyImpact = `${atRiskGoals} goal${atRiskGoals > 1 ? 's' : ''} at risk`;
          recommendation = '<span class="badge bg-warning">âš ï¸ Partial Risk</span>';
        } else {
          statusBadge = '<span class="badge bg-danger">âŒ High Risk</span>';
          keyImpact = totalGoals > 0 ? 'No goals achievable on time' : 'No goals set';
          recommendation = '<span class="badge bg-danger">âŒ Insufficient</span>';
        }

        // Enhanced breakdown for details
        const collapseId = 'breakdown-' + rate;
        const contributionDetails = `
          <div class="row">
            <div class="col-md-6">
              <h6 class="mb-2">ğŸ‘¥ Monthly Contributions</h6>
              <div class="list-group list-group-flush">
                ${rows.map(pr => `
                  <div class="list-group-item d-flex justify-content-between align-items-center py-2 border-0">
                    <div>
                      <span>${pr.name}</span>
                      ${pr.type === 'mixed' ? `<br><small class="text-muted">${fmtMoney(pr.rateBased)} (${rate}%) + ${fmtMoney(pr.fixed)} (fixed)</small>` : ''}
                    </div>
                    <span class="badge bg-primary">${fmtMoney(pr.contribution)}</span>
                  </div>
                `).join('')}
                <div class="list-group-item d-flex justify-content-between align-items-center py-2 border-0 fw-bold">
                  <span>Total Household</span>
                  <span class="badge bg-success">${fmtMoney(monthlyTotal)}</span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <h6 class="mb-2">ğŸ¯ Goal Timeline</h6>
              ${totalGoals > 0 ? `
                <div class="list-group list-group-flush">
                  ${perGoal.map(g => {
                    const statusIcon = g.onTime ? 'âœ…' : (Number.isFinite(g.eta) ? 'âš ï¸' : 'âŒ');
                    const etaText = Number.isFinite(g.eta) ? formatMonthsToYearsMonths(g.eta) : 'Not reachable';
                    return `
                      <div class="list-group-item d-flex justify-content-between align-items-center py-2 border-0">
                        <span>${statusIcon} ${g.name}</span>
                        <small class="text-muted">${etaText}</small>
                      </div>
                    `;
                  }).join('')}
                </div>
              ` : '<div class="text-muted">No goals set</div>'}
            </div>
          </div>
        `;

        const tr = document.createElement('tr');
        tr.className = isCurrentRate ? 'table-primary' : '';
        tr.innerHTML = `
          <td>
            <div class="d-flex align-items-center gap-2">
              <span class="fw-bold fs-5">${rate}%</span>
              ${isCurrentRate ? '<span class="badge bg-primary">Current</span>' : ''}
            </div>
          </td>
          <td>
            <div class="fw-semibold">${fmtMoney(monthlyTotal)}</div>
            <small class="text-muted">${fmtMoney(monthlyTotal * 12)}/year</small>
          </td>
          <td class="fw-semibold text-primary">${fmtMoney(fv2)}</td>
          <td class="fw-semibold text-success">${fmtMoney(fv5)}</td>
          <td>${statusBadge}</td>
          <td class="small">${keyImpact}</td>
          <td>
            <div class="d-flex flex-column gap-1">
              ${recommendation}
              <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                ğŸ“‹ Details
              </button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);

        // Add collapsible details row
        const detailsRow = document.createElement('tr');
        detailsRow.innerHTML = `
          <td colspan="7" class="p-0">
            <div class="collapse" id="${collapseId}">
              <div class="card card-body m-3">
                ${contributionDetails}
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(detailsRow);
      });
    }
    $('#refreshRatesBtn').addEventListener('click', ()=>{
      const nums = ($('#scenarioRates').value||'').split(',').map(s=> Number(s.trim())).filter(x=> isFinite(x)&&x>=0);
      if(!nums.length) return showAlert('Enter valid rates (e.g., 5,10,15,20)', 'warning');
      
      // Show loading state
      const btn = $('#refreshRatesBtn');
      const originalText = btn.innerHTML;
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Calculating...';
      
      // Simulate calculation time for better UX
      setTimeout(() => {
        appState.scenarioRates = nums; 
        saveState();
        
        // Reset button state
        btn.disabled = false;
        btn.innerHTML = originalText;
      }, 500);
    });

    /********** TRANSACTIONS **********/
    $('#addTxBtn').addEventListener('click', async ()=>{
      const btn = $('#addTxBtn');
      const date = $('#txDate').value || new Date().toISOString().slice(0,10);
      const amt = Number($('#txAmount').value||0); 
      
      if(!isFinite(amt)||amt<=0) {
        // Better error feedback
        $('#txAmount').classList.add('is-invalid');
        setTimeout(() => $('#txAmount').classList.remove('is-invalid'), 2000);
        return;
      }
      
      const person = $('#txPerson').value || (appState.people[0]?.name || 'Household');
      const note = ($('#txNote').value||'').trim();
      const goalId = $('#txGoal').value || null;
      
      // Show loading popup
      showCrudLoading('Adding transaction...', `Saving ${fmtMoney(amt)} for ${person}`);
      
      // Show loading state
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
      
      // Find person before try block so it's accessible in catch
      const p = appState.people.find(x => x.name === person);
      
      try {
        const newTx = { id:uid(), date, person, amount:amt, note, goalId };
        
        // Optimistic UI update - update state immediately
        appState.transactions.unshift(newTx);
        
        // Update person's current savings locally
        if(p) {
          p.currentSavings = (p.currentSavings || 0) + amt;
        }
        
        // Clear form immediately for better UX
        $('#txAmount').value=''; $('#txNote').value=''; $('#txGoal').value = '';
        $('#goalSuggestion').style.display = 'none';
        
        // Update UI immediately (optimistic rendering)
        renderTransactions();
        buildTxCharts();
        
        // Re-enable button immediately
        btn.classList.add('btn-success');
        btn.innerHTML = 'âœ… Added!';
        btn.disabled = false;
        
        // Reset button appearance after brief delay
        setTimeout(() => {
          btn.classList.remove('btn-success');
          btn.innerHTML = originalText;
        }, 500);
        
        // Save to backend in parallel (non-blocking)
        const savePromises = [appApi.createTransaction(newTx)];
        if(p) {
          savePromises.push(appApi.updatePerson(p));
        }
        
        // Run API calls in parallel, handle errors silently (UI already updated)
        Promise.all(savePromises).then(() => {
          hideCrudLoading();
        }).catch(error => {
          console.error('Error saving transaction to backend:', error);
          hideCrudLoading();
          // Optionally show a subtle warning that sync failed
          showAlert('Transaction added locally, but sync failed. Please refresh.', 'warning');
        });
      } catch (error) {
        // Rollback optimistic update on error
        hideCrudLoading();
        appState.transactions.shift();
        if(p) {
          p.currentSavings = (p.currentSavings || 0) - amt;
        }
        showAlert('Failed to add transaction: ' + error.message, 'danger');
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    });
    
    // Add smart suggestions when amount changes
    $('#txAmount').addEventListener('input', (e) => {
      const amount = Number(e.target.value || 0);
      showGoalSuggestion(amount);
    });

    function renderTransactions(){
      const emptyState = $('#txEmptyState');
      const tableBody = $('#txTableBody');
      
      // summary
      $('#txTotal').textContent = fmtMoney(txTotal());
      const last30 = appState.transactions.filter(t => (new Date() - new Date(t.date)) <= 30*86400000).reduce((s,t)=> s+t.amount,0);
      $('#txLast30').textContent = fmtMoney(last30);
      const totalsByPerson = {};
      appState.transactions.forEach(t=> totalsByPerson[t.person]=(totalsByPerson[t.person]||0)+t.amount);
      const top = Object.entries(totalsByPerson).sort((a,b)=> b[1]-a[1])[0];
      $('#txTopPerson').textContent = top ? `${top[0]} (${fmtMoney(top[1])})` : 'â€”';

      // person select
      $('#txPerson').innerHTML = appState.people.map(p=> `<option>${p.name}</option>`).join('');
      
      // goal select
      renderGoalOptions();

      // Show/hide empty state
      if (appState.transactions.length === 0) {
        emptyState.style.display = 'block';
        $('#txTable').closest('.card').style.display = 'none';
        return;
      }
      
      emptyState.style.display = 'none';
      $('#txTable').closest('.card').style.display = 'block';

      // table
      tableBody.innerHTML='';
      
      // Assign colors to goals
      const goalColors = [
        { bg: 'rgba(59, 130, 246, 0.2)', text: '#3b82f6' }, // Blue
        { bg: 'rgba(16, 185, 129, 0.2)', text: '#10b981' }, // Green
        { bg: 'rgba(139, 92, 246, 0.2)', text: '#8b5cf6' }, // Purple
        { bg: 'rgba(245, 158, 11, 0.2)', text: '#f59e0b' }, // Orange
        { bg: 'rgba(236, 72, 153, 0.2)', text: '#ec4899' }, // Pink
        { bg: 'rgba(6, 182, 212, 0.2)', text: '#06b6d4' }, // Cyan
        { bg: 'rgba(239, 68, 68, 0.2)', text: '#ef4444' }, // Red
        { bg: 'rgba(34, 197, 94, 0.2)', text: '#22c55e' }, // Emerald
      ];
      const goalColorMap = new Map();
      appState.goals.forEach((goal, idx) => {
        goalColorMap.set(goal.id, goalColors[idx % goalColors.length]);
      });
      
      // Calculate running balances PER GOAL: sort by date ascending, then by ID
      const sortedByDateAsc = appState.transactions.slice().sort((a,b)=> {
        const dateCompare = a.date.localeCompare(b.date);
        if (dateCompare !== 0) return dateCompare;
        return a.id.localeCompare(b.id);
      });
      
      // Group transactions by goal and calculate running balance for each
      const balanceMap = new Map();
      const goalBalances = new Map(); // Track running balance per goal
      
      sortedByDateAsc.forEach(t => {
        const amount = Number(t.amount) || 0;
        if (!isFinite(amount) || amount < 0) {
          console.warn('âš ï¸ Invalid transaction amount:', t);
        }
        
        // Get goal key (goalId or 'general')
        const goalKey = t.goalId || 'general';
        const currentGoalBalance = goalBalances.get(goalKey) || 0;
        const newGoalBalance = currentGoalBalance + amount;
        goalBalances.set(goalKey, newGoalBalance);
        
        // Store balance for this transaction
        balanceMap.set(t.id, newGoalBalance);
      });
      
      // Display transactions sorted by date descending (newest first)
      appState.transactions.slice().sort((a,b)=> b.date.localeCompare(a.date)).forEach(t=>{
        const tr = document.createElement('tr');
        const goal = t.goalId ? appState.goals.find(g => g.id === t.goalId) : null;
        const balance = balanceMap.get(t.id) || 0;
        
        let goalDisplay = '';
        if (goal) {
          const color = goalColorMap.get(goal.id) || goalColors[0];
          goalDisplay = `<span class="badge text-white" style="background-color: ${color.bg}; border: 1px solid ${color.text}40;">${goal.name}</span>`;
        } else {
          goalDisplay = '<span class="badge text-white" style="background-color: rgba(255, 255, 255, 0.15);">General</span>';
        }
          
        tr.innerHTML = `
          <td style="padding: 1rem;">${t.date}</td>
          <td style="padding: 1rem;">${t.person}</td>
          <td class="text-end" style="padding: 1rem; font-weight: 600; color: var(--text);">${fmtMoney(t.amount)}</td>
          <td class="text-end" style="padding: 1rem; font-weight: 600; color: #10b981;">${fmtMoney(balance)}</td>
          <td style="padding: 1rem;">${goalDisplay}</td>
          <td style="padding: 1rem; color: var(--muted);">${t.note||'â€”'}</td>
          <td style="padding: 1rem;">
            <div class="d-flex gap-2 justify-content-end">
              <button class="btn btn-sm btn-outline-primary" data-edit-tx="${t.id}" style="border-radius: 8px;">âœï¸</button>
              <button class="btn btn-sm btn-outline-danger" data-del-tx="${t.id}" style="border-radius: 8px;">ğŸ—‘ï¸</button>
            </div>
          </td>
        `;
        tableBody.appendChild(tr);
      });
      $all('[data-del-tx]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const tx = appState.transactions.find(x=> x.id===btn.dataset.delTx);
        if(!confirm(`Delete transaction of ${fmtMoney(tx?.amount || 0)} on ${tx?.date || ''}?`)) return;
        
        showCrudLoading('Deleting transaction...', `Removing ${fmtMoney(tx?.amount || 0)} from ${tx?.person || ''}`);
        
        if(tx) {
          const p = appState.people.find(x => x.name === tx.person);
          if(p) {
            p.currentSavings = (p.currentSavings || 0) - tx.amount;
            try {
              await appApi.updatePerson(p);
            } catch (error) {
              console.error('Error updating person:', error);
            }
          }
        }
        
        try {
          await appApi.deleteTransaction(btn.dataset.delTx);
          appState.transactions = appState.transactions.filter(x=> x.id!==btn.dataset.delTx); 
          saveState();
          hideCrudLoading();
          renderTransactions();
          buildTxCharts();
        } catch (error) {
          hideCrudLoading();
          showAlert('Failed to delete transaction: ' + error.message, 'danger');
        }
      }));
      
      // Add edit transaction functionality
      $all('[data-edit-tx]').forEach(btn=> btn.addEventListener('click', ()=>{
        const txId = btn.dataset.editTx;
        const tx = appState.transactions.find(t => t.id === txId);
        if(!tx) return;
        
        // Create edit modal/form
        const editHtml = `
          <div class="modal fade" id="editTxModal" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">âœï¸ Edit Transaction</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Date</label>
                      <input class="form-control" id="editTxDate" type="date" value="${tx.date}"/>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Amount</label>
                      <input class="form-control" id="editTxAmount" type="number" step="0.01" value="${tx.amount}"/>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Person</label>
                      <select class="form-select" id="editTxPerson">
                        ${appState.people.map(p => `<option ${p.name === tx.person ? 'selected' : ''}>${p.name}</option>`).join('')}
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Goal</label>
                      <select class="form-select" id="editTxGoal">
                        <option value="" ${!tx.goalId ? 'selected' : ''}>ğŸ’° General Savings</option>
                        ${appState.goals.map(g => `<option value="${g.id}" ${g.id === tx.goalId ? 'selected' : ''}>${g.name}</option>`).join('')}
                      </select>
                    </div>
                    <div class="col-12">
                      <label class="form-label">Note</label>
                      <input class="form-control" id="editTxNote" value="${tx.note || ''}"/>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" id="saveTxEdit">ğŸ’¾ Save Changes</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('editTxModal');
        if(existingModal) existingModal.remove();
        
        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', editHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editTxModal'));
        modal.show();
        
        // Handle save
        document.getElementById('saveTxEdit').addEventListener('click', () => {
          const newDate = $('#editTxDate').value;
          const newAmount = Number($('#editTxAmount').value);
          const newPerson = $('#editTxPerson').value;
          const newGoalId = $('#editTxGoal').value || null;
          const newNote = $('#editTxNote').value.trim();
          
          if(!newDate || !isFinite(newAmount) || newAmount <= 0) {
            showAlert('Please fill in valid date and amount', 'warning');
            return;
          }
          
          showCrudLoading('Updating transaction...', `Saving changes to ${fmtMoney(newAmount)} transaction`);
          
          // Update person's savings (remove old amount, add new amount)
          const oldPerson = appState.people.find(p => p.name === tx.person);
          const newPersonObj = appState.people.find(p => p.name === newPerson);
          
          // Store original values for rollback
          const originalTx = { ...tx };
          const originalOldPerson = oldPerson ? { ...oldPerson } : null;
          const originalNewPerson = newPersonObj ? { ...newPersonObj } : null;
          
          if(oldPerson) {
            oldPerson.currentSavings = (oldPerson.currentSavings || 0) - tx.amount;
          }
          if(newPersonObj) {
            newPersonObj.currentSavings = (newPersonObj.currentSavings || 0) + newAmount;
          }
          
          // Update transaction locally
          tx.date = newDate;
          tx.amount = newAmount;
          tx.person = newPerson;
          tx.goalId = newGoalId;
          tx.note = newNote;
          
          // Update UI immediately (optimistic update)
          renderTransactions();
          buildTxCharts();
          modal.hide();
          
          // Success feedback
          const btn = document.querySelector(`[data-edit-tx="${txId}"]`);
          if(btn) {
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = 'âœ… Saved!';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-primary');
            
            setTimeout(() => {
              btn.innerHTML = originalBtnText;
              btn.classList.remove('btn-success');
              btn.classList.add('btn-outline-primary');
            }, 2000);
          }
          
          // Save to backend
          const savePromises = [
            appApi.updateTransaction({
              id: tx.id,
              date: newDate,
              person: newPerson,
              amount: newAmount,
              note: newNote,
              goalId: newGoalId
            })
          ];
          
          // Update people if they changed
          if(oldPerson && oldPerson !== newPersonObj) {
            // Person changed - update both old and new person
            savePromises.push(appApi.updatePerson(oldPerson));
            if(newPersonObj) {
              savePromises.push(appApi.updatePerson(newPersonObj));
            }
          } else if(newPersonObj && oldPerson === newPersonObj) {
            // Same person - just update once
            savePromises.push(appApi.updatePerson(newPersonObj));
          } else if(newPersonObj && !oldPerson) {
            // New person only (old person not found)
            savePromises.push(appApi.updatePerson(newPersonObj));
          }
          
          // Run API calls in parallel
          Promise.all(savePromises).then(() => {
            hideCrudLoading();
          }).catch(error => {
            console.error('Error saving transaction edit to backend:', error);
            hideCrudLoading();
            // Rollback local changes
            Object.assign(tx, originalTx);
            if(originalOldPerson) Object.assign(oldPerson, originalOldPerson);
            if(originalNewPerson) Object.assign(newPersonObj, originalNewPerson);
            // Re-render to show original values
            renderTransactions();
            buildTxCharts();
            showAlert('Failed to save changes: ' + (error.message || 'Unknown error'), 'danger');
          });
        });
      }));

      buildTxCharts();
    }
    
    function renderGoalOptions() {
      const goalSelect = $('#txGoal');
      // Keep the default "General Savings" option
      let options = '<option value="">ğŸ’° General Savings (No specific goal)</option>';
      
      // Add goals sorted by priority  
      appState.goals.slice()
        .sort((a,b) => (a.priority||999) - (b.priority||999))
        .forEach(g => {
          const allocated = goalAllocatedSavings(g.id);
          const needed = Math.max(0, g.target - allocated - ownerUnallocatedSavings(g.owner));
          const emoji = g.name.toLowerCase().includes('emergency') ? 'ğŸ ' :
                       g.name.toLowerCase().includes('vacation') ? 'ğŸ–ï¸' :
                       g.name.toLowerCase().includes('house') ? 'ğŸ˜ï¸' : 'ğŸ¯';
          
          options += `<option value="${g.id}">${emoji} ${g.name} (needs ${fmtMoney(needed)})</option>`;
        });
        
      goalSelect.innerHTML = options;
    }
    
    function showGoalSuggestion(amount) {
      if (!amount || amount < 1000) {
        $('#goalSuggestion').style.display = 'none';
        return;
      }
      
      // Find best goal suggestion based on priority and amount
      const sortedGoals = appState.goals.slice()
        .sort((a,b) => (a.priority||999) - (b.priority||999))
        .map(g => {
          const allocated = goalAllocatedSavings(g.id);
          const unallocated = ownerUnallocatedSavings(g.owner);
          const needed = Math.max(0, g.target - allocated - unallocated);
          return { ...g, needed, allocated };
        });
      
      const suggestion = sortedGoals.find(g => g.needed > 0 && amount >= g.needed * 0.1);
      
      if (suggestion) {
        const percentage = ((amount / suggestion.needed) * 100).toFixed(0);
        $('#suggestionText').textContent = `Consider "${suggestion.name}" (${percentage}% of remaining need, high priority)`;
        $('#goalSuggestion').style.display = 'block';
      } else {
        $('#goalSuggestion').style.display = 'none';
      }
    }

    /********** CHARTS **********/
    let contributionChart = null, consistencyChart = null, timelineChart = null, txChart = null, txChart2 = null, txStackedChart = null, txStackedChartTab = null, monthlyContributionChart = null;
    
    function buildContributionChart(){
      const ctx = $('#contributionChart'); if(contributionChart) contributionChart.destroy();
      
      // Calculate contribution breakdown for each person
      const personStats = appState.people.map(person => {
        const personTx = appState.transactions.filter(t => t.person === person.name);
        const goalTx = personTx.filter(t => t.goalId);
        const generalTx = personTx.filter(t => !t.goalId);
        
        const goalAmount = goalTx.reduce((sum, t) => sum + t.amount, 0);
        const generalAmount = generalTx.reduce((sum, t) => sum + t.amount, 0);
        const total = goalAmount + generalAmount;
        
        return {
          name: person.name,
          goalAmount,
          generalAmount,
          total,
          goalPercent: total > 0 ? (goalAmount / total * 100).toFixed(1) : 0,
          generalPercent: total > 0 ? (generalAmount / total * 100).toFixed(1) : 0
        };
      }).filter(p => p.total > 0);
      
      if(personStats.length === 0) {
        $('#contributionSummary').innerHTML = '<div class="text-muted small">No transactions yet</div>';
        return;
      }
      
      // Update contribution summary
      const summaryHtml = personStats.map(p => 
        `<div class="small">
          <strong>${p.name}</strong>: ${p.goalPercent}% goals â€¢ ${p.generalPercent}% general 
          <span class="text-muted">(${fmtMoney(p.total)} total)</span>
        </div>`
      ).join('');
      $('#contributionSummary').innerHTML = summaryHtml;
      
      // Create stacked bar chart
      const labels = personStats.map(p => p.name);
      const goalData = personStats.map(p => p.goalAmount);
      const generalData = personStats.map(p => p.generalAmount);
      
      contributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Goal-Specific',
              data: goalData,
              backgroundColor: '#10b981',
              stack: 'contributions'
            },
            {
              label: 'General Savings', 
              data: generalData,
              backgroundColor: '#6b7280',
              stack: 'contributions'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { 
              stacked: true,
              ticks: {
                callback: function(value) {
                  return fmtMoney(value);
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const person = personStats[context.dataIndex];
                  const isGoal = context.datasetIndex === 0;
                  const percent = isGoal ? person.goalPercent : person.generalPercent;
                  return `${context.dataset.label}: ${fmtMoney(context.parsed.y)} (${percent}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    function buildConsistencyChart(){
      const ctx = $('#consistencyChart'); if(consistencyChart) consistencyChart.destroy();
      
      // Get last 12 months of savings data
      const now = new Date();
      const months = [];
      for(let i = 11; i >= 0; i--) {
        months.push(new Date(now.getFullYear(), now.getMonth() - i, 1));
      }
      
      const monthLabels = months.map(d => d.toLocaleString(appState.settings.locale, {month:'short', year:'2-digit'}));
      const monthlySavings = months.map(month => {
        const monthKey = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`;
        return appState.transactions
          .filter(t => t.date.slice(0,7) === monthKey)
          .reduce((sum, t) => sum + t.amount, 0);
      });
      
      // Calculate target monthly savings
      const targetMonthly = householdMonthlyIncome() * ((appState.settings.currentRatePct || 0) / 100);
      const targetLine = Array(12).fill(targetMonthly);
      
      consistencyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthLabels,
          datasets: [
            {
              label: 'Actual Savings',
              data: monthlySavings,
              borderColor: '#59a2ff',
              backgroundColor: 'rgba(89, 162, 255, 0.1)',
              fill: true,
              tension: 0.3
            },
            {
              label: 'Target',
              data: targetLine,
              borderColor: '#10b981',
              borderDash: [5, 5],
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  const target = targetMonthly;
                  const diff = value - target;
                  const diffText = diff > 0 ? `(+${fmtMoney(diff)} over target)` : diff < 0 ? `(${fmtMoney(Math.abs(diff))} under target)` : '(on target)';
                  return `${context.dataset.label}: ${fmtMoney(value)} ${context.dataset.label === 'Actual Savings' ? diffText : ''}`;
                }
              }
            }
          },
          scales: {
            y: {
              ticks: {
                callback: function(value) {
                  return fmtMoney(value);
                }
              }
            }
          }
        }
      });
    }
    function buildTimelineChart(){
      const ctx = $('#timelineChart'); if(timelineChart) timelineChart.destroy();
      const income = householdMonthlyIncome();
      const monthly = income * (appState.settings.currentRatePct||0)/100;
      const apy = appState.settings.apyPct||0;
      const labels = appState.goals.map(g=> g.name);
      const dataInMonths = appState.goals.map(g=> {
        const cur = ownerSavings(g.owner);
        const m = monthsToReach({ current: cur, monthlyContribution: monthly, target: g.target, apyPct: apy });
        return isFinite(m)? m : 120;
      });
      
      // Convert months to years for display
      const dataInYears = dataInMonths.map(m => m / 12);
      const maxYears = Math.max(1, Math.ceil(Math.max(...dataInYears)));
      
      timelineChart = new Chart(ctx, { 
        type:'bar', 
        data:{ labels, datasets:[{label:'Years to Complete', data: dataInYears, backgroundColor:'#59a2ff'}] },
        options:{ 
          indexAxis:'y', 
          plugins:{
            legend:{display:false},
            tooltip: {
              callbacks: {
                label: (context) => {
                  const years = context.parsed.x;
                  const months = Math.round((years % 1) * 12);
                  const fullYears = Math.floor(years);
                  
                  if(fullYears === 0) return `${Math.round(years * 12)} months`;
                  if(months === 0) return `${fullYears} year${fullYears > 1 ? 's' : ''}`;
                  return `${fullYears} year${fullYears > 1 ? 's' : ''} ${months} month${months > 1 ? 's' : ''}`;
                }
              }
            }
          }, 
          scales:{
            x:{
              suggestedMax: maxYears + 0.5,
              ticks: {
                callback: function(value) {
                  if(value < 1) return `${Math.round(value * 12)}mo`;
                  if(value % 1 === 0) return `${value}yr`;
                  return `${Math.floor(value)}.${Math.round((value % 1) * 10)}yr`;
                }
              }
            }
          } 
        }
      });
    }
    
    function buildMonthlyContributionChart(){
      const ctx = $('#monthlyContributionChart'); if(monthlyContributionChart) monthlyContributionChart.destroy();
      
      // Get last 6 months of data
      const now = new Date();
      const months = [];
      for(let i = 5; i >= 0; i--) {
        months.push(new Date(now.getFullYear(), now.getMonth() - i, 1));
      }
      
      const monthLabels = months.map(d => d.toLocaleString(appState.settings.locale, {month:'short', year:'2-digit'}));
      const personNames = appState.people.map(p => p.name);
      const colors = ['#10b981', '#59a2ff', '#8a7dff', '#f59e0b', '#ef4444', '#06b6d4'];
      
      // Build datasets for each person
      const datasets = personNames.map((person, idx) => {
        const data = months.map(month => {
          const monthKey = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`;
          return appState.transactions
            .filter(t => t.person === person && t.date.slice(0,7) === monthKey)
            .reduce((sum, t) => sum + t.amount, 0);
        });
        
        return {
          label: person,
          data: data,
          backgroundColor: colors[idx % colors.length],
          stack: 'contributions'
        };
      });
      
      monthlyContributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: monthLabels,
          datasets: datasets
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { 
              stacked: true,
              ticks: {
                callback: function(value) {
                  return fmtMoney(value);
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${fmtMoney(context.parsed.y)}`;
                },
                footer: function(tooltipItems) {
                  const monthIndex = tooltipItems[0].dataIndex;
                  const month = months[monthIndex];
                  const monthKey = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`;
                  
                  // Check who didn't contribute
                  const contributors = new Set();
                  appState.transactions.forEach(t => {
                    if(t.date.slice(0,7) === monthKey) {
                      contributors.add(t.person);
                    }
                  });
                  
                  const nonContributors = personNames.filter(person => !contributors.has(person));
                  if(nonContributors.length > 0) {
                    return `No contributions: ${nonContributors.join(', ')}`;
                  }
                  return 'Everyone contributed! ğŸ‰';
                }
              }
            }
          }
        }
      });
      
      // Update contribution streak and table
      updateContributionStreak();
      updateContributionTable();
    }
    
    function updateContributionStreak() {
      const now = new Date();
      const streakData = appState.people.map(person => {
        let currentStreak = 0;
        let longestStreak = 0;
        let tempStreak = 0;
        
        // Check last 12 months
        for(let i = 11; i >= 0; i--) {
          const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const monthKey = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`;
          
          const hasContribution = appState.transactions.some(t => 
            t.person === person.name && t.date.slice(0,7) === monthKey
          );
          
          if(hasContribution) {
            tempStreak++;
            if(i === 0) currentStreak = tempStreak; // Current month streak
          } else {
            longestStreak = Math.max(longestStreak, tempStreak);
            tempStreak = 0;
            if(i === 0) currentStreak = 0;
          }
        }
        longestStreak = Math.max(longestStreak, tempStreak);
        
        return { person: person.name, currentStreak, longestStreak };
      });
      
      const streakHtml = `
        <div class="small mb-2">
          <strong>ğŸ”¥ Contribution Streaks</strong>
        </div>
        ${streakData.map(s => `
          <div class="d-flex justify-content-between small mb-1">
            <span>${s.person}</span>
            <span>${s.currentStreak} mo current ${s.currentStreak >= 3 ? 'ğŸ”¥' : s.currentStreak >= 1 ? 'âœ…' : 'ğŸ˜´'}</span>
          </div>
        `).join('')}
      `;
      
      $('#contributionStreak').innerHTML = streakHtml;
    }
    
    function updateContributionTable() {
      const now = new Date();
      const tableData = [];
      
      // Get last 3 months for detailed view
      for(let i = 2; i >= 0; i--) {
        const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthKey = `${month.getFullYear()}-${String(month.getMonth()+1).padStart(2,'0')}`;
        const monthName = month.toLocaleString(appState.settings.locale, {month:'short'});
        
        const monthData = { month: monthName, people: {} };
        
        appState.people.forEach(person => {
          const contribution = appState.transactions
            .filter(t => t.person === person.name && t.date.slice(0,7) === monthKey)
            .reduce((sum, t) => sum + t.amount, 0);
          
          monthData.people[person.name] = contribution;
        });
        
        tableData.push(monthData);
      }
      
      const tableHtml = `
        <div class="small mb-2">
          <strong>ğŸ“Š Recent Months</strong>
        </div>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th style="font-size:0.75rem;">Month</th>
                ${appState.people.map(p => `<th class="text-center" style="font-size:0.75rem;">${p.name.slice(0,3)}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${tableData.map(row => `
                <tr>
                  <td class="small">${row.month}</td>
                  ${appState.people.map(person => {
                    const amount = row.people[person.name];
                    const status = amount > 0 ? 'âœ…' : 'âŒ';
                    const displayAmount = amount > 0 ? fmtMoney(amount).replace(/[â‚±$â‚¬Â¥Â£]/g, '').slice(0,4) : '0';
                    return `<td class="text-center small">${status}<br><span style="font-size:0.7rem;">${displayAmount}</span></td>`;
                  }).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      $('#contributionTable').innerHTML = tableHtml;
    }
    
    function buildTxCharts(){
      // recent totals (on dashboard and on tx tab)
      const now = new Date(); const months=[]; for(let i=5;i>=0;i--){ months.push(new Date(now.getFullYear(), now.getMonth()-i, 1)); }
      function key(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
      const monthLabels = months.map(d=> d.toLocaleString(appState.settings.locale, {month:'short', year:'2-digit'}));
      const mk = months.map(m=> key(m));
      const sums = mk.map(k => appState.transactions.filter(t=> t.date.slice(0,7)===k).reduce((s,t)=> s+t.amount, 0));

      const txChartEl = $('#txChart');
      if(txChartEl) {
        if(txChart !== null) txChart.destroy();
        txChart = new Chart(txChartEl, { type:'bar', data:{ labels: monthLabels, datasets:[{label:'Total saved', data:sums, backgroundColor:'#10b981'}] }, options:{plugins:{legend:{display:false}}} });
      }

      const txChart2El = $('#txChart2');
      if(txChart2El) {
        if(txChart2 !== null) txChart2.destroy();
        txChart2 = new Chart(txChart2El, { type:'bar', data:{ labels: monthLabels, datasets:[{label:'Total saved', data:sums, backgroundColor:'#10b981'}] }, options:{plugins:{legend:{display:false}}} });
      }

      // stacked by person
      const persons = appState.people.map(p=> p.name);
      const colors = ['#8a7dff','#59a2ff','#10b981','#f59e0b','#ef4444','#06b6d4'];
      const ds = persons.map((name,idx)=>({
        label:name,
        data: mk.map(k=> appState.transactions.filter(t=> t.person===name && t.date.slice(0,7)===k).reduce((a,b)=> a+b.amount,0)),
        backgroundColor: colors[idx%colors.length]
      }));
      const txStackedChartEl = $('#txStackedChart');
      if(txStackedChartEl) {
        if(txStackedChart !== null) txStackedChart.destroy();
        txStackedChart = new Chart(txStackedChartEl, { type:'bar', data:{ labels: monthLabels, datasets: ds }, options:{ scales:{ x:{stacked:true}, y:{stacked:true} } } });
      }
      
      // stacked chart for transactions tab
      const txStackedChartTabEl = $('#txStackedChartTab');
      if(txStackedChartTabEl) {
        if(txStackedChartTab !== null) txStackedChartTab.destroy();
        txStackedChartTab = new Chart(txStackedChartTabEl, { type:'bar', data:{ labels: monthLabels, datasets: ds }, options:{ scales:{ x:{stacked:true}, y:{stacked:true} } } });
      }
    }

    /********** CHECKBOX SCENARIO FILTERS **********/
    let scenarioFilters = {
      selectedContributors: [],
      selectedGoals: []
    };
    
    function renderScenarioFilters() {
      renderContributorsFilter();
      renderGoalsFilter();
    }
    
    function renderContributorsFilter() {
      const container = $('#contributorsFilter');
      if(!container) return;
      
      // Default to all contributors selected
      if(scenarioFilters.selectedContributors.length === 0) {
        scenarioFilters.selectedContributors = appState.people.map(p => p.id);
      }
      
      const html = appState.people.map(person => {
        const fixed = Number(person.fixedMonthlyContribution || 0);
        const isSelected = scenarioFilters.selectedContributors.includes(person.id);
        
        return `
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" ${isSelected ? 'checked' : ''} 
                   id="contrib-${person.id}" data-person-id="${person.id}">
            <label class="form-check-label" for="contrib-${person.id}">
              <strong>${person.name}</strong>
              <br><small class="text-muted">${fixed > 0 ? `Fixed: ${fmtMoney(fixed)}/month` : 'Rate-based'}</small>
            </label>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
      
      // Add event listeners
      container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateContributorSelection);
      });
    }
    
    function renderGoalsFilter() {
      const container = $('#goalsFilter');
      if(!container) return;
      
      // Default to all goals selected
      if(scenarioFilters.selectedGoals.length === 0) {
        scenarioFilters.selectedGoals = appState.goals.map(g => g.id);
      }
      
      const html = appState.goals.map(goal => {
        const monthsLeft = monthsBetween(new Date(), goal.deadline);
        const isSelected = scenarioFilters.selectedGoals.includes(goal.id);
        
        return `
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" ${isSelected ? 'checked' : ''}
                   id="goal-${goal.id}" data-goal-id="${goal.id}">
            <label class="form-check-label" for="goal-${goal.id}">
              <strong>${goal.name}</strong>
              <br><small class="text-muted">${fmtMoney(goal.target)} â€¢ ${formatMonthsToYearsMonths(monthsLeft)} left</small>
            </label>
          </div>
        `;
      }).join('');
      
      container.innerHTML = html;
      
      // Add event listeners
      container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateGoalSelection);
      });
    }
    
    function updateContributorSelection(e) {
      const personId = e.target.dataset.personId;
      if(e.target.checked) {
        if(!scenarioFilters.selectedContributors.includes(personId)) {
          scenarioFilters.selectedContributors.push(personId);
        }
      } else {
        scenarioFilters.selectedContributors = scenarioFilters.selectedContributors.filter(id => id !== personId);
      }
      // Auto-refresh scenarios when selection changes
      setTimeout(renderRatesTable, 100);
    }
    
    function updateGoalSelection(e) {
      const goalId = e.target.dataset.goalId;
      if(e.target.checked) {
        if(!scenarioFilters.selectedGoals.includes(goalId)) {
          scenarioFilters.selectedGoals.push(goalId);
        }
      } else {
        scenarioFilters.selectedGoals = scenarioFilters.selectedGoals.filter(id => id !== goalId);
      }
      // Auto-refresh scenarios when selection changes
      setTimeout(renderRatesTable, 100);
    }
    
    /********** RENDER ALL **********/
    function renderAll(){
      renderSettings();
      renderPeople();
      renderGoals();
      renderRatesTable();
      renderTransactions();
      buildContributionChart();
      buildConsistencyChart();
      buildTimelineChart();
      buildMonthlyContributionChart();
      renderScenarioFilters();
    }

    // Re-render scenario filters when Rate Scenarios tab is opened
    document.addEventListener('shown.bs.tab', function (e) {
      if(e.target.getAttribute('data-bs-target') === '#tabRates') {
        console.log('Rate Scenarios tab opened - rendering filters');
        setTimeout(() => {
          renderScenarioFilters();
          renderRatesTable();
        }, 100);
      }
    });
    
    // Note: renderAll() is called automatically after initializeApp() completes

    // Share Tracker UI Functions
    function initializeShareTrackerUI(trackerManager, api) {
      const shareBtn = document.getElementById('btn-share-tracker');
      const shareModal = document.getElementById('share-tracker-modal');
      const closeShareBtn = document.getElementById('btn-close-share-modal');
      const addShareBtn = document.getElementById('btn-add-share');
      
      if (!shareBtn || !shareModal) {
        console.warn('Share tracker UI elements not found');
        return;
      }

      // Verify API has the required methods before proceeding
      if (!api) {
        console.error('API instance is null');
        return;
      }
      
      // Check if methods exist by trying to access them
      // Note: async methods might not show up with typeof check, so we'll just try to use them
      // and catch errors if they don't exist
      const hasGetTrackerShares = typeof api.getTrackerShares === 'function';
      const hasShareTracker = typeof api.shareTracker === 'function';
      
      if (!hasGetTrackerShares || !hasShareTracker) {
        console.warn('âš ï¸ Share tracker methods not directly accessible, but will try anyway');
        console.log('API instance:', api);
        console.log('API constructor:', api.constructor?.name);
        console.log('API instanceof SavingsAPI check:', api instanceof window.SavingsAPI);
        console.log('getTrackerShares type:', typeof api.getTrackerShares);
        console.log('shareTracker type:', typeof api.shareTracker);
        
        // Try to get from prototype
        const proto = Object.getPrototypeOf(api);
        console.log('Prototype:', proto);
        console.log('Prototype constructor:', proto.constructor?.name);
        const protoMethods = Object.getOwnPropertyNames(proto);
        console.log('Prototype methods:', protoMethods);
        console.log('Has getTrackerShares in proto:', 'getTrackerShares' in proto);
        console.log('Has shareTracker in proto:', 'shareTracker' in proto);
        
        // Check if it's actually a SavingsAPI instance
        if (api.constructor?.name !== 'SavingsAPI' && !(api instanceof window.SavingsAPI)) {
          console.error('âŒ API instance is not a SavingsAPI instance!');
          console.log('Expected SavingsAPI, got:', api.constructor?.name);
          return;
        }
        
        // Even if typeof check fails, the methods should exist on the prototype
        // So we'll proceed and let the actual calls handle errors
      }

      // Open share modal
      shareBtn.addEventListener('click', () => {
        const currentTracker = trackerManager.getCurrentTracker();
        if (!currentTracker) {
          showAlert('No tracker selected', 'danger');
          return;
        }
        
        // Check if user is owner
        if (!currentTracker.isOwner) {
          showAlert('Only tracker owners can share', 'warning');
          return;
        }
        
        document.getElementById('share-tracker-name').textContent = currentTracker.name;
        shareModal.style.display = 'block';
        loadSharedUsers(currentTracker.id, api);
      });

      // Close share modal
      if (closeShareBtn) {
        closeShareBtn.addEventListener('click', () => {
          shareModal.style.display = 'none';
        });
      }

      // Close on outside click
      shareModal.addEventListener('click', (e) => {
        if (e.target === shareModal) {
          shareModal.style.display = 'none';
        }
      });

      // Add share
      if (addShareBtn) {
        addShareBtn.addEventListener('click', async () => {
          const emailInput = document.getElementById('share-user-email');
          const permissionSelect = document.getElementById('share-permission');
          const currentTracker = trackerManager.getCurrentTracker();
          
          if (!currentTracker) {
            showAlert('No tracker selected', 'danger');
            return;
          }
          
          const email = emailInput.value.trim().toLowerCase();
          const permission = permissionSelect.value;
          
          if (!email) {
            showAlert('Please enter an email address', 'warning');
            return;
          }
          
          // Basic email validation
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            showAlert('Please enter a valid email address', 'warning');
            return;
          }
          
          try {
            // Validate API instance - check both instance and prototype
            if (!api) {
              console.error('API instance is null or undefined');
              showAlert('API error: Unable to share tracker. Please refresh the page.', 'danger');
              return;
            }
            
            // Try to call the method directly - it should exist on the prototype
            addShareBtn.disabled = true;
            addShareBtn.textContent = 'Sharing...';
            
            await api.shareTracker(currentTracker.id, null, email, permission);
            showAlert('Tracker shared successfully!', 'success');
            emailInput.value = '';
            await loadSharedUsers(currentTracker.id, api);
          } catch (error) {
            console.error('Error sharing tracker:', error);
            const errorMsg = error.message || 'Unknown error';
            showAlert('Failed to share tracker: ' + errorMsg, 'danger');
          } finally {
            addShareBtn.disabled = false;
            addShareBtn.textContent = 'Share';
          }
        });
      }
    }

    async function loadSharedUsers(trackerId, api) {
      const listContainer = document.getElementById('shared-users-list');
      if (!listContainer) return;
      
      try {
        listContainer.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">Loading shares...</p>';
        
        // Validate API instance
        if (!api) {
          console.error('API instance is null or undefined');
          listContainer.innerHTML = '<p style="color: var(--danger); text-align: center; padding: 2rem;">Error: API not initialized</p>';
          return;
        }
        
        // Try to call the method directly - it should exist on the prototype
        const shares = await api.getTrackerShares(trackerId).catch(error => {
          // Handle 404 or "Tracker not found" gracefully
          if (error.message && (error.message.includes('not found') || error.message.includes('404'))) {
            console.log('â„¹ï¸ No shares found or endpoint not available yet');
            return [];
          }
          throw error;
        });
        
        if (!shares || shares.length === 0) {
          listContainer.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">No shares yet. Share this tracker with other users above.</p>';
          return;
        }
        
        const html = shares.map(share => {
          const permissionBadge = share.permission === 'write' 
            ? '<span style="background: var(--primary); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; margin-left: 0.5rem;">Write</span>'
            : '<span style="background: var(--muted); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; margin-left: 0.5rem;">Read</span>';
          
          const userDisplay = share.shared_with_email || share.shared_with_user_id || 'Unknown User';
          
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--panel); border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid rgba(255,255,255,.1);">
              <div>
                <div style="font-weight: 600; color: var(--text); margin-bottom: 0.25rem;">
                  ${userDisplay}
                  ${permissionBadge}
                </div>
                <div style="font-size: 0.85rem; color: var(--muted);">
                  Shared ${new Date(share.created_at).toLocaleDateString()}
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button 
                  class="btn btn-outline-primary btn-sm" 
                  onclick="updateSharePermission('${share.id}', '${share.permission === 'read' ? 'write' : 'read'}')"
                  style="white-space: nowrap;"
                >
                  ${share.permission === 'read' ? 'Make Write' : 'Make Read'}
                </button>
                <button 
                  class="btn btn-outline-warning btn-sm" 
                  onclick="transferOwnershipFromShare('${share.shared_with_email || share.shared_with_user_id}', '${share.id}')"
                  style="white-space: nowrap;"
                  title="Transfer ownership to this user"
                >
                  Make Owner
                </button>
                <button 
                  class="btn btn-outline-danger btn-sm" 
                  onclick="removeShare('${share.id}')"
                >
                  Remove
                </button>
              </div>
            </div>
          `;
        }).join('');
        
        listContainer.innerHTML = html;
      } catch (error) {
        console.error('Error loading shares:', error);
        listContainer.innerHTML = '<p style="color: var(--danger); text-align: center; padding: 2rem;">Failed to load shares: ' + (error.message || 'Unknown error') + '</p>';
      }
    }

    async function updateSharePermission(shareId, newPermission) {
      try {
        const currentTracker = trackerManager?.getCurrentTracker();
        if (!currentTracker) return;
        
        await appApi.updateSharePermission(shareId, newPermission);
        showAlert('Permission updated successfully!', 'success');
        await loadSharedUsers(currentTracker.id, appApi);
      } catch (error) {
        console.error('Error updating permission:', error);
        showAlert('Failed to update permission: ' + (error.message || 'Unknown error'), 'danger');
      }
    }

    async function removeShare(shareId) {
      if (!confirm('Are you sure you want to remove this share?')) {
        return;
      }
      
      try {
        const currentTracker = trackerManager?.getCurrentTracker();
        if (!currentTracker) return;
        
        await appApi.removeShare(shareId);
        showAlert('Share removed successfully!', 'success');
        await loadSharedUsers(currentTracker.id, appApi);
      } catch (error) {
        console.error('Error removing share:', error);
        showAlert('Failed to remove share: ' + (error.message || 'Unknown error'), 'danger');
      }
    }

    async function transferOwnershipFromShare(userEmailOrId, shareId) {
      const currentTracker = trackerManager?.getCurrentTracker();
      if (!currentTracker) {
        showAlert('No tracker selected', 'danger');
        return;
      }
      
      // Check if user is owner
      if (!currentTracker.isOwner) {
        showAlert('Only tracker owners can transfer ownership', 'warning');
        return;
      }
      
      // Check if transferOwnership method exists
      if (!trackerManager || typeof trackerManager.transferOwnership !== 'function') {
        console.error('transferOwnership method not available on trackerManager');
        showAlert('Transfer ownership feature not available. Please refresh the page.', 'danger');
        return;
      }
      
      // Determine if it's an email or user ID
      const isEmail = userEmailOrId.includes('@');
      const email = isEmail ? userEmailOrId : null;
      const userId = isEmail ? null : userEmailOrId;
      
      // Final confirmation
      const confirmed = confirm(
        `Are you sure you want to transfer ownership of "${currentTracker.name}" to ${email || userId}?\n\n` +
        `This action cannot be undone. You will lose owner access to this tracker.`
      );
      
      if (!confirmed) {
        return;
      }
      
      try {
        await trackerManager.transferOwnership(currentTracker.id, userId, email);
        
        showAlert('Tracker ownership transferred successfully!', 'success');
        
        // Close the share modal
        const shareModal = document.getElementById('share-tracker-modal');
        if (shareModal) {
          shareModal.style.display = 'none';
        }
        
        // Reload page to refresh tracker list and data
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } catch (error) {
        console.error('Error transferring tracker ownership:', error);
        showAlert('Failed to transfer ownership: ' + (error.message || 'Unknown error'), 'danger');
      }
    }

    // Make functions available globally for onclick handlers
    window.updateSharePermission = updateSharePermission;
    window.removeShare = removeShare;
    window.transferOwnershipFromShare = transferOwnershipFromShare;

    // Rename Tracker UI Functions
    function initializeRenameTrackerUI(trackerManager) {
      const renameBtn = document.getElementById('btn-rename-tracker');
      const renameModal = document.getElementById('rename-tracker-modal');
      const cancelRenameBtn = document.getElementById('btn-cancel-rename');
      const saveRenameBtn = document.getElementById('btn-save-rename');
      
      if (!renameBtn || !renameModal) {
        console.warn('Rename tracker UI elements not found');
        return;
      }

      // Open rename modal
      renameBtn.addEventListener('click', () => {
        const currentTracker = trackerManager.getCurrentTracker();
        if (!currentTracker) {
          showAlert('No tracker selected', 'danger');
          return;
        }
        
        // Check if user is owner
        if (!currentTracker.isOwner) {
          showAlert('Only tracker owners can rename trackers', 'warning');
          return;
        }
        
        // Populate form with current values
        document.getElementById('rename-tracker-name').value = currentTracker.name;
        document.getElementById('rename-tracker-desc').value = currentTracker.description || '';
        renameModal.style.display = 'block';
      });

      // Close rename modal
      if (cancelRenameBtn) {
        cancelRenameBtn.addEventListener('click', () => {
          renameModal.style.display = 'none';
        });
      }

      // Close on outside click
      renameModal.addEventListener('click', (e) => {
        if (e.target === renameModal) {
          renameModal.style.display = 'none';
        }
      });

      // Save rename
      if (saveRenameBtn) {
        saveRenameBtn.addEventListener('click', async () => {
          const nameInput = document.getElementById('rename-tracker-name');
          const descInput = document.getElementById('rename-tracker-desc');
          const currentTracker = trackerManager.getCurrentTracker();
          
          if (!currentTracker) {
            showAlert('No tracker selected', 'danger');
            return;
          }
          
          const name = nameInput.value.trim();
          const description = descInput.value.trim();
          
          if (!name) {
            showAlert('Please enter a tracker name', 'warning');
            return;
          }
          
          try {
            saveRenameBtn.disabled = true;
            saveRenameBtn.textContent = 'Saving...';
            
            await trackerManager.updateTracker(currentTracker.id, name, description);
            
            showAlert('Tracker renamed successfully!', 'success');
            renameModal.style.display = 'none';
            
            // Refresh tracker list
            await trackerManager.initialize();
            if (typeof window.renderTrackerSelector === 'function') {
              window.renderTrackerSelector(trackerManager);
            }
          } catch (error) {
            console.error('Error renaming tracker:', error);
            showAlert('Failed to rename tracker: ' + (error.message || 'Unknown error'), 'danger');
          } finally {
            saveRenameBtn.disabled = false;
            saveRenameBtn.textContent = 'Save Changes';
          }
        });
      }
    }

    // Delete Tracker UI Functions
    function initializeDeleteTrackerUI(trackerManager) {
      const deleteBtn = document.getElementById('btn-delete-tracker');
      
      if (!deleteBtn) {
        console.warn('Delete tracker button not found');
        return;
      }

      deleteBtn.addEventListener('click', async () => {
        const currentTracker = trackerManager.getCurrentTracker();
        if (!currentTracker) {
          showAlert('No tracker selected', 'danger');
          return;
        }
        
        // Check if user is owner
        if (!currentTracker.isOwner) {
          showAlert('Only tracker owners can delete trackers', 'warning');
          return;
        }
        
        // Confirm deletion
        const trackerName = currentTracker.name;
        const confirmed = confirm(
          `Are you sure you want to delete "${trackerName}"?\n\n` +
          `This will permanently delete all data in this tracker including:\n` +
          `- People and their savings\n` +
          `- Goals\n` +
          `- Transactions\n` +
          `- Settings\n\n` +
          `This action cannot be undone!`
        );
        
        if (!confirmed) {
          return;
        }
        
        // Store original button state
        const originalText = deleteBtn.textContent;
        const originalDisabled = deleteBtn.disabled;
        
        try {
          deleteBtn.disabled = true;
          deleteBtn.textContent = 'Deleting...';
          
          await trackerManager.deleteTracker(currentTracker.id);
          
          showAlert('Tracker deleted successfully!', 'success');
          
          // Reload page to refresh tracker list and data
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } catch (error) {
          console.error('Error deleting tracker:', error);
          showAlert('Failed to delete tracker: ' + (error.message || 'Unknown error'), 'danger');
        } finally {
          // Always reset button state, even if there was an error
          deleteBtn.disabled = originalDisabled;
          deleteBtn.textContent = originalText;
        }
      });
    }

  </script>

</body>
</html>
